{% extends "base.html" %}

{% block title %}Test Results - StreamSwarm{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-3">
                <i class="fas fa-chart-line me-2"></i>
                Test Results: {{ test.name }}
            </h1>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-{{ 'success' if test.status == 'completed' else 'warning' if test.status == 'running' else 'secondary' }} fs-6">
                    {{ test.status | title }}
                </span>
                <span class="text-muted">Destination: <code>{{ test.destination }}</code></span>
                <span class="text-muted">Duration: {{ test.duration // 60 }}m {{ test.duration % 60 }}s</span>
            </div>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                {% if test.status in ['completed', 'failed'] %}
                    {% if test.test_type not in ['wifi_environment', 'voip_analysis'] %}
                    <a href="{{ url_for('diagnose_test', test_id=test.id) }}" class="btn btn-primary">
                        <i class="fas fa-robot me-1"></i> Get AI Opinion
                    </a>
                    {% endif %}
                    <button class="btn btn-success" onclick="exportPDF({{ test.id }})">
                        <i class="fas fa-file-pdf me-1"></i> Export PDF Report
                    </button>
                {% endif %}
                <a href="{{ url_for('tests') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    Back to Tests
                </a>
            </div>
        </div>
    </div>

    <!-- Test Summary -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Participating Clients</h5>
                    <h2 class="text-info">{{ clients | length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Data Points</h5>
                    <h2 class="text-success" id="data-points">{{ results | length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3" {% if is_wifi_only or is_voip_only %}style="display: none;"{% endif %}>
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Avg Latency</h5>
                    <h2 class="text-warning" id="avg-latency">--</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3" {% if is_wifi_only or is_voip_only %}style="display: none;"{% endif %}>
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Packet Loss</h5>
                    <h2 class="text-danger" id="avg-packet-loss">--</h2>
                </div>
            </div>
        </div>
        <!-- VoIP Analysis Summary Cards -->
        {% if is_voip_only %}
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Avg MOS Score</h5>
                    <h2 class="text-warning" id="avg-mos-score">--</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Voice Quality</h5>
                    <h2 class="text-info" id="avg-voice-quality">--</h2>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Charts -->
    <div class="row mb-4" {% if is_wifi_only or is_voip_only %}style="display: none;"{% endif %}>
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0" id="chart-title">
                            <i class="fas fa-chart-line me-2"></i>
                            Network Latency Over Time
                        </h5>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <span id="current-metric-label">Network Latency</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><h6 class="dropdown-header">Network Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ping_latency')">Network Latency</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ping_packet_loss')">Packet Loss</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('jitter')">Network Jitter</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('dns_resolution_time')">DNS Resolution Time</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('tcp_connect_time')">TCP Connect Time</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ssl_handshake_time')">SSL Handshake Time</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ttfb')">Time to First Byte</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">System Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_load_1min')">CPU Load (1min)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_load_5min')">CPU Load (5min)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_load_15min')">CPU Load (15min)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_freq_current')">CPU Frequency</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_cores')">CPU Cores</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_temperature')">CPU Temperature</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('process_count')">Process Count</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('tcp_connections')">TCP Connections</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Network Interface</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_bytes_sent')">Bytes Sent</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_bytes_recv')">Bytes Received</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_packets_sent')">Packets Sent</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_packets_recv')">Packets Received</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_errors_in')">Network Errors In</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_errors_out')">Network Errors Out</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_drops_in')">Network Drops In</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_drops_out')">Network Drops Out</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Storage Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_read_iops')">Disk Read IOPS</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_write_iops')">Disk Write IOPS</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_read_bytes_sec')">Disk Read Throughput</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_write_bytes_sec')">Disk Write Throughput</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Bandwidth Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('bandwidth_upload')">Upload Speed (Mbps)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('bandwidth_download')">Download Speed (Mbps)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Quality of Service</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('dscp_value')">DSCP Values</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cos_value')">CoS Values</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('qos_policy_compliant')">QoS Policy Compliance</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Memory Details</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('memory_available')">Memory Available</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('memory_cached')">Memory Cached</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('memory_buffers')">Memory Buffers</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('swap_percent')">Swap Usage</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Advanced Network</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('traceroute_hops')">Traceroute Hops</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Pro Tip:</strong> Click on any data point in the chart to see detailed metrics and network path information for troubleshooting.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <div style="position: relative; height: 400px;">
                        <canvas id="networkChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-microchip me-2"></i>
                        CPU Usage
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="cpuChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-memory me-2"></i>
                        Memory Usage
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="memoryChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-hdd me-2"></i>
                        Disk Usage
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="diskChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Details -->
    <div class="row" {% if is_wifi_only or is_voip_only %}style="display: none;"{% endif %}>
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-desktop me-2"></i>
                        Client Performance Summary
                    </h5>
                </div>
                <div class="card-body">
                    {% if clients %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Data Points</th>
                                    <th>Avg Latency</th>
                                    <th>Avg Packet Loss</th>
                                    <th>Avg CPU</th>
                                    <th>Avg Memory</th>
                                    <th>Avg Disk</th>
                                </tr>
                            </thead>
                            <tbody id="clientSummaryTable">
                                {% for client in clients %}
                                <tr>
                                    <td><strong>{{ client.hostname }}</strong></td>
                                    <td class="client-data-points" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-latency" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-packet-loss" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-cpu" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-memory" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-disk" data-client="{{ client.id }}">--</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No client data available for this test.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Network Path Geolocation Visualization -->
    <div class="row mt-4 mb-4" id="geolocationSection" style="display: none;" {% if is_voip_only %}class="d-none"{% endif %}>
        <div class="col-12">
            <div class="card" style="position: relative; z-index: 0;">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-globe-americas me-2"></i>
                        Network Path Geolocation Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-route text-primary fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Total Geographic Distance</h6>
                                    <p class="mb-0 text-muted" id="pathDistance">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-chart-line text-success fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Geographic Efficiency</h6>
                                    <p class="mb-0 text-muted" id="pathEfficiency">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        This map shows the geographic path your network traffic takes to reach the destination. 
                        Each numbered marker represents a network hop with latency-based color coding.
                    </div>
                    
                    <!-- Latency Color Legend -->
                    <div class="card mb-3 bg-dark border-secondary">
                        <div class="card-body py-3">
                            <h6 class="card-title mb-3 text-white">
                                <i class="fas fa-palette me-2"></i>Latency Performance Legend
                            </h6>
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <div style="width: 16px; height: 16px; background-color: #28a745; border-radius: 50%; border: 2px solid #000;"></div>
                                        </div>
                                        <div class="text-white">
                                            <strong class="text-success">Excellent</strong><br>
                                            <small class="text-muted">&lt; 50ms latency</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <div style="width: 16px; height: 16px; background-color: #fd7e14; border-radius: 50%; border: 2px solid #000;"></div>
                                        </div>
                                        <div class="text-white">
                                            <strong class="text-warning">Moderate</strong><br>
                                            <small class="text-muted">50-150ms latency</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <div style="width: 16px; height: 16px; background-color: #dc3545; border-radius: 50%; border: 2px solid #000;"></div>
                                        </div>
                                        <div class="text-white">
                                            <strong class="text-danger">Bottleneck</strong><br>
                                            <small class="text-muted">&gt; 150ms latency</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Hover over any marker to see detailed hop information including exact latency, location, and ISP details.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Process Geolocation Button -->
                    <div class="mb-3" id="geolocationProcessingContainer" style="display: none;">
                        <button type="button" class="btn btn-primary" id="processGeolocationBtn" onclick="processGeolocation()">
                            <i class="fas fa-map-marked-alt me-2"></i>
                            Generate Map from Traceroute Data
                        </button>
                        <small class="text-muted ms-2">
                            No map data available - click to process traceroute results and generate the interactive map
                        </small>
                    </div>
                    <div id="geolocationMap" style="height: 500px; border-radius: 0.375rem; position: relative; z-index: 1; overflow: hidden;">
                        <!-- Interactive map will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GNMI Network Path Analysis -->
    <div class="row mt-4 mb-4" id="gnmiPathSection" style="display: none;" {% if is_wifi_only or is_voip_only %}data-wifi-only="hide"{% endif %}>
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-network-wired me-2"></i>
                        GNMI Managed Infrastructure Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        This analysis shows hop-by-hop performance metrics within your managed network infrastructure using GNMI protocol.
                        Metrics include device processing latency, queue utilization, and interface performance.
                    </div>
                    
                    <!-- GNMI Path Summary -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-router text-primary fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Managed Devices</h6>
                                    <p class="mb-0 text-muted" id="gnmiManagedDevices">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-clock text-success fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Total Processing Latency</h6>
                                    <p class="mb-0 text-muted" id="gnmiTotalLatency">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-warning fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Detected Issues</h6>
                                    <p class="mb-0 text-muted" id="gnmiIssueCount">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Device Performance Table -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Device</th>
                                    <th>Type</th>
                                    <th>Processing Latency</th>
                                    <th>Queue Latency</th>
                                    <th>CPU Usage</th>
                                    <th>Interface Utilization</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="gnmiDeviceTable">
                                <!-- Device data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Insights -->
                    <div class="mt-3">
                        <h6 class="text-primary">
                            <i class="fas fa-lightbulb me-2"></i>Infrastructure Insights
                        </h6>
                        <div id="gnmiInsights" class="list-group list-group-flush">
                            <!-- Insights will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Client Infrastructure Analysis -->
    <div class="row mt-4 mb-4" id="clientInfrastructureSection" style="display: none;" {% if is_wifi_only or is_voip_only %}data-wifi-only="hide"{% endif %}>
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-desktop me-2"></i>
                        Client Infrastructure Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        This analysis correlates client system metrics (CPU, memory, network interfaces) with network performance to identify client-side bottlenecks and optimization opportunities.
                    </div>
                    
                    <!-- Infrastructure Summary -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-chart-line text-primary fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Correlation Score</h6>
                                    <p class="mb-0 text-muted" id="infraCorrelationScore">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-warning fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Risk Level</h6>
                                    <p class="mb-0 text-muted" id="infraRiskLevel">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-lightbulb text-success fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">Recommendations</h6>
                                    <p class="mb-0 text-muted" id="infraRecommendationCount">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key Correlations -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-link me-2"></i>Key System Correlations
                            </h6>
                            <div id="infraCorrelations" class="row">
                                <!-- Correlation cards will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Improvement Recommendations -->
                    <div class="mt-3">
                        <h6 class="text-primary">
                            <i class="fas fa-tools me-2"></i>Client-Side Improvement Recommendations
                        </h6>
                        <div id="infraRecommendations" class="list-group list-group-flush">
                            <!-- Recommendations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- WiFi Environmental Analysis -->
    <div class="row mt-4" id="wifiEnvironmentCard" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-wifi me-2"></i>
                        WiFi Environmental Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Environment Overview -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge me-2" id="wifiQualityBadge">Good</span>
                                <h6 class="mb-0">Environment Quality</h6>
                            </div>
                            <p class="text-muted small mb-3" id="wifiQualityDescription">
                                WiFi environment assessment based on pollution score
                            </p>
                            
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="h4 mb-1" id="wifiNetworkCount">0</div>
                                        <small class="text-muted">Networks Detected</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="h4 mb-1" id="wifiPollutionScore">0</div>
                                        <small class="text-muted">Pollution Score</small>
                                        <div class="mt-1">
                                            <span class="badge" id="wifiPollutionBadge">Unknown</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pollution Score Legend -->
                            <div class="mt-3 p-2 bg-dark border rounded">
                                <div class="small text-center">
                                    <strong class="text-light">Pollution Score Guide:</strong>
                                </div>
                                <div class="d-flex justify-content-between mt-2 small">
                                    <span class="badge bg-success">0-25: Excellent</span>
                                    <span class="badge bg-primary">26-50: Good</span>
                                    <span class="badge bg-warning">51-75: Fair</span>
                                    <span class="badge bg-danger">76-100: Poor</span>
                                </div>
                                <div class="text-center mt-1">
                                    <small class="text-light">Higher scores indicate more RF interference and network congestion</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-signal me-2"></i>Signal Quality Distribution
                            </h6>
                            <div class="row g-2">
                                <div class="col-4">
                                    <div class="text-center p-2 border rounded">
                                        <div class="text-success fw-bold" id="wifiStrongSignals">0</div>
                                        <small class="text-muted">Strong</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-center p-2 border rounded">
                                        <div class="text-warning fw-bold" id="wifiWeakSignals">0</div>
                                        <small class="text-muted">Weak</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="text-center p-2 border rounded">
                                        <div class="text-info fw-bold" id="wifiAvgSignal">0</div>
                                        <small class="text-muted">Avg dBm</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Channel Analysis -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-chart-bar me-2"></i>Channel Distribution
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="text-center p-2 border rounded">
                                        <div class="text-primary fw-bold" id="wifi24GhzCount">0</div>
                                        <small class="text-muted">2.4 GHz</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2 border rounded">
                                        <div class="text-success fw-bold" id="wifi5GhzCount">0</div>
                                        <small class="text-muted">5 GHz</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>Channel Congestion
                            </h6>
                            <div class="bg-dark border border-secondary rounded p-3 mb-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-light">Most Congested Channel:</span>
                                    <span class="badge bg-warning" id="wifiCongestedChannel">N/A</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="text-light">Networks on Channel:</span>
                                    <span class="fw-bold text-light" id="wifiCongestionCount">0</span>
                                </div>
                                <div class="mt-2 small text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Shows the channel with the highest number of competing networks
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced RF Analysis -->
                    <div class="row mb-4" id="advancedRFSection" style="display: none;">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-broadcast-tower me-2"></i>Advanced RF Analysis
                            </h6>
                            <div class="row g-3">
                                <!-- Noise Floor -->
                                <div class="col-md-3">
                                    <div class="card bg-dark text-white">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Noise Floor</h6>
                                            <h5 class="mb-1" id="rfNoiseFloor">-95 dBm</h5>
                                            <small class="text-muted" id="rfNoiseMethod">Estimated</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Average SNR -->
                                <div class="col-md-3">
                                    <div class="card bg-dark text-white">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Average SNR</h6>
                                            <h5 class="mb-1" id="rfAvgSNR">0 dB</h5>
                                            <small class="text-muted" id="rfPoorSNR">0 poor connections</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Interference Level -->
                                <div class="col-md-3">
                                    <div class="card bg-dark text-white">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">Interference</h6>
                                            <h5 class="mb-1" id="rfInterferenceLevel">Minimal</h5>
                                            <small class="text-muted" id="rfInterferenceScore">0 sources</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- RF Quality Score -->
                                <div class="col-md-3">
                                    <div class="card bg-dark text-white">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">RF Quality</h6>
                                            <h5 class="mb-1" id="rfQualityScore">100</h5>
                                            <small class="text-muted">Score (0-100)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Channel Utilization -->
                            <div class="mt-3">
                                <h6 class="text-primary mb-2">Channel Utilization Analysis</h6>
                                <div class="row" id="channelUtilizationCards">
                                    <div class="col-12 text-center text-muted">
                                        <small>No channel utilization data available</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Interference Sources -->
                            <div class="mt-3">
                                <h6 class="text-primary mb-2">Interference Source Classification</h6>
                                <div class="row" id="interferenceSourceCards">
                                    <div class="col-3">
                                        <div class="text-center p-2 border rounded">
                                            <div class="fw-bold" id="wifiCongestionInterference">0</div>
                                            <small class="text-muted">
                                                <a href="#" class="text-decoration-none text-muted interference-link" onclick="showInterferenceDetails('wifi'); return false;" 
                                                   style="cursor: pointer; border-bottom: 1px dotted #6c757d;" 
                                                   onmouseover="this.style.color='#0d6efd'; this.style.borderBottom='1px dotted #0d6efd';" 
                                                   onmouseout="this.style.color='#6c757d'; this.style.borderBottom='1px dotted #6c757d';">
                                                    WiFi Congestion
                                                </a>
                                            </small>
                                            <div class="mt-1">
                                                <span class="badge" id="wifiCongestionBadge">Good</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 border rounded">
                                            <div class="fw-bold" id="bluetoothInterference">0</div>
                                            <small class="text-muted">
                                                <a href="#" class="text-decoration-none text-muted interference-link" onclick="showInterferenceDetails('bluetooth'); return false;" 
                                                   style="cursor: pointer; border-bottom: 1px dotted #6c757d;" 
                                                   onmouseover="this.style.color='#0d6efd'; this.style.borderBottom='1px dotted #0d6efd';" 
                                                   onmouseout="this.style.color='#6c757d'; this.style.borderBottom='1px dotted #6c757d';">
                                                    Bluetooth
                                                </a>
                                            </small>
                                            <div class="mt-1">
                                                <span class="badge" id="bluetoothBadge">Good</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 border rounded">
                                            <div class="fw-bold" id="microwaveInterference">0</div>
                                            <small class="text-muted">
                                                <a href="#" class="text-decoration-none text-muted interference-link" onclick="showInterferenceDetails('microwave'); return false;" 
                                                   style="cursor: pointer; border-bottom: 1px dotted #6c757d;" 
                                                   onmouseover="this.style.color='#0d6efd'; this.style.borderBottom='1px dotted #0d6efd';" 
                                                   onmouseout="this.style.color='#6c757d'; this.style.borderBottom='1px dotted #6c757d';">
                                                    Microwave
                                                </a>
                                            </small>
                                            <div class="mt-1">
                                                <span class="badge" id="microwaveBadge">Good</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 border rounded">
                                            <div class="fw-bold" id="otherRFInterference">0</div>
                                            <small class="text-muted">
                                                <a href="#" class="text-decoration-none text-muted interference-link" onclick="showInterferenceDetails('other_rf'); return false;" 
                                                   style="cursor: pointer; border-bottom: 1px dotted #6c757d;" 
                                                   onmouseover="this.style.color='#0d6efd'; this.style.borderBottom='1px dotted #0d6efd';" 
                                                   onmouseout="this.style.color='#6c757d'; this.style.borderBottom='1px dotted #6c757d';">
                                                    Other RF
                                                </a>
                                            </small>
                                            <div class="mt-1">
                                                <span class="badge" id="otherRFBadge">Good</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Interference Level Explanation -->
                                <div class="mt-3">
                                    <div class="bg-dark border border-secondary rounded p-3">
                                        <h6 class="text-info mb-3">
                                            <i class="fas fa-info-circle me-2"></i>Interference Level Guide
                                        </h6>
                                        <div class="row text-sm">
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <strong class="text-light">WiFi Congestion:</strong> <span class="text-muted">Number of competing networks</span>
                                                    <br><span class="badge bg-success me-1">Good</span> 0-2 networks
                                                    <span class="badge bg-warning me-1">Moderate</span> 3-5 networks
                                                    <span class="badge bg-danger">High</span> 6+ networks
                                                </div>
                                                <div class="mb-2">
                                                    <strong class="text-light">Bluetooth:</strong> <span class="text-muted">Detected Bluetooth interference</span>
                                                    <br><span class="badge bg-success me-1">Good</span> 0-1 devices
                                                    <span class="badge bg-warning me-1">Moderate</span> 2-3 devices
                                                    <span class="badge bg-danger">High</span> 4+ devices
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <strong class="text-light">Microwave:</strong> <span class="text-muted">Microwave oven interference</span>
                                                    <br><span class="badge bg-success me-1">Good</span> 0 detected
                                                    <span class="badge bg-warning me-1">Moderate</span> 1 detected
                                                    <span class="badge bg-danger">High</span> 2+ detected
                                                </div>
                                                <div class="mb-2">
                                                    <strong class="text-light">Other RF:</strong> <span class="text-muted">Unidentified RF interference</span>
                                                    <br><span class="badge bg-success me-1">Good</span> 0-1 sources
                                                    <span class="badge bg-warning me-1">Moderate</span> 2-3 sources
                                                    <span class="badge bg-danger">High</span> 4+ sources
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detected Networks (Top 10) -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">
                                <i class="fas fa-list me-2"></i>Detected Networks (Top 10 by Signal Strength)
                            </h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="showAllNetworks()">
                                <i class="fas fa-expand me-1"></i>Show All (<span id="totalNetworksCount">0</span>)
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>SSID</th>
                                        <th>Channel</th>
                                        <th>Signal (dBm)</th>
                                        <th>Frequency</th>
                                        <th>Security</th>
                                    </tr>
                                </thead>
                                <tbody id="wifiNetworksTable">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No WiFi scan data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- VoIP Analysis -->
    <div class="row mt-4" id="voipAnalysisCard" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-phone me-2"></i>
                        VoIP Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <!-- VoIP Overview -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge me-2" id="voipQualityBadge">Good</span>
                                <h6 class="mb-0">Voice Quality Assessment</h6>
                            </div>
                            <p class="text-muted small mb-3" id="voipQualityDescription">
                                VoIP call quality based on MOS score and network metrics
                            </p>
                            
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="h4 mb-1" id="voipMOSScore">0.0</div>
                                        <small class="text-muted">MOS Score</small>
                                        <div class="mt-1">
                                            <span class="badge" id="voipMOSBadge">Poor</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="h4 mb-1" id="voipVoiceQuality">0</div>
                                        <small class="text-muted">Voice Quality %</small>
                                        <div class="mt-1">
                                            <span class="badge" id="voipVoiceQualityBadge">Poor</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- MOS Score Legend -->
                            <div class="mt-3 p-2 bg-dark border rounded">
                                <div class="small text-center">
                                    <strong class="text-light">MOS Score Guide:</strong>
                                </div>
                                <div class="d-flex justify-content-between mt-2 small">
                                    <span class="badge bg-success">4.0-5.0: Excellent</span>
                                    <span class="badge bg-primary">3.0-4.0: Good</span>
                                    <span class="badge bg-warning">2.0-3.0: Fair</span>
                                    <span class="badge bg-danger">1.0-2.0: Poor</span>
                                </div>
                                <div class="text-center mt-1">
                                    <small class="text-light">MOS (Mean Opinion Score) represents perceived voice quality</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-clock me-2"></i>SIP Protocol Timing
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="text-center p-2 border rounded">
                                        <div class="text-primary fw-bold" id="voipSIPRegistration">0ms</div>
                                        <small class="text-muted">SIP Registration</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2 border rounded">
                                        <div class="text-info fw-bold" id="voipSIPCallSetup">0ms</div>
                                        <small class="text-muted">Call Setup</small>
                                    </div>
                                </div>
                            </div>
                            
                            <h6 class="text-primary mb-3 mt-4">
                                <i class="fas fa-stream me-2"></i>RTP Stream Quality
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="text-center p-2 border rounded">
                                        <div class="text-warning fw-bold" id="voipRTPJitter">0ms</div>
                                        <small class="text-muted">Jitter</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2 border rounded">
                                        <div class="text-danger fw-bold" id="voipRTPPacketLoss">0%</div>
                                        <small class="text-muted">Packet Loss</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VoIP Quality Thresholds -->
                    <div class="mt-3">
                        <div class="bg-dark border border-secondary rounded p-3">
                            <h6 class="text-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>VoIP Quality Thresholds
                            </h6>
                            <div class="row text-sm">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <strong class="text-light">Latency:</strong> <span class="text-muted">One-way delay acceptable for voice</span>
                                        <br><span class="badge bg-success me-1">Excellent</span> &lt;50ms
                                        <span class="badge bg-primary me-1">Good</span> 50-100ms
                                        <span class="badge bg-warning me-1">Fair</span> 100-150ms
                                        <span class="badge bg-danger">Poor</span> &gt;150ms
                                    </div>
                                    <div class="mb-2">
                                        <strong class="text-light">Jitter:</strong> <span class="text-muted">Variation in packet delay</span>
                                        <br><span class="badge bg-success me-1">Excellent</span> &lt;20ms
                                        <span class="badge bg-primary me-1">Good</span> 20-40ms
                                        <span class="badge bg-warning me-1">Fair</span> 40-60ms
                                        <span class="badge bg-danger">Poor</span> &gt;60ms
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <strong class="text-light">Packet Loss:</strong> <span class="text-muted">Percentage of lost voice packets</span>
                                        <br><span class="badge bg-success me-1">Excellent</span> &lt;0.5%
                                        <span class="badge bg-primary me-1">Good</span> 0.5-1%
                                        <span class="badge bg-warning me-1">Fair</span> 1-2%
                                        <span class="badge bg-danger">Poor</span> &gt;2%
                                    </div>
                                    <div class="mb-2">
                                        <strong class="text-light">MOS Score:</strong> <span class="text-muted">Mean Opinion Score for voice quality</span>
                                        <br><span class="badge bg-success me-1">Excellent</span> 4.0-5.0
                                        <span class="badge bg-primary me-1">Good</span> 3.0-4.0
                                        <span class="badge bg-warning me-1">Fair</span> 2.0-3.0
                                        <span class="badge bg-danger">Poor</span> 1.0-2.0
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VoIP Test Results Summary -->
                    <div class="mt-3">
                        <h6 class="text-primary">
                            <i class="fas fa-chart-bar me-2"></i>Test Results Summary
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Value</th>
                                        <th>Status</th>
                                        <th>Impact</th>
                                    </tr>
                                </thead>
                                <tbody id="voipMetricsTable">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">No VoIP analysis data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- All Networks Modal -->
    <div class="modal fade" id="allNetworksModal" tabindex="-1" aria-labelledby="allNetworksModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allNetworksModalLabel">
                        <i class="fas fa-wifi me-2"></i>All Detected Networks
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>SSID</th>
                                    <th>Channel</th>
                                    <th>Signal (dBm)</th>
                                    <th>Frequency</th>
                                    <th>Security</th>
                                </tr>
                            </thead>
                            <tbody id="allNetworksTable">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">Loading networks...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <small class="text-muted me-auto">
                        Showing <span id="modalNetworkCount">0</span> networks
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Channel Networks Modal -->
    <div class="modal fade" id="channelNetworksModal" tabindex="-1" aria-labelledby="channelNetworksModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="channelNetworksModalLabel">
                        <i class="fas fa-wifi me-2"></i>Networks on Channel <span id="channelNumber">0</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>SSID</th>
                                    <th>Signal (dBm)</th>
                                    <th>Frequency</th>
                                    <th>Security</th>
                                </tr>
                            </thead>
                            <tbody id="channelNetworksTable">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Loading networks...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <small class="text-muted me-auto">
                        Showing <span id="channelModalNetworkCount">0</span> networks on this channel
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Interference Details Modal -->
    <div class="modal fade" id="interferenceDetailsModal" tabindex="-1" aria-labelledby="interferenceDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="interferenceDetailsModalLabel">
                        <i class="fas fa-broadcast-tower me-2"></i><span id="interferenceTypeTitle">Interference Details</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="interferenceDetailsContent">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>Loading interference details...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <small class="text-muted me-auto">
                        <span id="interferenceDetailsCount">Analysis based on detected RF patterns</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Process Monitoring -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        Process Monitoring Details
                    </h5>
                </div>
                <div class="card-body">
                    {% set process_result = results|selectattr('top_processes_cpu')|first %}
                    {% if process_result %}
                        {% set cpu_processes = process_result.top_processes_cpu | tojsonfilter %}
                        {% set mem_processes = process_result.top_processes_memory | tojsonfilter %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-microchip me-2"></i>Top Processes by CPU Usage
                                </h6>
                                {% for process in cpu_processes[:5] %}
                                    <div class="card mb-2">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ process.name }}</strong>
                                                    <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-primary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                    <span class="badge bg-secondary">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-memory me-2"></i>Top Processes by Memory Usage
                                </h6>
                                {% for process in mem_processes[:5] %}
                                    <div class="card mb-2">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ process.name }}</strong>
                                                    <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-success">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                    <span class="badge bg-secondary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No detailed process monitoring data available for this test.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Network Interface Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-network-wired me-2"></i>
                        Network Interface Details by Client
                    </h5>
                </div>
                <div class="card-body">
                    {% set interface_clients = results|selectattr('network_interface_info')|groupby('client_id')|list %}
                    {% if interface_clients %}
                        {% for client_id, client_results in interface_clients %}
                            {% set client = clients|selectattr('id', 'equalto', client_id)|first %}
                            {% set interface_data = client_results[0].network_interface_info | tojsonfilter %}
                            {% if interface_data and interface_data.primary_interface %}
                                <div class="card mb-3 bg-dark border-secondary">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-desktop me-2"></i>
                                            {{ client.hostname if client else 'Unknown Client' }}
                                            <small class="text-light opacity-75">({{ client.ip_address if client else 'Unknown IP' }})</small>
                                        </h6>
                                    </div>
                                    <div class="card-body bg-dark text-white">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="text-info mb-3">Primary Interface</h6>
                                                <div class="mb-2">
                                                    <strong>Interface:</strong> 
                                                    <span class="badge bg-secondary">{{ interface_data.primary_interface }}</span>
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Type:</strong>
                                                    {% if interface_data.is_wireless %}
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-wifi me-1"></i>Wireless (Primary)
                                                        </span>
                                                    {% elif interface_data.has_secondary_wireless and interface_data.interface_type == 'ethernet' %}
                                                        <span class="badge bg-success me-1">
                                                            <i class="fas fa-ethernet me-1"></i>Ethernet (Primary)
                                                        </span>
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-wifi me-1"></i>Wireless (Secondary)
                                                        </span>
                                                    {% elif interface_data.interface_type == 'ethernet' %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-ethernet me-1"></i>Ethernet
                                                        </span>
                                                    {% elif interface_data.interface_type == 'vpn' %}
                                                        <span class="badge bg-warning">
                                                            <i class="fas fa-shield-alt me-1"></i>VPN
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ interface_data.interface_type|title }}</span>
                                                    {% endif %}
                                                </div>
                                                {% if interface_data.connection_speed %}
                                                    <div class="mb-2">
                                                        <strong>Speed:</strong> {{ interface_data.connection_speed }} Mbps
                                                    </div>
                                                {% endif %}
                                                {% if interface_data.duplex_mode and interface_data.duplex_mode != 'unknown' %}
                                                    <div class="mb-2">
                                                        <strong>Duplex:</strong> {{ interface_data.duplex_mode|title }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            {% if interface_data.is_wireless or interface_data.has_secondary_wireless %}
                                                <div class="col-md-6">
                                                    <h6 class="text-info mb-3">
                                                        {% if interface_data.is_wireless %}
                                                            Wireless Details (Primary Interface)
                                                        {% else %}
                                                            Wireless Details (Secondary Interface: {{ interface_data.wireless_interface_name }})
                                                        {% endif %}
                                                    </h6>
                                                    {% if interface_data.wireless_info and (interface_data.wireless_info.ssid or interface_data.wireless_info.signal_strength or interface_data.wireless_info.frequency) %}
                                                        {% if interface_data.wireless_info.ssid %}
                                                            <div class="mb-2">
                                                                <strong>Network (SSID):</strong> {{ interface_data.wireless_info.ssid }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.signal_strength %}
                                                            <div class="mb-2">
                                                                <strong>Signal Strength:</strong> {{ interface_data.wireless_info.signal_strength }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.frequency %}
                                                            <div class="mb-2">
                                                                <strong>Frequency:</strong> {{ interface_data.wireless_info.frequency }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.channel %}
                                                            <div class="mb-2">
                                                                <strong>Channel:</strong> {{ interface_data.wireless_info.channel }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.mac_address %}
                                                            <div class="mb-2">
                                                                <strong>MAC Address:</strong> {{ interface_data.wireless_info.mac_address }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.txpower %}
                                                            <div class="mb-2">
                                                                <strong>TX Power:</strong> {{ interface_data.wireless_info.txpower }}
                                                            </div>
                                                        {% endif %}
                                                        {% if interface_data.wireless_info.security %}
                                                            <div class="mb-2">
                                                                <strong>Security:</strong> {{ interface_data.wireless_info.security }}
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <!-- Signal strength monitoring statistics for this client -->
                                                        {% set client_signal_result = client_results|selectattr('signal_strength_min')|selectattr('signal_strength_max')|selectattr('signal_strength_avg')|selectattr('signal_strength_samples')|selectattr('signal_strength_samples', 'greaterthan', 0)|sort(attribute='signal_strength_samples', reverse=true)|first %}
                                                        {% if client_signal_result %}
                                                            <hr class="border-secondary my-3">
                                                            <h6 class="text-info mb-2">
                                                                <i class="fas fa-signal me-2"></i>
                                                                Signal Strength During Test
                                                            </h6>
                                                            <div class="row text-center">
                                                                <div class="col-4">
                                                                    <div class="bg-danger bg-opacity-25 border border-danger rounded p-2">
                                                                        <small class="text-danger">Min</small><br>
                                                                        <strong class="text-white">{{ "%.1f"|format(client_signal_result.signal_strength_min) }} dBm</strong>
                                                                    </div>
                                                                </div>
                                                                <div class="col-4">
                                                                    <div class="bg-warning bg-opacity-25 border border-warning rounded p-2">
                                                                        <small class="text-warning">Avg</small><br>
                                                                        <strong class="text-white">{{ "%.1f"|format(client_signal_result.signal_strength_avg) }} dBm</strong>
                                                                    </div>
                                                                </div>
                                                                <div class="col-4">
                                                                    <div class="bg-success bg-opacity-25 border border-success rounded p-2">
                                                                        <small class="text-success">Max</small><br>
                                                                        <strong class="text-white">{{ "%.1f"|format(client_signal_result.signal_strength_max) }} dBm</strong>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <small class="text-muted mt-2 d-block">
                                                                Based on {{ client_signal_result.signal_strength_samples }} measurements throughout test duration
                                                            </small>
                                                            
                                                            <!-- Signal strength interpretation -->
                                                            {% if client_signal_result.signal_strength_avg >= -30 %}
                                                                <div class="alert alert-success mt-2 py-2">
                                                                    <small><i class="fas fa-check-circle me-1"></i> Excellent signal strength</small>
                                                                </div>
                                                            {% elif client_signal_result.signal_strength_avg >= -50 %}
                                                                <div class="alert alert-info mt-2 py-2">
                                                                    <small><i class="fas fa-info-circle me-1"></i> Good signal strength</small>
                                                                </div>
                                                            {% elif client_signal_result.signal_strength_avg >= -70 %}
                                                                <div class="alert alert-warning mt-2 py-2">
                                                                    <small><i class="fas fa-exclamation-triangle me-1"></i> Fair signal strength</small>
                                                                </div>
                                                            {% else %}
                                                                <div class="alert alert-danger mt-2 py-2">
                                                                    <small><i class="fas fa-times-circle me-1"></i> Poor signal strength</small>
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                    {% else %}
                                                        <div class="alert alert-info">
                                                            <i class="fas fa-info-circle me-2"></i>
                                                            Wireless interface detected but detailed information requires the 'iw' package (install with: sudo apt install iw) that may not be available in this environment.
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% elif not interface_data.is_wireless %}
                                                <div class="col-md-6">
                                                    <h6 class="text-success mb-3">Connection Details</h6>
                                                    <div class="alert alert-success">
                                                        <i class="fas fa-check-circle me-2"></i>
                                                        Wired connection provides stable, low-latency networking
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="col-md-6">
                                                    <h6 class="text-warning mb-3">Wireless Details</h6>
                                                    <div class="alert alert-warning">
                                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                                        Wireless interface detected but detailed information not available
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        {% if interface_data.all_interfaces|length > 1 %}
                                            <hr class="border-secondary">
                                            <h6 class="text-light mb-3">All Network Interfaces</h6>
                                            <div class="row">
                                                {% for interface in interface_data.all_interfaces %}
                                                    <div class="col-md-6 mb-2">
                                                        <div class="bg-secondary border border-secondary rounded p-2">
                                                            <div class="d-flex justify-content-between align-items-center text-white">
                                                                <div>
                                                                    <strong>{{ interface.name }}</strong>
                                                                    {% if interface.is_up %}
                                                                        <span class="badge bg-success ms-1">UP</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger ms-1">DOWN</span>
                                                                    {% endif %}
                                                                </div>
                                                                {% if interface.speed %}
                                                                    <small class="text-light opacity-75">{{ interface.speed }} Mbps</small>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No network interface data available for this test.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comprehensive Metrics Analysis -->
    {% if results and results|length > 0 and not is_wifi_only %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Comprehensive Metrics Analysis (65+ Metrics)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h6>Network Performance</h6>
                                    {% set avg_latency = results | extract_numeric('ping_latency') %}
                                    <p class="mb-1">Latency: {{ "%.1f"|format(avg_latency | average) if avg_latency else 'N/A' }}ms</p>
                                    {% set avg_bandwidth = results | extract_numeric('bandwidth_download') %}
                                    <p class="mb-0">Bandwidth: {{ "%.1f"|format(avg_bandwidth | average) if avg_bandwidth else 'N/A' }} Mbps</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h6>System Resources</h6>
                                    {% set avg_cpu = results | extract_numeric('cpu_percent') %}
                                    <p class="mb-1">CPU: {{ "%.1f"|format(avg_cpu | average) if avg_cpu else 'N/A' }}%</p>
                                    {% set avg_memory = results | extract_numeric('memory_percent') %}
                                    <p class="mb-0">Memory: {{ "%.1f"|format(avg_memory | average) if avg_memory else 'N/A' }}%</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h6>Quality of Service</h6>
                                    {% set dscp_vals = results | extract_numeric('dscp_value') %}
                                    <p class="mb-1">DSCP: {{ dscp_vals | first if dscp_vals else 'N/A' }}</p>
                                    {% set ecn_capable = results | selectattr('ecn_capable', 'equalto', true) | list %}
                                    <p class="mb-0">ECN: {{ 'Yes' if ecn_capable else 'No' }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h6>Infrastructure</h6>
                                    {% set power_vals = results | extract_numeric('power_consumption_watts') %}
                                    <p class="mb-1">Power: {{ "%.1f"|format(power_vals | average) if power_vals else 'N/A' }}W</p>
                                    {% set smart_health = results | selectattr('smart_drive_health') | list %}
                                    <p class="mb-0">Drives: {{ 'Healthy' if smart_health else 'N/A' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Metrics Tables -->
                    <div class="row">
                        <div class="col-12">
                            <div class="accordion" id="metricsAccordion">
                                <!-- Network Metrics -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#networkMetrics">
                                            <i class="fas fa-network-wired me-2"></i>Network Performance Metrics
                                        </button>
                                    </h2>
                                    <div id="networkMetrics" class="accordion-collapse collapse show" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr><th>Metric</th><th>Average</th><th>Status</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Ping Latency (ms)</td>
                                                            {% set avg_latency = results | extract_numeric('ping_latency') %}
                                                            <td>{{ "%.2f"|format(avg_latency | average) if avg_latency else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_latency and (avg_latency | average) < 50 %}
                                                                    <span class="badge bg-success">Excellent</span>
                                                                {% elif avg_latency and (avg_latency | average) < 100 %}
                                                                    <span class="badge bg-warning">Good</span>
                                                                {% elif avg_latency %}
                                                                    <span class="badge bg-danger">Poor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">No Data</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>DNS Resolution (ms)</td>
                                                            {% set avg_dns = results | extract_numeric('dns_resolution_time') %}
                                                            <td>{{ "%.2f"|format(avg_dns | average) if avg_dns else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_dns and (avg_dns | average) < 50 %}
                                                                    <span class="badge bg-success">Excellent</span>
                                                                {% elif avg_dns %}
                                                                    <span class="badge bg-warning">Good</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Bandwidth Download (Mbps)</td>
                                                            {% set avg_down = results | extract_numeric('bandwidth_download') %}
                                                            <td>{{ "%.2f"|format(avg_down | average) if avg_down else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_down and (avg_down | average) > 50 %}
                                                                    <span class="badge bg-success">Excellent</span>
                                                                {% elif avg_down and (avg_down | average) > 10 %}
                                                                    <span class="badge bg-warning">Good</span>
                                                                {% elif avg_down %}
                                                                    <span class="badge bg-danger">Poor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>MTU Size</td>
                                                            {% set mtu_values = [] %}
                                                            {% for result in results %}
                                                                {% if result.network_interface_info %}
                                                                    {% set interface_data = result.network_interface_info | from_json %}
                                                                    {% if interface_data.get('all_interfaces') %}
                                                                        {% for interface in interface_data.all_interfaces %}
                                                                            {% if interface.get('mtu') and interface.get('is_up') %}
                                                                                {% set _ = mtu_values.append(interface.mtu) %}
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endfor %}
                                                            {% if mtu_values %}
                                                                {% set avg_mtu = (mtu_values | sum / mtu_values | length) | round(0) | int %}
                                                                <td>{{ avg_mtu }} bytes</td>
                                                                <td>
                                                                    {% if avg_mtu == 1500 %}
                                                                        <span class="badge bg-success">Standard</span>
                                                                    {% elif avg_mtu > 1500 %}
                                                                        <span class="badge bg-info">Jumbo</span>
                                                                    {% else %}
                                                                        <span class="badge bg-warning">Small</span>
                                                                    {% endif %}
                                                                </td>
                                                            {% else %}
                                                                <td>N/A</td>
                                                                <td><span class="badge bg-secondary">N/A</span></td>
                                                            {% endif %}
                                                        </tr>
                                                        <tr>
                                                            <td>TCP Retransmission Rate (%)</td>
                                                            {% set avg_retrans = results | extract_numeric('tcp_retransmission_rate') %}
                                                            <td>{{ "%.3f"|format(avg_retrans | average) if avg_retrans else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_retrans and (avg_retrans | average) < 1 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_retrans %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Network Packets Sent</td>
                                                            {% set avg_packets_sent = results | extract_numeric('network_packets_sent') %}
                                                            <td>{{ "{:,}".format(avg_packets_sent | average | round(0) | int) if avg_packets_sent else 'N/A' }}</td>
                                                            <td><span class="badge bg-info">Info</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Network Packets Received</td>
                                                            {% set avg_packets_recv = results | extract_numeric('network_packets_recv') %}
                                                            <td>{{ "{:,}".format(avg_packets_recv | average | round(0) | int) if avg_packets_recv else 'N/A' }}</td>
                                                            <td><span class="badge bg-info">Info</span></td>
                                                        </tr>

                                                        <tr>
                                                            <td>
                                                                Network Errors In
                                                                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                   title="Hardware/driver-level errors while receiving packets (checksum failures, malformed packets, interface issues). Zero errors indicates healthy network hardware."></i>
                                                            </td>
                                                            {% set avg_errors_in = results | extract_numeric('network_errors_in') %}
                                                            <td>{{ "{:,}".format(avg_errors_in | average | round(0) | int) if avg_errors_in else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_errors_in and (avg_errors_in | average) == 0 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_errors_in and (avg_errors_in | average) < 10 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_errors_in %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                Network Errors Out
                                                                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                   title="Hardware/driver-level errors while sending packets. Zero errors indicates healthy network hardware and proper packet transmission."></i>
                                                            </td>
                                                            {% set avg_errors_out = results | extract_numeric('network_errors_out') %}
                                                            <td>{{ "{:,}".format(avg_errors_out | average | round(0) | int) if avg_errors_out else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_errors_out and (avg_errors_out | average) == 0 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_errors_out and (avg_errors_out | average) < 10 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_errors_out %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                Network Drops In
                                                                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                   title="Incoming packets dropped due to buffer overflows, network congestion, firewalls, or traffic shaping. Normal during high traffic or with security filtering."></i>
                                                            </td>
                                                            {% set avg_drops_in = results | extract_numeric('network_drops_in') %}
                                                            <td>{{ "{:,}".format(avg_drops_in | average | round(0) | int) if avg_drops_in else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_drops_in and (avg_drops_in | average) == 0 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_drops_in and (avg_drops_in | average) < 5000 %}
                                                                    <span class="badge bg-info">Normal</span>
                                                                {% elif avg_drops_in and (avg_drops_in | average) < 20000 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_drops_in %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                Network Drops Out
                                                                <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                   title="Outgoing packets dropped due to buffer overflows or traffic shaping. Often zero on most systems (always 0 on macOS/BSD)."></i>
                                                            </td>
                                                            {% set avg_drops_out = results | extract_numeric('network_drops_out') %}
                                                            <td>{{ "{:,}".format(avg_drops_out | average | round(0) | int) if avg_drops_out else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_drops_out and (avg_drops_out | average) == 0 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_drops_out and (avg_drops_out | average) < 5 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_drops_out %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                                
                                                <!-- Network Metrics Explanation -->
                                                <div class="alert alert-info mt-3">
                                                    <h6><i class="fas fa-info-circle me-2"></i>Understanding Network Metrics</h6>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <strong>Network Errors:</strong>
                                                            <ul class="mb-2">
                                                                <li>Hardware/driver-level issues</li>
                                                                <li>Corrupted or malformed packets</li>
                                                                <li>Interface hardware problems</li>
                                                                <li>Zero errors = healthy hardware</li>
                                                            </ul>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <strong>Network Drops:</strong>
                                                            <ul class="mb-2">
                                                                <li>Buffer overflows during traffic spikes</li>
                                                                <li>Firewall/security filtering</li>
                                                                <li>Network congestion management</li>
                                                                <li>QoS/traffic shaping policies</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    <small class="text-dark">
                                                        <strong>Common Pattern:</strong> High drops with zero errors typically indicates normal network traffic management rather than hardware issues.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- TCP Window Analysis -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tcpWindowAnalysis">
                                            <i class="fas fa-project-diagram me-2"></i>TCP Window Analysis (Bottleneck Attribution)
                                        </button>
                                    </h2>
                                    <div id="tcpWindowAnalysis" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            {% set tcp_results = results | selectattr('tcp_window_efficiency') | list %}
                                            {% if tcp_results %}
                                                <!-- TCP Window Efficiency Score -->
                                                <div class="row mb-4">
                                                    <div class="col-md-6">
                                                        <div class="card bg-primary text-white">
                                                            <div class="card-body text-center">
                                                                {% set avg_efficiency = tcp_results | extract_numeric('tcp_window_efficiency') %}
                                                                <h4 class="mb-2">{{ "%.1f"|format(avg_efficiency | average) if avg_efficiency else 'N/A' }}%</h4>
                                                                <p class="mb-0">TCP Window Efficiency</p>
                                                                {% if avg_efficiency %}
                                                                    {% set eff_score = avg_efficiency | average %}
                                                                    {% if eff_score >= 90 %}
                                                                        <small class="text-light">Excellent Performance</small>
                                                                    {% elif eff_score >= 70 %}
                                                                        <small class="text-light">Good Performance</small>
                                                                    {% elif eff_score >= 50 %}
                                                                        <small class="text-light">Fair Performance</small>
                                                                    {% else %}
                                                                        <small class="text-light">Poor Performance</small>
                                                                    {% endif %}
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card bg-info text-white">
                                                            <div class="card-body text-center">
                                                                <h4 class="mb-2">
                                                                    {% set first_bottleneck = None %}
                                                                    {% for result in tcp_results %}
                                                                        {% if result.tcp_bottleneck_type and not first_bottleneck %}
                                                                            {% set first_bottleneck = result.tcp_bottleneck_type %}
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                    {% if first_bottleneck %}
                                                                        {{ first_bottleneck.replace('_', ' ').title() }}
                                                                    {% else %}
                                                                        N/A
                                                                    {% endif %}
                                                                </h4>
                                                                <p class="mb-0">Primary Bottleneck</p>
                                                                <small class="text-light">Based on window analysis</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Detailed TCP Window Metrics -->
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <thead>
                                                            <tr><th>Metric</th><th>Average</th><th>Min</th><th>Max</th><th>Status</th></tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    Round Trip Time (ms)
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Network latency measured during TCP connection. Lower is better."></i>
                                                                </td>
                                                                {% set avg_rtt = tcp_results | extract_numeric('tcp_rtt_avg') %}
                                                                {% set min_rtt = tcp_results | extract_numeric('tcp_rtt_min') %}
                                                                {% set max_rtt = tcp_results | extract_numeric('tcp_rtt_max') %}
                                                                <td>{{ "%.2f"|format((avg_rtt | average) * 1000) if avg_rtt else 'N/A' }}</td>
                                                                <td>{{ "%.2f"|format((min_rtt | min) * 1000) if min_rtt else 'N/A' }}</td>
                                                                <td>{{ "%.2f"|format((max_rtt | max) * 1000) if max_rtt else 'N/A' }}</td>
                                                                <td>
                                                                    {% if avg_rtt and ((avg_rtt | average) * 1000) < 50 %}
                                                                        <span class="badge bg-success">Excellent</span>
                                                                    {% elif avg_rtt and ((avg_rtt | average) * 1000) < 100 %}
                                                                        <span class="badge bg-warning">Good</span>
                                                                    {% elif avg_rtt %}
                                                                        <span class="badge bg-danger">Poor</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    RTT Variation (ms)
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Network instability indicator. High variation suggests network congestion or path changes."></i>
                                                                </td>
                                                                {% set rtt_var = tcp_results | extract_numeric('tcp_rtt_variation') %}
                                                                <td>{{ "%.2f"|format((rtt_var | average) * 1000) if rtt_var else 'N/A' }}</td>
                                                                <td>-</td>
                                                                <td>{{ "%.2f"|format((rtt_var | max) * 1000) if rtt_var else 'N/A' }}</td>
                                                                <td>
                                                                    {% if rtt_var and ((rtt_var | average) * 1000) < 20 %}
                                                                        <span class="badge bg-success">Stable</span>
                                                                    {% elif rtt_var and ((rtt_var | average) * 1000) < 50 %}
                                                                        <span class="badge bg-warning">Moderate</span>
                                                                    {% elif rtt_var %}
                                                                        <span class="badge bg-danger">Unstable</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    Congestion Window (KB)
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Amount of data TCP can send before receiving acknowledgment. Larger windows = better throughput."></i>
                                                                </td>
                                                                {% set avg_cwnd = tcp_results | extract_numeric('tcp_cwnd_avg') %}
                                                                {% set min_cwnd = tcp_results | extract_numeric('tcp_cwnd_min') %}
                                                                {% set max_cwnd = tcp_results | extract_numeric('tcp_cwnd_max') %}
                                                                <td>{{ "%.1f"|format((avg_cwnd | average) / 1024) if avg_cwnd else 'N/A' }}</td>
                                                                <td>{{ "%.1f"|format((min_cwnd | min) / 1024) if min_cwnd else 'N/A' }}</td>
                                                                <td>{{ "%.1f"|format((max_cwnd | max) / 1024) if max_cwnd else 'N/A' }}</td>
                                                                <td>
                                                                    {% if avg_cwnd and (avg_cwnd | average) > 65536 %}
                                                                        <span class="badge bg-success">Large</span>
                                                                    {% elif avg_cwnd and (avg_cwnd | average) > 32768 %}
                                                                        <span class="badge bg-warning">Medium</span>
                                                                    {% elif avg_cwnd %}
                                                                        <span class="badge bg-danger">Small</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    Congestion Events
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Number of times TCP detected network congestion and reduced sending rate."></i>
                                                                </td>
                                                                {% set cong_events = tcp_results | extract_numeric('tcp_congestion_events') %}
                                                                <td>{{ cong_events | average | round(1) if cong_events else 'N/A' }}</td>
                                                                <td>{{ cong_events | min if cong_events else 'N/A' }}</td>
                                                                <td>{{ cong_events | max if cong_events else 'N/A' }}</td>
                                                                <td>
                                                                    {% if cong_events and (cong_events | average) == 0 %}
                                                                        <span class="badge bg-success">None</span>
                                                                    {% elif cong_events and (cong_events | average) < 3 %}
                                                                        <span class="badge bg-warning">Few</span>
                                                                    {% elif cong_events %}
                                                                        <span class="badge bg-danger">Many</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    Retransmissions
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Packets that had to be resent due to loss or corruption."></i>
                                                                </td>
                                                                {% set retrans = tcp_results | extract_numeric('tcp_retransmissions') %}
                                                                <td>{{ retrans | average | round(1) if retrans else 'N/A' }}</td>
                                                                <td>{{ retrans | min if retrans else 'N/A' }}</td>
                                                                <td>{{ retrans | max if retrans else 'N/A' }}</td>
                                                                <td>
                                                                    {% if retrans and (retrans | average) == 0 %}
                                                                        <span class="badge bg-success">None</span>
                                                                    {% elif retrans and (retrans | average) < 5 %}
                                                                        <span class="badge bg-warning">Few</span>
                                                                    {% elif retrans %}
                                                                        <span class="badge bg-danger">Many</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                
                                                <!-- Bottleneck Attribution Analysis -->
                                                <div class="alert alert-info mt-3">
                                                    <h6><i class="fas fa-search me-2"></i>Bottleneck Attribution Analysis</h6>
                                                    {% if bottleneck_types %}
                                                        {% set bottleneck_counts = {} %}
                                                        {% for type in bottleneck_types %}
                                                            {% set _ = bottleneck_counts.update({type: bottleneck_counts.get(type, 0) + 1}) %}
                                                        {% endfor %}
                                                        
                                                        <div class="row">
                                                            {% for type, count in bottleneck_counts.items() %}
                                                                <div class="col-md-6 mb-2">
                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                        <span>
                                                                            {% if type == 'network_congestion' %}
                                                                                <i class="fas fa-exclamation-triangle text-danger me-2"></i>Network Congestion
                                                                            {% elif type == 'server_limited' %}
                                                                                <i class="fas fa-server text-warning me-2"></i>Server Limited
                                                                            {% elif type == 'network_instability' %}
                                                                                <i class="fas fa-wifi text-danger me-2"></i>Network Instability
                                                                            {% elif type == 'packet_loss' %}
                                                                                <i class="fas fa-times-circle text-danger me-2"></i>Packet Loss
                                                                            {% elif type == 'optimal' %}
                                                                                <i class="fas fa-check-circle text-success me-2"></i>Optimal
                                                                            {% else %}
                                                                                <i class="fas fa-question-circle text-muted me-2"></i>{{ type | title | replace('_', ' ') }}
                                                                            {% endif %}
                                                                        </span>
                                                                        <span class="badge bg-primary">{{ count }} clients</span>
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                        
                                                        <hr class="my-3">
                                                        <small class="text-muted">
                                                            <strong>Interpretation:</strong>
                                                            <ul class="mb-1">
                                                                <li><strong>Network Congestion:</strong> Multiple congestion events detected - network path is overloaded</li>
                                                                <li><strong>Server Limited:</strong> Server processing is the bottleneck rather than network</li>
                                                                <li><strong>Network Instability:</strong> High RTT variation suggests unstable network conditions</li>
                                                                <li><strong>Packet Loss:</strong> Retransmissions detected - may indicate network issues</li>
                                                                <li><strong>Optimal:</strong> TCP performance is operating efficiently</li>
                                                            </ul>
                                                        </small>
                                                    {% else %}
                                                        <p class="mb-0">No bottleneck analysis data available for this test.</p>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    No TCP window analysis data available for this test. This advanced feature requires client version with TCP monitoring capabilities.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- TCP Handshake Timing Diagnostics -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tcpHandshakeAnalysis">
                                            <i class="fas fa-handshake me-2"></i>TCP Handshake Timing Diagnostics
                                        </button>
                                    </h2>
                                    <div id="tcpHandshakeAnalysis" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            {% set handshake_results = results | selectattr('tcp_handshake_total_time', 'defined') | list %}
                                            {% if handshake_results %}
                                                <!-- Summary Cards -->
                                                <div class="row mb-4">
                                                    <div class="col-md-6">
                                                        <div class="card bg-primary bg-gradient text-white">
                                                            <div class="card-body text-center">
                                                                {% set avg_total = handshake_results | extract_numeric('tcp_handshake_total_time') %}
                                                                <h4 class="mb-1">{{ "%.2f"|format(avg_total | average) if avg_total else 'N/A' }}ms</h4>
                                                                <p class="mb-0">Average Handshake Time</p>
                                                                <small class="text-light">
                                                                    {% if avg_total and (avg_total | average) < 50 %}
                                                                        Excellent Performance
                                                                    {% elif avg_total and (avg_total | average) < 100 %}
                                                                        Good Performance
                                                                    {% elif avg_total and (avg_total | average) < 200 %}
                                                                        Moderate Performance
                                                                    {% elif avg_total %}
                                                                        Needs Investigation
                                                                    {% else %}
                                                                        No Data
                                                                    {% endif %}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card bg-info bg-gradient text-white">
                                                            <div class="card-body text-center">
                                                                {% set avg_server = handshake_results | extract_numeric('tcp_handshake_server_processing') %}
                                                                <h4 class="mb-1">{{ "%.2f"|format(avg_server | average) if avg_server else 'N/A' }}ms</h4>
                                                                <p class="mb-0">Server Processing Time</p>
                                                                <small class="text-light">
                                                                    {% if avg_server and (avg_server | average) < 20 %}
                                                                        Fast Server Response
                                                                    {% elif avg_server and (avg_server | average) < 50 %}
                                                                        Normal Server Response
                                                                    {% elif avg_server %}
                                                                        Slow Server Response
                                                                    {% else %}
                                                                        No Data
                                                                    {% endif %}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Detailed Handshake Metrics -->
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <thead>
                                                            <tr><th>Metric</th><th>Average</th><th>Min</th><th>Max</th><th>Status</th></tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                                <td>
                                                                    SYN Packet Time
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Time to send initial SYN packet - measures local network stack processing"></i>
                                                                </td>
                                                                {% set syn_times = handshake_results | extract_numeric('tcp_handshake_syn_time') %}
                                                                <td>{{ "%.3f"|format(syn_times | average) if syn_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.3f"|format(syn_times | min) if syn_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.3f"|format(syn_times | max) if syn_times else 'N/A' }}ms</td>
                                                                <td>
                                                                    {% if syn_times and (syn_times | average) < 5 %}
                                                                        <span class="badge bg-success">Fast</span>
                                                                    {% elif syn_times and (syn_times | average) < 20 %}
                                                                        <span class="badge bg-warning">Normal</span>
                                                                    {% elif syn_times %}
                                                                        <span class="badge bg-danger">Slow</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    SYN-ACK Response Time
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Time to receive SYN-ACK from server - includes network latency and server processing"></i>
                                                                </td>
                                                                {% set synack_times = handshake_results | extract_numeric('tcp_handshake_synack_time') %}
                                                                <td>{{ "%.2f"|format(synack_times | average) if synack_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.2f"|format(synack_times | min) if synack_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.2f"|format(synack_times | max) if synack_times else 'N/A' }}ms</td>
                                                                <td>
                                                                    {% if synack_times and (synack_times | average) < 50 %}
                                                                        <span class="badge bg-success">Excellent</span>
                                                                    {% elif synack_times and (synack_times | average) < 100 %}
                                                                        <span class="badge bg-warning">Good</span>
                                                                    {% elif synack_times %}
                                                                        <span class="badge bg-danger">Poor</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    ACK Completion Time
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Time to send final ACK packet - completes the three-way handshake"></i>
                                                                </td>
                                                                {% set ack_times = handshake_results | extract_numeric('tcp_handshake_ack_time') %}
                                                                <td>{{ "%.3f"|format(ack_times | average) if ack_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.3f"|format(ack_times | min) if ack_times else 'N/A' }}ms</td>
                                                                <td>{{ "%.3f"|format(ack_times | max) if ack_times else 'N/A' }}ms</td>
                                                                <td>
                                                                    {% if ack_times and (ack_times | average) < 5 %}
                                                                        <span class="badge bg-success">Fast</span>
                                                                    {% elif ack_times and (ack_times | average) < 20 %}
                                                                        <span class="badge bg-warning">Normal</span>
                                                                    {% elif ack_times %}
                                                                        <span class="badge bg-danger">Slow</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td>
                                                                    Network Delay (Est.)
                                                                    <i class="fas fa-question-circle text-muted ms-1" data-bs-toggle="tooltip" data-bs-placement="top" 
                                                                       title="Estimated one-way network delay based on handshake timing analysis"></i>
                                                                </td>
                                                                {% set network_delays = handshake_results | extract_numeric('tcp_handshake_network_delay') %}
                                                                <td>{{ "%.2f"|format(network_delays | average) if network_delays else 'N/A' }}ms</td>
                                                                <td>{{ "%.2f"|format(network_delays | min) if network_delays else 'N/A' }}ms</td>
                                                                <td>{{ "%.2f"|format(network_delays | max) if network_delays else 'N/A' }}ms</td>
                                                                <td>
                                                                    {% if network_delays and (network_delays | average) < 25 %}
                                                                        <span class="badge bg-success">Low Latency</span>
                                                                    {% elif network_delays and (network_delays | average) < 75 %}
                                                                        <span class="badge bg-warning">Moderate</span>
                                                                    {% elif network_delays %}
                                                                        <span class="badge bg-danger">High Latency</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">N/A</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                
                                                <!-- Diagnostic Analysis -->
                                                {% if handshake_analysis_results %}
                                                    <div class="alert alert-info mt-3">
                                                        <h6 class="alert-heading">
                                                            <i class="fas fa-chart-line me-2"></i>Handshake Performance Analysis
                                                        </h6>
                                                        {% for result in handshake_analysis_results[:3] %}
                                                            <p class="mb-1"><strong>Client {{ result.client.hostname }}:</strong> {{ result.tcp_handshake_analysis }}</p>
                                                        {% endfor %}
                                                        {% if handshake_analysis_results | length > 3 %}
                                                            <small class="text-dark">... and {{ handshake_analysis_results | length - 3 }} more results</small>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                                
                                                <hr class="my-3">
                                                <small class="text-muted">
                                                    <strong>Interpretation Guide:</strong>
                                                    <ul class="mb-1">
                                                        <li><strong>SYN Time:</strong> High values indicate local network stack issues or CPU overload</li>
                                                        <li><strong>SYN-ACK Time:</strong> Primary indicator of server response and network latency combined</li>
                                                        <li><strong>ACK Time:</strong> Usually minimal - high values suggest local processing delays</li>
                                                        <li><strong>Network vs Server:</strong> Compare network delay with SYN-ACK time to isolate bottlenecks</li>
                                                    </ul>
                                                </small>
                                            {% else %}
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    No TCP handshake timing data available for this test. This advanced feature requires the latest client version with handshake diagnostics.
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- System Resources -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#systemMetrics">
                                            <i class="fas fa-server me-2"></i>System Resource Metrics
                                        </button>
                                    </h2>
                                    <div id="systemMetrics" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr><th>Metric</th><th>Average</th><th>Status</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>CPU Usage (%)</td>
                                                            {% set avg_cpu = results | extract_numeric('cpu_percent') %}
                                                            <td>{{ "%.1f"|format(avg_cpu | average) if avg_cpu else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_cpu and (avg_cpu | average) < 70 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_cpu and (avg_cpu | average) < 90 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_cpu %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Memory Usage (%)</td>
                                                            {% set avg_memory = results | extract_numeric('memory_percent') %}
                                                            <td>{{ "%.1f"|format(avg_memory | average) if avg_memory else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_memory and (avg_memory | average) < 80 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_memory and (avg_memory | average) < 95 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_memory %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>CPU Load (1min)</td>
                                                            {% set avg_load = results | extract_numeric('cpu_load_1min') %}
                                                            <td>{{ "%.2f"|format(avg_load | average) if avg_load else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_load and (avg_load | average) < 1 %}
                                                                    <span class="badge bg-success">Low</span>
                                                                {% elif avg_load and (avg_load | average) < 2 %}
                                                                    <span class="badge bg-warning">Moderate</span>
                                                                {% elif avg_load %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Process Count</td>
                                                            {% set proc_count = results | extract_numeric('process_count') %}
                                                            <td>{{ proc_count | average | round(0) | int if proc_count else 'N/A' }}</td>
                                                            <td><span class="badge bg-info">Info</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="3">
                                                                <div class="mt-3">
                                                                    <strong>Top Processes by CPU Usage:</strong>
                                                                    {% set latest_cpu_data = results | selectattr('top_processes_cpu') | first %}
                                                                    {% if latest_cpu_data and latest_cpu_data.top_processes_cpu %}
                                                                        {% set cpu_processes = latest_cpu_data.top_processes_cpu | from_json %}
                                                                        <div class="row mt-2">
                                                                            {% for process in cpu_processes[:5] %}
                                                                                <div class="col-md-6 mb-2">
                                                                                    <div class="card card-body py-2">
                                                                                        <div class="d-flex justify-content-between align-items-center">
                                                                                            <div>
                                                                                                <strong>{{ process.name }}</strong>
                                                                                                <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                                                            </div>
                                                                                            <div class="text-end">
                                                                                                <span class="badge bg-primary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                                                                <span class="badge bg-secondary">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    {% else %}
                                                                        <div class="text-muted">No process data available</div>
                                                                    {% endif %}
                                                                </div>
                                                                
                                                                <div class="mt-3">
                                                                    <strong>Top Processes by Memory Usage:</strong>
                                                                    {% set latest_mem_data = results | selectattr('top_processes_memory') | first %}
                                                                    {% if latest_mem_data and latest_mem_data.top_processes_memory %}
                                                                        {% set mem_processes = latest_mem_data.top_processes_memory | from_json %}
                                                                        <div class="row mt-2">
                                                                            {% for process in mem_processes[:5] %}
                                                                                <div class="col-md-6 mb-2">
                                                                                    <div class="card card-body py-2">
                                                                                        <div class="d-flex justify-content-between align-items-center">
                                                                                            <div>
                                                                                                <strong>{{ process.name }}</strong>
                                                                                                <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                                                            </div>
                                                                                            <div class="text-end">
                                                                                                <span class="badge bg-secondary">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                                                                <span class="badge bg-primary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    {% else %}
                                                                        <div class="text-muted">No process data available</div>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Application & Infrastructure -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#appMetrics">
                                            <i class="fas fa-globe me-2"></i>Application & Infrastructure Metrics
                                        </button>
                                    </h2>
                                    <div id="appMetrics" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            <!-- Application & Infrastructure Metrics Info Panel -->
                                            <div class="alert alert-info mb-3">
                                                <div class="row align-items-center">
                                                    <div class="col-md-1 text-center">
                                                        <i class="fas fa-info-circle fa-2x"></i>
                                                    </div>
                                                    <div class="col-md-11">
                                                        <h6 class="alert-heading mb-2">Application & Infrastructure Metrics Collection</h6>
                                                        <p class="mb-2">
                                                            <strong>Collection Window:</strong> Application metrics are collected during the <strong>first 2 intervals</strong> only, 
                                                            Infrastructure metrics during the <strong>first interval</strong> only of each test.
                                                        </p>
                                                        <p class="mb-2">
                                                            <strong>Recommended Settings:</strong> For reliable metric collection, use test duration ≥600 seconds with interval ≥15 seconds.
                                                        </p>
                                                        <p class="mb-0">
                                                            <strong>Requirements:</strong> Linux systems with network access for Application metrics, hardware monitoring files (/sys/class/) for Infrastructure metrics.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr><th>Metric</th><th>Value</th><th>Status</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Content Download Time (ms)</td>
                                                            {% set content_time = results | extract_numeric('content_download_time') %}
                                                            <td>{{ "%.2f"|format(content_time | average) if content_time else 'N/A' }}</td>
                                                            <td>
                                                                {% if content_time and (content_time | average) < 1000 %}
                                                                    <span class="badge bg-success">Fast</span>
                                                                {% elif content_time %}
                                                                    <span class="badge bg-warning">Slow</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Compression Ratio (%)</td>
                                                            {% set compress_ratio = results | extract_numeric('compression_ratio') %}
                                                            <td>{{ "%.1f"|format(compress_ratio | average) if compress_ratio else 'N/A' }}</td>
                                                            <td>
                                                                {% if compress_ratio and (compress_ratio | average) > 30 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif compress_ratio %}
                                                                    <span class="badge bg-warning">Low</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Power Consumption (W)</td>
                                                            {% set power_watts = results | extract_numeric('power_consumption_watts') %}
                                                            <td>{{ "%.1f"|format(power_watts | average) if power_watts else 'N/A' }}</td>
                                                            <td>
                                                                {% if power_watts and (power_watts | average) < 150 %}
                                                                    <span class="badge bg-success">Normal</span>
                                                                {% elif power_watts %}
                                                                    <span class="badge bg-warning">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Memory Error Rate (/hr)</td>
                                                            {% set mem_errors = results | extract_numeric('memory_error_rate') %}
                                                            <td>{{ "%.3f"|format(mem_errors | average) if mem_errors else 'N/A' }}</td>
                                                            <td>
                                                                {% if mem_errors and (mem_errors | average) < 0.1 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif mem_errors %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
let testData = {};
let networkChart, cpuChart, memoryChart, diskChart;
let currentMetric = 'ping_latency';

document.addEventListener('DOMContentLoaded', function() {
    loadTestData();
    
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

async function loadTestData() {
    try {
        console.log('Loading test data from: /api/test/{{ test.id }}/data');
        const response = await fetch(`/api/test/{{ test.id }}/data`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        testData = await response.json();
        console.log('Test data loaded successfully:', testData);
        
        // Check if we have valid data
        if (!testData || !testData.clients || Object.keys(testData.clients).length === 0) {
            console.log('No client data available');
            document.getElementById('avg-latency').textContent = '--';
            document.getElementById('avg-packet-loss').textContent = '--';
            document.getElementById('data-points').textContent = '0';
            return;
        }
        
        try {
            // Initialize charts and update stats
            initializeCharts();
            updateSummaryStats();
            updateClientSummary();
            displayGeolocationData();
            displayGNMIPathData();
            displayClientInfrastructureData();
            displayWiFiEnvironmentalAnalysis();
            displayVoIPAnalysis();
            console.log('All components initialized successfully');
        } catch (error) {
            console.error('Error during component initialization:', error);
        }
        
    } catch (error) {
        console.error('Error loading test data:', error);
        document.getElementById('avg-latency').textContent = '--';
        document.getElementById('avg-packet-loss').textContent = '--';
        document.getElementById('data-points').textContent = '0';
    }
}

function initializeCharts() {
    console.log('Initializing charts with data:', testData);
    
    if (!testData || !testData.clients || !testData.metrics) {
        console.error('Cannot initialize charts: missing data structure');
        return;
    }
    
    // Network Chart
    const networkCtx = document.getElementById('networkChart').getContext('2d');
    
    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1'];
    const datasets = Object.keys(testData.clients).map((clientId, index) => {
        const color = colors[index % colors.length];
        const metricData = testData.metrics[currentMetric] && testData.metrics[currentMetric][clientId] 
            ? testData.metrics[currentMetric][clientId] 
            : [];
        
        const validPoints = metricData.filter(p => p && p.y !== null && p.y !== undefined && !isNaN(p.y));
        console.log(`Client ${clientId} (${testData.clients[clientId]}) ${currentMetric}: ${validPoints.length}/${metricData.length} valid points`);
        
        const processedData = metricData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: color,
            backgroundColor: color + '20',
            fill: false,
            tension: 0.1
        };
    });

    networkChart = new Chart(networkCtx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                title: {
                    display: true,
                    text: getMetricTitle(currentMetric)
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        afterBody: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const clientId = Object.keys(testData.clients)[context[0].datasetIndex];
                            const clientName = testData.clients[clientId];
                            
                            // Add detailed information for troubleshooting
                            let details = [`Client: ${clientName} (ID: ${clientId})`];
                            
                            // Add traceroute data if available for this data point
                            if (testData.metrics.traceroute_data && testData.metrics.traceroute_data[clientId] && 
                                testData.metrics.traceroute_data[clientId][dataIndex]) {
                                const tracerouteData = testData.metrics.traceroute_data[clientId][dataIndex];
                                if (tracerouteData.y) {
                                    try {
                                        const traceData = JSON.parse(tracerouteData.y);
                                        if (traceData && traceData.hops) {
                                            details.push('Traceroute hops:');
                                            traceData.hops.slice(0, 5).forEach((hop, i) => {
                                                details.push(`  ${i+1}. ${hop.ip || hop.host || 'Unknown'} (${hop.rtt || 'N/A'}ms)`);
                                            });
                                            if (traceData.hops.length > 5) {
                                                details.push(`  ... and ${traceData.hops.length - 5} more hops`);
                                            }
                                        }
                                    } catch (e) {
                                        // Ignore JSON parsing errors
                                    }
                                }
                            }
                            
                            return details;
                        }
                    }
                }
            },
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const dataIndex = elements[0].index;
                    const datasetIndex = elements[0].datasetIndex;
                    const clientId = Object.keys(testData.clients)[datasetIndex];
                    showDataPointDetails(clientId, dataIndex);
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: {
                            minute: 'HH:mm',
                            hour: 'HH:mm'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: getMetricUnit(currentMetric)
                    },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value, index, values) {
                            if (currentMetric === 'bandwidth_upload' || currentMetric === 'bandwidth_download') {
                                return value.toFixed(1) + ' Mbps';
                            }
                            return value;
                        }
                    }
                }
            }
        }
    });

    // System Resource Charts
    initializeResourceCharts();
}

function initializeResourceCharts() {
    if (!testData || !testData.clients || !testData.metrics) {
        console.log('No data available for resource chart initialization');
        return;
    }
    
    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1'];
    
    // CPU Chart
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    const cpuDatasets = Object.keys(testData.clients).map((clientId, index) => {
        const rawData = (testData.metrics.cpu && testData.metrics.cpu[clientId]) || [];
        const processedData = rawData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            fill: false,
            tension: 0.1
        };
    });

    cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: { datasets: cpuDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: 'CPU %' },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Memory Chart
    const memoryCtx = document.getElementById('memoryChart').getContext('2d');
    const memoryDatasets = Object.keys(testData.clients).map((clientId, index) => {
        const rawData = (testData.metrics.memory && testData.metrics.memory[clientId]) || [];
        const processedData = rawData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            fill: false,
            tension: 0.1
        };
    });

    memoryChart = new Chart(memoryCtx, {
        type: 'line',
        data: { datasets: memoryDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: 'Memory %' },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Disk Chart
    const diskCtx = document.getElementById('diskChart').getContext('2d');
    const diskDatasets = Object.keys(testData.clients).map((clientId, index) => {
        const rawData = (testData.metrics.disk && testData.metrics.disk[clientId]) || [];
        const processedData = rawData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            fill: false,
            tension: 0.1
        };
    });

    diskChart = new Chart(diskCtx, {
        type: 'line',
        data: { datasets: diskDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: 'Disk %' },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function showMetric(metric) {
    currentMetric = metric;
    
    // Update dropdown label and chart title
    document.getElementById('current-metric-label').textContent = getMetricTitle(metric).replace(' Over Time', '');
    document.getElementById('chart-title').innerHTML = '<i class="fas fa-chart-line me-2"></i>' + getMetricTitle(metric);
    
    // Only update chart if it exists and testData is available
    if (networkChart && testData && testData.clients && testData.metrics) {
        const datasets = Object.keys(testData.clients).map((clientId, index) => {
            const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1'];
            const color = colors[index % colors.length];
            
            // Get raw data and filter out null/undefined values
            let rawData = testData.metrics[metric] && testData.metrics[metric][clientId] ? testData.metrics[metric][clientId] : [];
            
            // For bandwidth metrics, filter out null/zero values and ensure proper data structure
            let filteredData = rawData;
            if (metric === 'bandwidth_upload' || metric === 'bandwidth_download') {
                filteredData = rawData.filter(point => {
                    return point && 
                           point.x && 
                           point.y !== null && 
                           point.y !== undefined && 
                           point.y > 0; // Only show actual bandwidth measurements
                }).map(point => ({
                    x: new Date(point.x),
                    y: parseFloat(point.y)
                }));
            } else {
                // Standard filtering for other metrics
                filteredData = rawData.filter(point => {
                    return point && point.x && point.y !== null && point.y !== undefined;
                }).map(point => ({
                    x: new Date(point.x),
                    y: parseFloat(point.y)
                }));
            }
            
            return {
                label: testData.clients[clientId],
                data: filteredData,
                borderColor: color,
                backgroundColor: color + '20',
                fill: false,
                tension: 0.1,
                spanGaps: false, // Don't connect gaps in bandwidth data
                pointRadius: metric === 'bandwidth_upload' || metric === 'bandwidth_download' ? 4 : 3,
                pointHoverRadius: metric === 'bandwidth_upload' || metric === 'bandwidth_download' ? 6 : 4
            };
        });
        
        networkChart.data.datasets = datasets;
    networkChart.options.plugins.title.text = getMetricTitle(metric);
    networkChart.options.scales.y.title.text = getMetricUnit(metric);
        networkChart.update();
    }
}

function getMetricTitle(metric) {
    const titles = {
        'ping_latency': 'Network Latency Over Time',
        'ping_packet_loss': 'Packet Loss Over Time',
        'jitter': 'Network Jitter Over Time',
        'dns_resolution_time': 'DNS Resolution Time Over Time',
        'tcp_connect_time': 'TCP Connection Time Over Time',
        'ssl_handshake_time': 'SSL Handshake Time Over Time',
        'ttfb': 'Time to First Byte Over Time',
        'cpu_load_1min': 'CPU Load Average (1 minute) Over Time',
        'cpu_load_5min': 'CPU Load Average (5 minutes) Over Time',
        'cpu_load_15min': 'CPU Load Average (15 minutes) Over Time',
        'cpu_freq_current': 'CPU Frequency Over Time',
        'network_bytes_sent': 'Network Bytes Sent Over Time',
        'network_bytes_recv': 'Network Bytes Received Over Time',
        'network_errors_in': 'Network Errors (Incoming) Over Time',
        'network_errors_out': 'Network Errors (Outgoing) Over Time',
        'network_packets_sent': 'Network Packets Sent Over Time',
        'network_packets_recv': 'Network Packets Received Over Time',
        'network_drops_in': 'Network Drops (Incoming) Over Time',
        'network_drops_out': 'Network Drops (Outgoing) Over Time',
        'cpu_cores': 'CPU Core Count Over Time',
        'cpu_temperature': 'CPU Temperature Over Time',
        'process_count': 'Process Count Over Time',
        'tcp_connections': 'TCP Connections Over Time',
        'traceroute_hops': 'Network Path Length Over Time (Hops)',
        'memory_available': 'Memory Available Over Time (GB)',
        'memory_cached': 'Memory Cached Over Time (GB)',
        'memory_buffers': 'Memory Buffers Over Time (GB)',
        'swap_used': 'Swap Used Over Time (GB)',
        'swap_percent': 'Swap Usage Over Time (%)',
        'disk_read_iops': 'Disk Read IOPS Over Time',
        'bandwidth_upload': 'Bandwidth Upload Over Time',
        'bandwidth_download': 'Bandwidth Download Over Time',
        'disk_write_iops': 'Disk Write IOPS Over Time',
        'disk_read_bytes_sec': 'Disk Read Throughput Over Time',
        'disk_write_bytes_sec': 'Disk Write Throughput Over Time',
        'dscp_value': 'DSCP Values Over Time',
        'cos_value': 'CoS Values Over Time',
        'qos_policy_compliant': 'QoS Policy Compliance Over Time'
    };
    return titles[metric] || metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function getMetricUnit(metric) {
    const units = {
        'ping_latency': 'Latency (ms)',
        'ping_packet_loss': 'Packet Loss (%)',
        'jitter': 'Jitter (ms)',
        'dns_resolution_time': 'DNS Time (ms)',
        'tcp_connect_time': 'Connect Time (ms)',
        'ssl_handshake_time': 'SSL Time (ms)',
        'ttfb': 'TTFB (ms)',
        'cpu_load_1min': 'Load Average',
        'cpu_load_5min': 'Load Average',
        'cpu_load_15min': 'Load Average',
        'cpu_freq_current': 'Frequency (MHz)',
        'network_bytes_sent': 'Bytes',
        'network_bytes_recv': 'Bytes',
        'network_errors_in': 'Error Count',
        'network_errors_out': 'Error Count',
        'network_packets_sent': 'Packets',
        'network_packets_recv': 'Packets',
        'network_drops_in': 'Drop Count',
        'network_drops_out': 'Drop Count',
        'cpu_cores': 'Core Count',
        'cpu_temperature': '°C',
        'process_count': 'Processes',
        'tcp_connections': 'Connections',
        'memory_available': 'Bytes',
        'memory_cached': 'Bytes',
        'memory_buffers': 'Bytes',
        'swap_percent': 'Percent (%)',
        'traceroute_hops': 'Hops',
        'disk_read_iops': 'Operations/sec',
        'disk_write_iops': 'Operations/sec',
        'disk_read_bytes_sec': 'Bytes/sec',
        'disk_write_bytes_sec': 'Bytes/sec',
        'dscp_value': 'DSCP Code',
        'cos_value': 'CoS Value',
        'qos_policy_compliant': 'Compliance (0/1)',
        'bandwidth_upload': 'Upload Speed (Mbps)',
        'bandwidth_download': 'Download Speed (Mbps)'
    };
    return units[metric] || 'Value';
}

function updateSummaryStats() {
    console.log('Updating summary stats with data:', testData);
    
    if (!testData || !testData.clients || !testData.metrics) {
        console.log('Missing data structure for summary stats');
        document.getElementById('avg-latency').textContent = '--';
        document.getElementById('avg-packet-loss').textContent = '--';
        document.getElementById('data-points').textContent = '0';
        return;
    }
    
    // Calculate average latency and packet loss
    let totalLatency = 0;
    let totalPacketLoss = 0;
    let latencyCount = 0;
    let packetLossCount = 0;
    let totalCpu = 0;
    let cpuCount = 0;
    let totalDataPoints = 0;
    
    Object.keys(testData.clients).forEach(clientId => {
        const latencyData = (testData.metrics.ping_latency && testData.metrics.ping_latency[clientId]) || [];
        const packetLossData = (testData.metrics.ping_packet_loss && testData.metrics.ping_packet_loss[clientId]) || [];
        const cpuData = (testData.metrics.cpu && testData.metrics.cpu[clientId]) || [];
        
        // Count total data points from any metric
        totalDataPoints += Math.max(latencyData.length, cpuData.length, packetLossData.length);
        
        latencyData.forEach(point => {
            if (point && point.y !== null && point.y !== undefined && !isNaN(point.y)) {
                totalLatency += point.y;
                latencyCount++;
            }
        });
        
        packetLossData.forEach(point => {
            if (point && point.y !== null && point.y !== undefined && !isNaN(point.y)) {
                totalPacketLoss += point.y;
                packetLossCount++;
            }
        });
        
        cpuData.forEach(point => {
            if (point && point.y !== null && point.y !== undefined && !isNaN(point.y)) {
                totalCpu += point.y;
                cpuCount++;
            }
        });
    });
    
    // Update displays with actual data or appropriate messages
    const avgLatency = latencyCount > 0 ? (totalLatency / latencyCount).toFixed(1) : '--';
    const avgPacketLoss = packetLossCount > 0 ? (totalPacketLoss / packetLossCount).toFixed(1) : '--';
    const avgCpu = cpuCount > 0 ? (totalCpu / cpuCount).toFixed(1) : '--';
    
    // Update summary cards
    document.getElementById('data-points').textContent = totalDataPoints;
    document.getElementById('avg-latency').textContent = avgLatency + (avgLatency !== '--' ? ' ms' : '');
    document.getElementById('avg-packet-loss').textContent = avgPacketLoss + (avgPacketLoss !== '--' ? '%' : '');
    
    console.log(`Stats calculated: ${latencyCount} latency points, ${cpuCount} CPU points, ${packetLossCount} packet loss points, ${totalDataPoints} total data points`);
}

function updateClientSummary() {
    if (!testData || !testData.clients || !testData.metrics) {
        return;
    }
    
    Object.keys(testData.clients).forEach(clientId => {
        const latencyData = (testData.metrics.ping_latency && testData.metrics.ping_latency[clientId]) || [];
        const packetLossData = (testData.metrics.ping_packet_loss && testData.metrics.ping_packet_loss[clientId]) || [];
        const cpuData = (testData.metrics.cpu && testData.metrics.cpu[clientId]) || [];
        const memoryData = (testData.metrics.memory && testData.metrics.memory[clientId]) || [];
        const diskData = (testData.metrics.disk && testData.metrics.disk[clientId]) || [];
        
        // Calculate averages
        const avgLatency = calculateAverage(latencyData);
        const avgPacketLoss = calculateAverage(packetLossData);
        const avgCpu = calculateAverage(cpuData);
        const avgMemory = calculateAverage(memoryData);
        const avgDisk = calculateAverage(diskData);
        
        // Update table cells
        const dataPointsCell = document.querySelector(`[data-client="${clientId}"].client-data-points`);
        const latencyCell = document.querySelector(`[data-client="${clientId}"].client-avg-latency`);
        const packetLossCell = document.querySelector(`[data-client="${clientId}"].client-avg-packet-loss`);
        const cpuCell = document.querySelector(`[data-client="${clientId}"].client-avg-cpu`);
        const memoryCell = document.querySelector(`[data-client="${clientId}"].client-avg-memory`);
        const diskCell = document.querySelector(`[data-client="${clientId}"].client-avg-disk`);
        
        if (dataPointsCell) dataPointsCell.textContent = latencyData.length;
        if (latencyCell) latencyCell.textContent = avgLatency !== null ? avgLatency.toFixed(1) + ' ms' : '--';
        if (packetLossCell) packetLossCell.textContent = avgPacketLoss !== null ? avgPacketLoss.toFixed(1) + '%' : '--';
        if (cpuCell) cpuCell.textContent = avgCpu !== null ? avgCpu.toFixed(1) + '%' : '--';
        if (memoryCell) memoryCell.textContent = avgMemory !== null ? avgMemory.toFixed(1) + '%' : '--';
        if (diskCell) diskCell.textContent = avgDisk !== null ? avgDisk.toFixed(1) + '%' : '--';
    });
}

function calculateAverage(dataPoints) {
    const validPoints = dataPoints.filter(point => point.y !== null && point.y !== undefined);
    if (validPoints.length === 0) return null;
    
    const sum = validPoints.reduce((acc, point) => acc + point.y, 0);
    return sum / validPoints.length;
}

// Auto-refresh data every 30 seconds for running tests
{% if test.status == 'running' %}
setInterval(loadTestData, 30000);
{% endif %}

function exportPDF(testId) {
    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generating PDF...';
    btn.disabled = true;
    
    // Create a temporary link to download the PDF
    const link = document.createElement('a');
    link.href = `/api/test/${testId}/export/pdf`;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Restore button after a delay
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        showToast('PDF report download started', 'success');
    }, 2000);
}

function showDataPointDetails(clientId, dataIndex) {
    const clientName = testData.clients[clientId];
    const timestamp = testData.metrics[currentMetric] && testData.metrics[currentMetric][clientId] && 
                     testData.metrics[currentMetric][clientId][dataIndex] ? 
                     testData.metrics[currentMetric][clientId][dataIndex].x : 'Unknown';
    
    let modalContent = `
        <div class="modal fade" id="dataPointModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-search me-2"></i>
                            Data Point Details - ${clientName}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Client:</strong> ${clientName} (ID: ${clientId})
                            </div>
                            <div class="col-md-4">
                                <strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}
                            </div>
                            <div class="col-md-4" id="currentHopInfo">
                                <strong>Current Network Hop:</strong> <span id="hopNumber">Analyzing...</span>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6>Metrics at this time point:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Metric</th>
                                                <th>Value</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="metricsTable">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row" id="tracerouteSection" style="display: none;">
                            <div class="col-12">
                                <h6>Network Path Analysis:</h6>
                                <div class="alert alert-info mb-3" id="hopAnalysis" style="display: none;">
                                    <i class="fas fa-route me-2"></i>
                                    <span id="hopAnalysisText"></span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Hop</th>
                                                <th>IP/Host</th>
                                                <th>RTT (ms)</th>
                                                <th>Status</th>
                                                <th>Analysis</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tracerouteTable">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="exportDataPoint('${clientId}', ${dataIndex})">
                            <i class="fas fa-download me-1"></i>Export Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('dataPointModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Populate metrics table
    const metricsTable = document.getElementById('metricsTable');
    const metricNames = [
        'ping_latency', 'ping_packet_loss', 'jitter', 'dns_resolution_time', 'tcp_connect_time',
        'ssl_handshake_time', 'ttfb', 'cpu', 'memory', 'disk', 'network_bytes_sent', 'network_bytes_recv'
    ];
    
    metricNames.forEach(metric => {
        if (testData.metrics[metric] && testData.metrics[metric][clientId] && 
            testData.metrics[metric][clientId][dataIndex]) {
            const value = testData.metrics[metric][clientId][dataIndex].y;
            if (value !== null && value !== undefined) {
                const row = document.createElement('tr');
                const status = getMetricStatus(metric, value);
                row.innerHTML = `
                    <td>${getMetricDisplayName(metric)}</td>
                    <td>${formatMetricValue(metric, value)}</td>
                    <td><span class="badge bg-${status.color}">${status.text}</span></td>
                `;
                metricsTable.appendChild(row);
            }
        }
    });
    

    
    // Populate traceroute table and analyze network hops if available
    if (testData.metrics.traceroute_data && testData.metrics.traceroute_data[clientId] && 
        testData.metrics.traceroute_data[clientId][dataIndex]) {
        const tracerouteData = testData.metrics.traceroute_data[clientId][dataIndex];
        if (tracerouteData.y) {
            try {
                // Parse the traceroute data - it's stored as an array of strings
                const rawTraceData = JSON.parse(tracerouteData.y);
                
                // Convert the array of strings to hop objects
                const hops = [];
                if (Array.isArray(rawTraceData)) {
                    rawTraceData.forEach((hopLine, index) => {
                        const hop = parseTracerouteHop(hopLine, index);
                        if (hop) {
                            hops.push(hop);
                        }
                    });
                }
                
                if (hops.length > 0) {
                    document.getElementById('tracerouteSection').style.display = 'block';
                    const tracerouteTable = document.getElementById('tracerouteTable');
                    
                    // Analyze current performance metrics to identify problem hop
                    const currentLatency = testData.metrics.ping_latency && testData.metrics.ping_latency[clientId] && 
                                         testData.metrics.ping_latency[clientId][dataIndex] ? 
                                         testData.metrics.ping_latency[clientId][dataIndex].y : null;
                    
                    const currentJitter = testData.metrics.jitter && testData.metrics.jitter[clientId] && 
                                        testData.metrics.jitter[clientId][dataIndex] ? 
                                        testData.metrics.jitter[clientId][dataIndex].y : null;
                    
                    let problemHop = analyzeProblemHop(hops, currentLatency, currentJitter);
                    
                    // Update current hop info
                    const hopNumberElement = document.getElementById('hopNumber');
                    if (problemHop.hopIndex !== -1) {
                        hopNumberElement.innerHTML = `<span class="badge bg-${problemHop.severity}">${problemHop.hopIndex + 1}</span> ${problemHop.description}`;
                        
                        // Show analysis alert
                        document.getElementById('hopAnalysis').style.display = 'block';
                        document.getElementById('hopAnalysisText').textContent = problemHop.analysis;
                    } else {
                        hopNumberElement.textContent = 'All hops performing normally';
                    }
                    
                    hops.forEach((hop, index) => {
                        const row = document.createElement('tr');
                        const rtt = hop.rtt || 'Timeout';
                        const status = hop.rtt ? (hop.rtt > 100 ? 'warning' : 'success') : 'danger';
                        const statusText = hop.rtt ? (hop.rtt > 100 ? 'Slow' : 'Good') : 'Timeout';
                        
                        // Add special highlighting for problem hop
                        const isProbleHop = index === problemHop.hopIndex;
                        const rowClass = isProbleHop ? 'table-warning' : '';
                        
                        // Analyze this specific hop
                        let hopAnalysis = analyzeIndividualHop(hop, index, hops);
                        
                        row.className = rowClass;
                        row.innerHTML = `
                            <td>${hop.hopNumber}${isProbleHop ? ' <i class="fas fa-exclamation-triangle text-warning"></i>' : ''}</td>
                            <td>${hop.host || hop.ip || 'Unknown'}</td>
                            <td>${rtt}</td>
                            <td><span class="badge bg-${status}">${statusText}</span></td>
                            <td><small class="text-muted">${hopAnalysis}</small></td>
                        `;
                        tracerouteTable.appendChild(row);
                    });
                }
            } catch (e) {
                console.error('Error parsing traceroute data:', e);
            }
        }
    } else {
        // No traceroute data available, but still show basic hop analysis
        document.getElementById('hopNumber').textContent = 'Traceroute data not available';
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('dataPointModal'));
    modal.show();
}

function getMetricDisplayName(metric) {
    const names = {
        'ping_latency': 'Network Latency',
        'ping_packet_loss': 'Packet Loss',
        'jitter': 'Network Jitter',
        'dns_resolution_time': 'DNS Resolution',
        'tcp_connect_time': 'TCP Connect',
        'ssl_handshake_time': 'SSL Handshake',
        'ttfb': 'Time to First Byte',
        'cpu': 'CPU Usage',
        'memory': 'Memory Usage',
        'disk': 'Disk Usage',
        'network_bytes_sent': 'Bytes Sent',
        'network_bytes_recv': 'Bytes Received'
    };
    return names[metric] || metric;
}

function formatMetricValue(metric, value) {
    if (metric.includes('latency') || metric.includes('time') || metric === 'jitter' || metric === 'ttfb') {
        return `${value.toFixed(2)} ms`;
    } else if (metric.includes('packet_loss') || metric === 'cpu' || metric === 'memory' || metric === 'disk') {
        return `${value.toFixed(1)}%`;
    } else if (metric.includes('bytes')) {
        return formatBytes(value);
    }
    return value.toString();
}

function getMetricStatus(metric, value) {
    if (metric === 'ping_latency' || metric === 'jitter') {
        if (value < 50) return { color: 'success', text: 'Excellent' };
        if (value < 150) return { color: 'warning', text: 'Good' };
        return { color: 'danger', text: 'Poor' };
    } else if (metric === 'ping_packet_loss') {
        if (value === 0) return { color: 'success', text: 'Excellent' };
        if (value < 1) return { color: 'warning', text: 'Acceptable' };
        return { color: 'danger', text: 'Poor' };
    } else if (metric === 'cpu' || metric === 'memory' || metric === 'disk') {
        if (value < 70) return { color: 'success', text: 'Normal' };
        if (value < 90) return { color: 'warning', text: 'High' };
        return { color: 'danger', text: 'Critical' };
    } else if (metric.includes('time') || metric === 'ttfb') {
        if (value < 100) return { color: 'success', text: 'Fast' };
        if (value < 500) return { color: 'warning', text: 'Moderate' };
        return { color: 'danger', text: 'Slow' };
    }
    return { color: 'secondary', text: 'Info' };
}

function parseTracerouteHop(hopLine, index) {
    // Parse traceroute hop line like: "1  _gateway (172.16.10.253)  3.744 ms  3.836 ms  3.804 ms"
    if (!hopLine || hopLine.trim() === '' || hopLine.includes('* * *')) {
        return { hopNumber: index + 1, ip: null, host: null, rtt: null };
    }
    
    try {
        // Extract IP address - look for patterns like (192.168.1.1)
        const ipMatch = hopLine.match(/\(([^)]+)\)/);
        const ip = ipMatch ? ipMatch[1] : null;
        
        // Extract hostname - text before the IP address
        let host = null;
        if (ipMatch) {
            const beforeIp = hopLine.split('(')[0].trim();
            const parts = beforeIp.split(/\s+/);
            if (parts.length > 1) {
                host = parts[parts.length - 1];
            }
        }
        
        // Extract RTT - look for the first "X.XXX ms" pattern
        const rttMatch = hopLine.match(/(\d+\.?\d*)\s*ms/);
        const rtt = rttMatch ? parseFloat(rttMatch[1]) : null;
        
        return {
            hopNumber: index + 1,
            ip: ip,
            host: host || ip || 'Unknown',
            rtt: rtt
        };
    } catch (e) {
        return { hopNumber: index + 1, ip: null, host: 'Parse Error', rtt: null };
    }
}

function analyzeProblemHop(hops, currentLatency, currentJitter) {
    let result = { hopIndex: -1, severity: 'success', description: 'All hops normal', analysis: '' };
    
    if (!hops || hops.length === 0) return result;
    
    // Look for significant RTT increases between consecutive hops
    let maxRttIncrease = 0;
    let problemHopIndex = -1;
    let previousRtt = 0;
    
    hops.forEach((hop, index) => {
        if (hop.rtt && hop.rtt > 0) {
            if (index > 0 && previousRtt > 0) {
                const increase = hop.rtt - previousRtt;
                if (increase > maxRttIncrease && increase > 50) { // Significant increase threshold
                    maxRttIncrease = increase;
                    problemHopIndex = index;
                }
            }
            previousRtt = hop.rtt;
        }
    });
    
    // Check for timeouts or very high latency
    hops.forEach((hop, index) => {
        if (!hop.rtt || hop.rtt > 500) {
            if (problemHopIndex === -1 || maxRttIncrease < 200) {
                problemHopIndex = index;
                maxRttIncrease = hop.rtt || 1000;
            }
        }
    });
    
    if (problemHopIndex !== -1) {
        const problemHop = hops[problemHopIndex];
        result.hopIndex = problemHopIndex;
        
        if (!problemHop.rtt) {
            result.severity = 'danger';
            result.description = `${problemHop.ip || problemHop.host || 'Unknown'} (Timeout)`;
            result.analysis = `Hop ${problemHopIndex + 1} is experiencing timeouts, which may indicate packet loss or filtering.`;
        } else if (problemHop.rtt > 500) {
            result.severity = 'danger';
            result.description = `${problemHop.ip || problemHop.host || 'Unknown'} (${problemHop.rtt}ms)`;
            result.analysis = `Hop ${problemHopIndex + 1} has very high latency (${problemHop.rtt}ms), indicating a bottleneck.`;
        } else if (maxRttIncrease > 100) {
            result.severity = 'warning';
            result.description = `${problemHop.ip || problemHop.host || 'Unknown'} (+${maxRttIncrease.toFixed(1)}ms)`;
            result.analysis = `Hop ${problemHopIndex + 1} shows a significant latency increase of ${maxRttIncrease.toFixed(1)}ms from the previous hop.`;
        }
    }
    
    return result;
}

function analyzeIndividualHop(hop, index, allHops) {
    if (!hop.rtt) return 'Timeout or filtered';
    
    if (hop.rtt > 500) return 'Very high latency';
    if (hop.rtt > 200) return 'High latency';
    
    // Check if this hop has a significant increase from previous
    if (index > 0 && allHops[index - 1] && allHops[index - 1].rtt) {
        const increase = hop.rtt - allHops[index - 1].rtt;
        if (increase > 100) return `+${increase.toFixed(1)}ms increase`;
        if (increase > 50) return `+${increase.toFixed(1)}ms rise`;
    }
    
    // Classify by RTT range
    if (hop.rtt < 10) return 'Excellent';
    if (hop.rtt < 50) return 'Good';
    if (hop.rtt < 100) return 'Acceptable';
    return 'Slow';
}

function exportDataPoint(clientId, dataIndex) {
    // Create detailed export data
    const clientName = testData.clients[clientId];
    const timestamp = testData.metrics[currentMetric][clientId][dataIndex].x;
    
    let exportData = {
        client: { id: clientId, name: clientName },
        timestamp: timestamp,
        metrics: {},
        networkPath: null
    };
    
    // Collect all available metrics for this data point
    Object.keys(testData.metrics).forEach(metric => {
        if (testData.metrics[metric][clientId] && testData.metrics[metric][clientId][dataIndex]) {
            exportData.metrics[metric] = testData.metrics[metric][clientId][dataIndex].y;
        }
    });
    
    // Include traceroute data if available
    if (testData.metrics.traceroute_data && testData.metrics.traceroute_data[clientId] && 
        testData.metrics.traceroute_data[clientId][dataIndex]) {
        try {
            const rawTraceData = JSON.parse(testData.metrics.traceroute_data[clientId][dataIndex].y);
            const hops = [];
            if (Array.isArray(rawTraceData)) {
                rawTraceData.forEach((hopLine, index) => {
                    const hop = parseTracerouteHop(hopLine, index);
                    if (hop) {
                        hops.push(hop);
                    }
                });
            }
            exportData.networkPath = { hops: hops, raw: rawTraceData };
        } catch (e) {
            exportData.networkPath = { error: 'Failed to parse traceroute data' };
        }
    }
    
    // Download as JSON file
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `datapoint_${clientName}_${timestamp.replace(/[:.]/g, '-')}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function displayGeolocationData() {
    // Check if this is a WiFi-only test by checking if we're on a WiFi environmental test
    const isWifiOnly = {{ 'true' if is_wifi_only else 'false' }};
    if (isWifiOnly) {
        console.log('WiFi-only test detected - skipping geolocation analysis');
        return;
    }
    
    // Check if we have geolocation data in any of the test results
    let hasGeolocationData = false;
    let mapHtml = null;
    let totalDistance = null;
    let efficiency = null;
    
    // Look through test data for geolocation information
    if (testData && testData.metrics) {
        // Check for path_map_html in the metrics
        if (testData.metrics.path_map_html) {
            for (const clientId in testData.metrics.path_map_html) {
                const clientData = testData.metrics.path_map_html[clientId];
                if (clientData && clientData.length > 0) {
                    // Get the most recent map data
                    const recentMap = clientData[clientData.length - 1];
                    if (recentMap && recentMap.y) {
                        mapHtml = recentMap.y;
                        hasGeolocationData = true;
                        break;
                    }
                }
            }
        }
        
        // Get distance and efficiency data
        if (testData.metrics.path_total_distance_km) {
            for (const clientId in testData.metrics.path_total_distance_km) {
                const distanceData = testData.metrics.path_total_distance_km[clientId];
                if (distanceData && distanceData.length > 0) {
                    const recentDistance = distanceData[distanceData.length - 1];
                    if (recentDistance && recentDistance.y !== null) {
                        totalDistance = recentDistance.y;
                        break;
                    }
                }
            }
        }
        
        if (testData.metrics.path_geographic_efficiency) {
            for (const clientId in testData.metrics.path_geographic_efficiency) {
                const efficiencyData = testData.metrics.path_geographic_efficiency[clientId];
                if (efficiencyData && efficiencyData.length > 0) {
                    const recentEfficiency = efficiencyData[efficiencyData.length - 1];
                    if (recentEfficiency && recentEfficiency.y !== null) {
                        efficiency = recentEfficiency.y;
                        break;
                    }
                }
            }
        }
    }
    
    if (hasGeolocationData) {
        // Show the geolocation section
        document.getElementById('geolocationSection').style.display = 'block';
        
        // Update summary stats
        if (totalDistance !== null) {
            document.getElementById('pathDistance').textContent = `${totalDistance.toFixed(1)} km`;
        }
        
        if (efficiency !== null) {
            // Efficiency is already stored as percentage in database, no need to multiply by 100
            const efficiencyPercent = efficiency.toFixed(1);
            document.getElementById('pathEfficiency').textContent = `${efficiencyPercent}%`;
            
            // Update text color based on efficiency (using percentage values)
            const efficiencyElement = document.getElementById('pathEfficiency');
            if (efficiency >= 80) {
                efficiencyElement.className = 'mb-0 text-success';
            } else if (efficiency >= 60) {
                efficiencyElement.className = 'mb-0 text-warning';
            } else {
                efficiencyElement.className = 'mb-0 text-danger';
            }
        }
        
        // Inject the map HTML
        if (mapHtml) {
            // Extract iframe content if present to avoid security restrictions
            if (mapHtml.includes('srcdoc=')) {
                // Extract the srcdoc content from the iframe
                const srcdocMatch = mapHtml.match(/srcdoc="([^"]+)"/);
                if (srcdocMatch) {
                    // Decode HTML entities in the srcdoc content
                    const decodedContent = srcdocMatch[1]
                        .replace(/&lt;/g, '<')
                        .replace(/&gt;/g, '>')
                        .replace(/&quot;/g, '"')
                        .replace(/&amp;/g, '&');
                    
                    // Create an iframe with the decoded content
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '500px';
                    iframe.style.border = 'none';
                    iframe.style.borderRadius = '0.375rem';
                    iframe.srcdoc = decodedContent;
                    
                    const mapContainer = document.getElementById('geolocationMap');
                    mapContainer.innerHTML = '';
                    mapContainer.appendChild(iframe);
                } else {
                    document.getElementById('geolocationMap').innerHTML = mapHtml;
                }
            } else {
                document.getElementById('geolocationMap').innerHTML = mapHtml;
            }
        }
        
        console.log('Geolocation data displayed successfully');
        
        // Hide the processing button since we have map data
        document.getElementById('geolocationProcessingContainer').style.display = 'none';
    } else {
        console.log('No geolocation data available for this test');
        
        // Check if we have traceroute data that could be processed
        let hasTracerouteData = false;
        if (testData && testData.metrics && testData.metrics.traceroute_data) {
            for (const clientId in testData.metrics.traceroute_data) {
                const tracerouteData = testData.metrics.traceroute_data[clientId];
                if (tracerouteData && tracerouteData.length > 0) {
                    for (const dataPoint of tracerouteData) {
                        if (dataPoint && dataPoint.y && Array.isArray(JSON.parse(dataPoint.y)) && JSON.parse(dataPoint.y).length > 0) {
                            hasTracerouteData = true;
                            break;
                        }
                    }
                    if (hasTracerouteData) break;
                }
            }
        }
        
        if (hasTracerouteData) {
            // Show the geolocation section with processing button
            document.getElementById('geolocationSection').style.display = 'block';
            document.getElementById('geolocationProcessingContainer').style.display = 'block';
            console.log('Traceroute data available - showing geolocation processing option');
        }
    }
}

// Function to process geolocation data using server-side processing
async function processGeolocation() {
    const button = document.getElementById('processGeolocationBtn');
    const originalText = button.innerHTML;
    
    // Update button to show processing state
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    
    try {
        const response = await fetch(`/api/test/{{ test.id }}/process-geolocation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.status === 'processing') {
            // Show success message and hide the button
            button.innerHTML = '<i class="fas fa-check me-2"></i>Processing Started';
            button.className = 'btn btn-success';
            
            // Refresh the page data after a short delay to show the results
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            button.innerHTML = originalText;
            button.disabled = false;
            console.log('Processing response:', result);
        }
        
    } catch (error) {
        console.error('Error processing geolocation:', error);
        button.innerHTML = originalText;
        button.disabled = false;
        alert('Failed to process geolocation data. Please try again.');
    }
}

function displayGNMIPathData() {
    console.log('Checking for GNMI path analysis data...');
    
    if (!testData || !testData.metrics) {
        console.log('No test data available for GNMI analysis');
        return;
    }
    
    // Check if this is a WiFi-only test by checking if we're on a WiFi environmental test
    const isWifiOnly = {{ 'true' if is_wifi_only else 'false' }};
    if (isWifiOnly) {
        console.log('WiFi-only test detected - skipping GNMI analysis');
        return;
    }
    
    let hasGNMIData = false;
    let gnmiAnalysis = null;
    
    // Check for GNMI path analysis data
    if (testData.metrics.gnmi_path_analysis) {
        for (const clientId in testData.metrics.gnmi_path_analysis) {
            const clientData = testData.metrics.gnmi_path_analysis[clientId];
            if (clientData && clientData.length > 0) {
                // Get the most recent analysis data
                const recentData = clientData[clientData.length - 1];
                if (recentData && recentData.y) {
                    try {
                        gnmiAnalysis = JSON.parse(recentData.y);
                        hasGNMIData = true;
                        break;
                    } catch (e) {
                        console.error('Error parsing GNMI analysis data:', e);
                    }
                }
            }
        }
    }
    
    if (hasGNMIData && gnmiAnalysis) {
        console.log('GNMI data found, displaying analysis...');
        document.getElementById('gnmiPathSection').style.display = 'block';
        
        // Update summary statistics
        const managedDevices = gnmiAnalysis.managed_devices_in_path ? gnmiAnalysis.managed_devices_in_path.length : 0;
        document.getElementById('gnmiManagedDevices').textContent = `${managedDevices} devices`;
        
        const totalLatency = gnmiAnalysis.total_infrastructure_latency_ms || 0;
        document.getElementById('gnmiTotalLatency').textContent = `${totalLatency.toFixed(2)} ms`;
        
        const issueCount = gnmiAnalysis.insights ? gnmiAnalysis.insights.length : 0;
        document.getElementById('gnmiIssueCount').textContent = `${issueCount} insights`;
        
        // Populate device table
        const deviceTable = document.getElementById('gnmiDeviceTable');
        deviceTable.innerHTML = ''; // Clear existing data
        
        if (gnmiAnalysis.managed_devices_in_path) {
            gnmiAnalysis.managed_devices_in_path.forEach(device => {
                const row = document.createElement('tr');
                
                // Determine status based on metrics
                let statusClass = 'success';
                let statusText = 'Normal';
                
                if (device.processing_latency_ms > 10 || device.cpu_utilization > 80) {
                    statusClass = 'warning';
                    statusText = 'Attention';
                } else if (device.processing_latency_ms > 20 || device.cpu_utilization > 90) {
                    statusClass = 'danger';
                    statusText = 'Critical';
                }
                
                row.innerHTML = `
                    <td>${device.device_ip || 'Unknown'}</td>
                    <td>${device.device_type || 'Router'}</td>
                    <td>${device.processing_latency_ms ? device.processing_latency_ms.toFixed(2) + ' ms' : '--'}</td>
                    <td>${device.queue_latency_ms ? device.queue_latency_ms.toFixed(2) + ' ms' : '--'}</td>
                    <td>${device.cpu_utilization ? device.cpu_utilization.toFixed(1) + '%' : '--'}</td>
                    <td>${device.interface_utilization ? device.interface_utilization.toFixed(1) + '%' : '--'}</td>
                    <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                `;
                deviceTable.appendChild(row);
            });
        }
        
        // Display insights
        const insightsContainer = document.getElementById('gnmiInsights');
        insightsContainer.innerHTML = ''; // Clear existing insights
        
        if (gnmiAnalysis.insights && gnmiAnalysis.insights.length > 0) {
            gnmiAnalysis.insights.forEach(insight => {
                const insightElement = document.createElement('div');
                insightElement.className = 'list-group-item list-group-item-action';
                insightElement.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1"><i class="fas fa-info-circle me-2"></i>Infrastructure Insight</h6>
                        <small class="text-muted">GNMI Analysis</small>
                    </div>
                    <p class="mb-1">${insight}</p>
                `;
                insightsContainer.appendChild(insightElement);
            });
        } else {
            const noInsights = document.createElement('div');
            noInsights.className = 'list-group-item';
            noInsights.innerHTML = '<p class="mb-0 text-muted">No specific infrastructure issues detected.</p>';
            insightsContainer.appendChild(noInsights);
        }
        
        console.log('GNMI analysis data displayed successfully');
    } else {
        console.log('No GNMI analysis data available');
    }
}

function displayClientInfrastructureData() {
    console.log('Checking for client infrastructure analysis...');
    
    // Check if this is a WiFi-only test - skip infrastructure analysis for WiFi environmental tests
    const isWifiOnly = {{ 'true' if is_wifi_only else 'false' }};
    if (isWifiOnly) {
        console.log('WiFi-only test detected - skipping client infrastructure analysis');
        return;
    }
    
    // Get client ID from the testData structure
    if (!testData || !testData.clients || Object.keys(testData.clients).length === 0) {
        console.log('No test data available for client infrastructure analysis');
        return;
    }
    
    // Get the first client ID
    const clientIds = Object.keys(testData.clients);
    const clientId = clientIds[0];
    
    if (!clientId) {
        console.log('No client ID available for infrastructure analysis');
        return;
    }
    
    console.log('Fetching client infrastructure analysis for client:', clientId);
    
    // Fetch client infrastructure analysis
    fetch('/api/analyze-client-infrastructure', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            client_id: clientId,
            days_back: 30
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Client infrastructure analysis response:', data);
        
        if (data.status === 'success' && data.correlation_analysis) {
            displayClientInfrastructureAnalysis(data);
            document.getElementById('clientInfrastructureSection').style.display = 'block';
        } else {
            console.log('No client infrastructure analysis available:', data.message || 'Unknown reason');
        }
    })
    .catch(error => {
        console.error('Error fetching client infrastructure analysis:', error);
    });
}

function displayClientInfrastructureAnalysis(data) {
    console.log('Displaying client infrastructure analysis data...');
    
    // Check if this is a WiFi-only test by checking if we're on a WiFi environmental test
    const isWifiOnly = {{ 'true' if is_wifi_only else 'false' }};
    if (isWifiOnly) {
        console.log('WiFi-only test detected - skipping client infrastructure analysis');
        return;
    }
    
    const analysis = data.correlation_analysis;
    const recommendations = data.recommendations || [];
    
    // Update summary metrics with actual API response structure
    const correlationScore = analysis.average_correlation || 0;
    document.getElementById('infraCorrelationScore').textContent = 
        correlationScore ? (correlationScore * 100).toFixed(1) + '%' : 'N/A';
    
    // Calculate risk level based on actual correlation magnitudes, not just problem area existence
    let riskLevel = 'Low';
    
    // Use correlation score as primary risk indicator
    if (correlationScore > 0.15) {  // >15% correlation indicates significant infrastructure impact
        riskLevel = 'High';
    } else if (correlationScore > 0.05) {  // >5% correlation indicates moderate infrastructure impact
        riskLevel = 'Medium';
    } else {
        // For very low correlations, check if there are any meaningful feature importance values
        if (analysis.feature_importance) {
            const maxImportance = Math.max(...Object.values(analysis.feature_importance));
            if (maxImportance > 0.002) {  // >0.2% feature importance might indicate some infrastructure correlation
                riskLevel = 'Low-Medium';
            }
        }
    }
    
    document.getElementById('infraRiskLevel').textContent = riskLevel;
    
    document.getElementById('infraRecommendationCount').textContent = 
        recommendations.length + ' items';
    
    // Display key correlations
    const correlationsContainer = document.getElementById('infraCorrelations');
    correlationsContainer.innerHTML = '';
    
    if (analysis.feature_importance && Object.keys(analysis.feature_importance).length > 0) {
        // Sort features by importance and take top 6
        const sortedFeatures = Object.entries(analysis.feature_importance)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 6);
        
        sortedFeatures.forEach(([feature, importance]) => {
            const correlationCard = document.createElement('div');
            correlationCard.className = 'col-md-6 mb-3';
            
            let badgeClass = 'bg-secondary';
            let correlationPercent = importance * 100;
            if (correlationPercent > 0.07) badgeClass = 'bg-danger';
            else if (correlationPercent > 0.05) badgeClass = 'bg-warning';
            else if (correlationPercent > 0.03) badgeClass = 'bg-info';
            
            // Format feature name for display
            const displayName = feature.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            correlationCard.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${displayName}</h6>
                        <p class="card-text">This system metric shows correlation with network performance</p>
                        <span class="badge ${badgeClass}">${correlationPercent.toFixed(2)}% importance</span>
                    </div>
                </div>
            `;
            correlationsContainer.appendChild(correlationCard);
        });
    } else {
        correlationsContainer.innerHTML = '<div class="col-12"><p class="text-muted">No significant correlations detected</p></div>';
    }
    
    // Display recommendations
    const recommendationsContainer = document.getElementById('infraRecommendations');
    recommendationsContainer.innerHTML = '';
    
    if (recommendations.length > 0) {
        recommendations.forEach(rec => {
            const recItem = document.createElement('div');
            recItem.className = 'list-group-item';
            
            let iconClass = 'fas fa-info-circle text-info';
            if (rec.priority === 'high') iconClass = 'fas fa-exclamation-triangle text-danger';
            else if (rec.priority === 'medium') iconClass = 'fas fa-exclamation-circle text-warning';
            
            recItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <i class="${iconClass} me-2"></i>${rec.title}
                        </h6>
                        <p class="mb-1">${rec.description}</p>
                        <small class="text-muted">Priority: ${rec.priority} | Impact: ${rec.impact}</small>
                    </div>
                </div>
            `;
            recommendationsContainer.appendChild(recItem);
        });
    } else {
        recommendationsContainer.innerHTML = '<div class="list-group-item"><p class="mb-0 text-muted">No specific recommendations available</p></div>';
    }
    
    console.log('Client infrastructure analysis displayed successfully');
}

function displayWiFiEnvironmentalAnalysis() {
    console.log('Checking for WiFi environmental data...');
    
    // Check if any test results contain WiFi environmental data
    let wifiData = null;
    
    if (testData && testData.metrics && testData.metrics.wifi_environment_data) {
        // Get the latest WiFi scan data
        const clientIds = Object.keys(testData.metrics.wifi_environment_data);
        for (const clientId of clientIds) {
            const clientData = testData.metrics.wifi_environment_data[clientId];
            if (clientData && clientData.length > 0) {
                // Get the most recent scan data
                const latestScan = clientData[clientData.length - 1];
                if (latestScan && latestScan.y) {
                    try {
                        wifiData = JSON.parse(latestScan.y);
                        break;
                    } catch (e) {
                        console.warn('Failed to parse WiFi environmental data:', e);
                    }
                }
            }
        }
    }
    
    if (!wifiData) {
        console.log('No WiFi environmental data found');
        return;
    }
    
    console.log('Found WiFi environmental data:', wifiData);
    
    // Display WiFi environmental analysis card
    document.getElementById('wifiEnvironmentCard').style.display = 'block';
    
    // Store complete WiFi data and networks for modals
    currentWifiData = wifiData;
    allWifiNetworks = wifiData.detected_networks || [];
    console.log('Storing networks for modal - count:', allWifiNetworks.length);
    console.log('Sample networks:', allWifiNetworks.slice(0, 3));
    console.log('Full network list length check:', allWifiNetworks.length, 'vs total networks:', wifiData.total_networks);
    
    // Update environment quality (fix property names)
    const quality = wifiData.environment_quality || 'Unknown';
    const pollutionScore = wifiData.wifi_pollution_score || 0;
    const qualityBadge = document.getElementById('wifiQualityBadge');
    const qualityDescription = document.getElementById('wifiQualityDescription');
    
    if (quality === 'Excellent') {
        qualityBadge.className = 'badge bg-success me-2';
        qualityDescription.textContent = 'Excellent WiFi environment with minimal interference';
    } else if (quality === 'Good') {
        qualityBadge.className = 'badge bg-success me-2';
        qualityDescription.textContent = 'Good WiFi environment with low interference';
    } else if (quality === 'Fair') {
        qualityBadge.className = 'badge bg-warning me-2';
        qualityDescription.textContent = 'Fair WiFi environment with moderate interference';
    } else if (quality === 'Poor') {
        qualityBadge.className = 'badge bg-danger me-2';
        qualityDescription.textContent = 'Poor WiFi environment with high interference';
    } else {
        qualityBadge.className = 'badge bg-secondary me-2';
        qualityDescription.textContent = 'WiFi environment quality assessment';
    }
    
    qualityBadge.textContent = quality;
    
    // Update network count and pollution score (fix property names)
    const totalNetworks = wifiData.total_networks || 0;
    const detectedNetworks = (wifiData.detected_networks || []).length;
    document.getElementById('wifiNetworkCount').textContent = totalNetworks;
    document.getElementById('totalNetworksCount').textContent = detectedNetworks;
    console.log('Total networks:', totalNetworks, 'Detected networks stored:', detectedNetworks);
    document.getElementById('wifiPollutionScore').textContent = (wifiData.wifi_pollution_score || 0).toFixed(1);
    
    // Update pollution score badge with color coding
    const pollutionBadge = document.getElementById('wifiPollutionBadge');
    let pollutionClass = 'bg-success';
    let pollutionText = 'Excellent';
    
    if (pollutionScore > 75) {
        pollutionClass = 'bg-danger';
        pollutionText = 'Poor';
    } else if (pollutionScore > 50) {
        pollutionClass = 'bg-warning';
        pollutionText = 'Fair';
    } else if (pollutionScore > 25) {
        pollutionClass = 'bg-primary';
        pollutionText = 'Good';
    }
    
    pollutionBadge.className = `badge ${pollutionClass}`;
    pollutionBadge.textContent = pollutionText;
    
    // Update signal quality distribution (fix property names)  
    const networks = wifiData.detected_networks || [];
    let strongSignals = 0;
    let weakSignals = 0;
    let totalSignal = 0;
    
    networks.forEach(network => {
        const signal = network.signal_strength || 0;
        totalSignal += signal;
        if (signal > -50) {
            strongSignals++;
        } else if (signal < -70) {
            weakSignals++;
        }
    });
    
    document.getElementById('wifiStrongSignals').textContent = strongSignals;
    document.getElementById('wifiWeakSignals').textContent = weakSignals;
    document.getElementById('wifiAvgSignal').textContent = networks.length > 0 ? 
        (totalSignal / networks.length).toFixed(0) : '0';
    
    // Update channel distribution and find most congested channel
    let ghz24Count = 0;
    let ghz5Count = 0;
    const channelCounts = {};
    
    networks.forEach(network => {
        const frequency = network.frequency || 0;
        const channel = network.channel;
        
        // Count frequency bands
        if (frequency < 3000) {
            ghz24Count++;
        } else {
            ghz5Count++;
        }
        
        // Count networks per channel
        if (channel && channel !== 'N/A') {
            channelCounts[channel] = (channelCounts[channel] || 0) + 1;
        }
    });
    
    document.getElementById('wifi24GhzCount').textContent = ghz24Count;
    document.getElementById('wifi5GhzCount').textContent = ghz5Count;
    
    // Find and display most congested channel
    let mostCongestedChannel = 'None';
    let maxNetworks = 0;
    
    for (const [channel, count] of Object.entries(channelCounts)) {
        if (count > maxNetworks) {
            maxNetworks = count;
            mostCongestedChannel = channel;
        }
    }
    
    // Only show congestion if there are at least 2 networks on the same channel
    if (maxNetworks >= 2) {
        document.getElementById('wifiCongestedChannel').textContent = mostCongestedChannel;
        document.getElementById('wifiCongestionCount').textContent = maxNetworks;
    } else {
        document.getElementById('wifiCongestedChannel').textContent = 'None';
        document.getElementById('wifiCongestionCount').textContent = 'No congestion detected';
    }

    
    // Update Advanced RF Analysis (if available)
    if (wifiData.rf_analysis) {
        displayAdvancedRFAnalysis(wifiData.rf_analysis);
    }
    
    // Update networks table (top 10 by signal strength)
    const sortedNetworks = networks.sort((a, b) => (b.signal_strength || 0) - (a.signal_strength || 0)).slice(0, 10);
    const tableBody = document.getElementById('wifiNetworksTable');
    
    if (sortedNetworks.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No WiFi networks detected</td></tr>';
    } else {
        tableBody.innerHTML = sortedNetworks.map(network => `
            <tr>
                <td>${network.ssid || 'Hidden'}</td>
                <td>${network.channel || 'N/A'}</td>
                <td>${network.signal_strength || 'N/A'} dBm</td>
                <td>${network.frequency || 'N/A'}</td>
                <td>${network.encrypted ? 'Encrypted' : 'Open'}</td>
            </tr>
        `).join('');
    }
}

// Global variables to store WiFi data for modals
let allWifiNetworks = [];
let currentWifiData = null;

// Function to display Advanced RF Analysis data
function displayAdvancedRFAnalysis(rfAnalysis) {
    console.log('Displaying Advanced RF Analysis:', rfAnalysis);
    
    // Show the Advanced RF Analysis section
    document.getElementById('advancedRFSection').style.display = 'block';
    
    // Update noise floor information
    const noiseFloor = rfAnalysis.noise_floor || {};
    document.getElementById('rfNoiseFloor').textContent = 
        `${noiseFloor.avg_noise_floor || -95} dBm`;
    document.getElementById('rfNoiseMethod').textContent = 
        noiseFloor.measurement_method === 'survey_dump' ? 'Measured' : 'Estimated';
    
    // Update SNR information
    const snrAnalysis = rfAnalysis.snr_analysis || {};
    document.getElementById('rfAvgSNR').textContent = 
        `${snrAnalysis.avg_snr || 0} dB`;
    document.getElementById('rfPoorSNR').textContent = 
        `${snrAnalysis.poor_snr_count || 0} poor connections`;
    
    // Update interference information
    const interferenceAnalysis = rfAnalysis.interference_analysis || {};
    document.getElementById('rfInterferenceLevel').textContent = 
        interferenceAnalysis.interference_level || 'Unknown';
    document.getElementById('rfInterferenceScore').textContent = 
        `${interferenceAnalysis.total_interference_sources || 0} sources`;
    
    // Update RF Quality Score
    const rfQualityScore = rfAnalysis.rf_quality_score || 50;
    document.getElementById('rfQualityScore').textContent = rfQualityScore;
    
    // Update Channel Utilization
    const channelUtilization = rfAnalysis.channel_utilization || {};
    const channelUtilizationContainer = document.getElementById('channelUtilizationCards');
    
    if (Object.keys(channelUtilization).length > 0) {
        const channelCards = Object.entries(channelUtilization)
            .sort(([,a], [,b]) => (b.utilization_estimate || 0) - (a.utilization_estimate || 0))
            .slice(0, 8) // Show top 8 channels
            .map(([channel, data]) => `
                <div class="col-md-3 mb-2">
                    <div class="text-center p-2 border rounded">
                        <div class="fw-bold text-warning">Ch ${channel}</div>
                        <div class="small text-muted">${data.utilization_estimate || 0}% used</div>
                        <div class="small text-info">
                            <a href="#" class="text-decoration-none text-info channel-link" onclick="showChannelNetworks(${channel}); return false;" 
                               style="cursor: pointer; border-bottom: 1px dotted #0dcaf0;" 
                               onmouseover="this.style.color='#0d6efd'; this.style.borderBottom='1px dotted #0d6efd';" 
                               onmouseout="this.style.color='#0dcaf0'; this.style.borderBottom='1px dotted #0dcaf0';">
                                ${data.network_count || 0} networks
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        
        channelUtilizationContainer.innerHTML = channelCards;
    } else {
        channelUtilizationContainer.innerHTML = '<div class="col-12 text-center text-muted"><small>No channel utilization data available</small></div>';
    }
    
    // Update interference sources with color-coded badges
    const interferenceTypes = interferenceAnalysis.interference_types || {};
    
    // WiFi Congestion
    const wifiCongestion = Math.round(interferenceTypes.wifi_congestion || 0);
    document.getElementById('wifiCongestionInterference').textContent = wifiCongestion;
    updateInterferenceBadge('wifiCongestionBadge', wifiCongestion, [2, 5]); // Good: 0-2, Moderate: 3-5, High: 6+
    
    // Bluetooth
    const bluetooth = Math.round(interferenceTypes.bluetooth_interference || 0);
    document.getElementById('bluetoothInterference').textContent = bluetooth;
    updateInterferenceBadge('bluetoothBadge', bluetooth, [1, 3]); // Good: 0-1, Moderate: 2-3, High: 4+
    
    // Microwave
    const microwave = Math.round(interferenceTypes.microwave_interference || 0);
    document.getElementById('microwaveInterference').textContent = microwave;
    updateInterferenceBadge('microwaveBadge', microwave, [0, 1]); // Good: 0, Moderate: 1, High: 2+
    
    // Other RF
    const otherRF = Math.round(interferenceTypes.other_rf_sources || 0);
    document.getElementById('otherRFInterference').textContent = otherRF;
    updateInterferenceBadge('otherRFBadge', otherRF, [1, 3]); // Good: 0-1, Moderate: 2-3, High: 4+
    
    console.log('Advanced RF Analysis display completed');
}

// Function to show all networks modal
function showAllNetworks() {
    console.log('showAllNetworks called - allWifiNetworks length:', allWifiNetworks.length);
    console.log('allWifiNetworks sample:', allWifiNetworks.slice(0, 5));
    
    const modal = new bootstrap.Modal(document.getElementById('allNetworksModal'));
    const tableBody = document.getElementById('allNetworksTable');
    
    if (allWifiNetworks.length === 0) {
        console.log('No WiFi networks available for modal');
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No WiFi networks detected</td></tr>';
    } else {
        // Sort all networks by signal strength (strongest first)
        const sortedNetworks = allWifiNetworks.sort((a, b) => (b.signal_strength || -100) - (a.signal_strength || -100));
        console.log('Sorted networks for modal:', sortedNetworks.length);
        
        tableBody.innerHTML = sortedNetworks.map((network, index) => `
            <tr>
                <td>
                    ${network.ssid || 'Hidden'}
                    ${index < 10 ? '<span class="badge bg-primary ms-2">Top 10</span>' : ''}
                </td>
                <td>${network.channel || 'N/A'}</td>
                <td>${network.signal_strength || 'N/A'} dBm</td>
                <td>${network.frequency || 'N/A'}</td>
                <td>${network.encrypted ? 'Encrypted' : 'Open'}</td>
            </tr>
        `).join('');
        
        console.log('Modal table updated with', sortedNetworks.length, 'networks');
        console.log('First 5 networks in modal:', sortedNetworks.slice(0, 5).map(n => n.ssid || 'Hidden'));
        console.log('Last 5 networks in modal:', sortedNetworks.slice(-5).map(n => n.ssid || 'Hidden'));
        
        // Update modal footer count
        document.getElementById('modalNetworkCount').textContent = sortedNetworks.length;
    }
    
    modal.show();
}

function showChannelNetworks(channel) {
    console.log('showChannelNetworks called for channel:', channel);
    console.log('allWifiNetworks available:', allWifiNetworks.length);
    
    const modal = new bootstrap.Modal(document.getElementById('channelNetworksModal'));
    
    // Update modal title
    document.getElementById('channelNumber').textContent = channel;
    
    // Filter networks for this channel
    const channelNetworks = allWifiNetworks.filter(network => network.channel === channel);
    console.log('Networks found for channel', channel, ':', channelNetworks.length);
    
    const tableBody = document.getElementById('channelNetworksTable');
    
    if (channelNetworks.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No networks found on this channel</td></tr>';
        document.getElementById('channelModalNetworkCount').textContent = '0';
    } else {
        // Sort by signal strength (strongest first)
        const sortedNetworks = channelNetworks.sort((a, b) => (b.signal_strength || -100) - (a.signal_strength || -100));
        
        tableBody.innerHTML = sortedNetworks.map((network, index) => `
            <tr>
                <td>
                    ${network.ssid || 'Hidden Network'}
                    ${index < 3 ? '<span class="badge bg-success ms-2">Strongest</span>' : ''}
                </td>
                <td>${network.signal_strength || 'N/A'}</td>
                <td>${network.frequency || 'N/A'}</td>
                <td>${network.encrypted ? 'Encrypted' : 'Open'}</td>
            </tr>
        `).join('');
        
        document.getElementById('channelModalNetworkCount').textContent = sortedNetworks.length;
        
        console.log('Channel', channel, 'networks:', sortedNetworks.map(n => n.ssid || 'Hidden'));
    }
    
    modal.show();
}

function updateInterferenceBadge(badgeId, value, thresholds) {
    const badge = document.getElementById(badgeId);
    const [goodMax, moderateMax] = thresholds;
    
    if (value <= goodMax) {
        badge.textContent = 'Good';
        badge.className = 'badge bg-success';
    } else if (value <= moderateMax) {
        badge.textContent = 'Moderate';
        badge.className = 'badge bg-warning';
    } else {
        badge.textContent = 'High';
        badge.className = 'badge bg-danger';
    }
}

function showInterferenceDetails(interferenceType) {
    console.log('showInterferenceDetails called for:', interferenceType);
    console.log('allWifiNetworks available:', allWifiNetworks.length);
    
    const modal = new bootstrap.Modal(document.getElementById('interferenceDetailsModal'));
    const titleElement = document.getElementById('interferenceTypeTitle');
    const contentElement = document.getElementById('interferenceDetailsContent');
    const countElement = document.getElementById('interferenceDetailsCount');
    
    // Update modal title
    const titles = {
        'wifi': 'WiFi Congestion Details',
        'bluetooth': 'Bluetooth Interference Details',
        'microwave': 'Microwave Interference Details',
        'other_rf': 'Other RF Interference Details'
    };
    titleElement.textContent = titles[interferenceType] || 'Interference Details';
    
    // Generate content based on interference type
    if (interferenceType === 'wifi') {
        showWifiCongestionDetails(contentElement, countElement);
    } else if (interferenceType === 'bluetooth') {
        showBluetoothDetails(contentElement, countElement);
    } else if (interferenceType === 'microwave') {
        showMicrowaveDetails(contentElement, countElement);
    } else if (interferenceType === 'other_rf') {
        showOtherRFDetails(contentElement, countElement);
    }
    
    modal.show();
}

function showWiFiCongestionDetails(contentElement, countElement) {
    if (!allWifiNetworks || allWifiNetworks.length === 0) {
        contentElement.innerHTML = '<div class="text-center text-muted">No WiFi networks detected</div>';
        countElement.textContent = 'No congestion data available';
        return;
    }
    
    // Group networks by channel to show congestion
    const channelGroups = {};
    allWifiNetworks.forEach(network => {
        const channel = network.channel || 'Unknown';
        if (!channelGroups[channel]) {
            channelGroups[channel] = [];
        }
        channelGroups[channel].push(network);
    });
    
    // Sort channels by number of networks (most congested first)
    const sortedChannels = Object.entries(channelGroups)
        .sort(([,a], [,b]) => b.length - a.length)
        .filter(([,networks]) => networks.length > 1); // Only show channels with multiple networks
    
    if (sortedChannels.length === 0) {
        contentElement.innerHTML = '<div class="text-center text-muted">No channel congestion detected - all networks are on separate channels</div>';
        countElement.textContent = 'No congestion issues found';
        return;
    }
    
    let html = '<div class="row">';
    sortedChannels.forEach(([channel, networks]) => {
        const congestionLevel = networks.length >= 6 ? 'High' : networks.length >= 3 ? 'Moderate' : 'Low';
        const badgeClass = networks.length >= 6 ? 'bg-danger' : networks.length >= 3 ? 'bg-warning' : 'bg-success';
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card bg-dark text-white">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Channel ${channel}</h6>
                        <span class="badge ${badgeClass}">${congestionLevel}</span>
                    </div>
                    <div class="card-body">
                        <div class="small text-muted mb-2">${networks.length} competing networks:</div>
                        <div class="list-group list-group-flush">
                            ${networks.slice(0, 5).map(network => `
                                <div class="list-group-item bg-transparent border-0 py-1 px-0">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-light">${network.ssid || 'Hidden Network'}</span>
                                        <span class="text-muted">${network.signal_strength || 'N/A'} dBm</span>
                                    </div>
                                </div>
                            `).join('')}
                            ${networks.length > 5 ? `<div class="small text-muted">... and ${networks.length - 5} more</div>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    contentElement.innerHTML = html;
    countElement.textContent = `${sortedChannels.length} congested channels detected`;
}

function showWifiCongestionDetails(contentElement, countElement) {
    // Access the global currentWifiData that's already loaded
    const rfAnalysis = currentWifiData?.rf_analysis;
    const wifiCongestionDetails = rfAnalysis?.interference_analysis?.interference_details?.wifi_congestion_details;
    
    // Fallback to existing channel utilization data if detailed data isn't available
    const channelUtilization = rfAnalysis?.channel_utilization;
    const detectedNetworks = currentWifiData?.detected_networks || [];
    
    if (wifiCongestionDetails && wifiCongestionDetails.length > 0) {
        // Use new detailed data structure
        const sortedChannels = wifiCongestionDetails.sort((a, b) => b.network_count - a.network_count);
        
        let html = '<div class="row">';
        html += `
            <div class="col-12">
                <h6 class="text-warning">WiFi Channel Congestion Analysis</h6>
                <div class="list-group">
                    ${sortedChannels.map(channel => `
                        <div class="list-group-item bg-dark text-white border-secondary">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">Channel ${channel.channel}</h6>
                                    <p class="mb-1">${channel.network_count} competing networks</p>
                                    <p class="mb-1">Strongest Signal: ${channel.strongest_signal} dBm</p>
                                    <small class="text-muted">Congestion Level: ${channel.congestion_level}</small>
                                    ${channel.networks && channel.networks.length > 0 ? `
                                        <div class="mt-2">
                                            <small class="text-info">Networks on this channel:</small>
                                            ${channel.networks.map(network => `
                                                <div class="ms-2 small">
                                                    <span class="text-light">${network.ssid || 'Hidden'}</span> - 
                                                    <span class="text-muted">${network.signal || -100} dBm</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <span class="badge bg-${channel.congestion_level === 'High' ? 'danger' : 
                                    channel.congestion_level === 'Moderate' ? 'warning' : 
                                    channel.congestion_level === 'Non-standard channel' ? 'info' : 'secondary'}">${channel.congestion_level}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        html += '</div>';
        
        contentElement.innerHTML = html;
        countElement.textContent = `${sortedChannels.length} congested channels detected`;
        
    } else if (channelUtilization && Object.keys(channelUtilization).length > 0) {
        // Fallback to existing channel utilization data
        const channelGroups = {};
        detectedNetworks.forEach(network => {
            const channel = network.channel || 'Unknown';
            if (!channelGroups[channel]) {
                channelGroups[channel] = [];
            }
            channelGroups[channel].push(network);
        });
        
        const sortedChannels = Object.entries(channelGroups)
            .sort(([,a], [,b]) => b.length - a.length)
            .filter(([,networks]) => networks.length > 1);
        
        if (sortedChannels.length === 0) {
            contentElement.innerHTML = '<div class="text-center text-muted">No channel congestion detected - all networks are on separate channels</div>';
            countElement.textContent = 'No congestion issues found';
            return;
        }
        
        let html = '<div class="row">';
        html += `
            <div class="col-12">
                <h6 class="text-warning">WiFi Channel Congestion Analysis</h6>
                <div class="list-group">
                    ${sortedChannels.map(([channel, networks]) => {
                        const congestionLevel = networks.length >= 6 ? 'High' : networks.length >= 3 ? 'Moderate' : 'Low';
                        const strongestSignal = Math.max(...networks.map(n => n.signal_strength || -100));
                        return `
                            <div class="list-group-item bg-dark text-white border-secondary">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">Channel ${channel}</h6>
                                        <p class="mb-1">${networks.length} competing networks</p>
                                        <p class="mb-1">Strongest Signal: ${strongestSignal} dBm</p>
                                        <small class="text-muted">Congestion Level: ${congestionLevel}</small>
                                        <div class="mt-2">
                                            <small class="text-info">Networks on this channel:</small>
                                            ${networks.map(network => `
                                                <div class="ms-2 small">
                                                    <span class="text-light">${network.ssid || 'Hidden'}</span> - 
                                                    <span class="text-muted">${network.signal_strength || -100} dBm</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <span class="badge bg-${congestionLevel === 'High' ? 'danger' : 
                                        congestionLevel === 'Moderate' ? 'warning' : 'secondary'}">${congestionLevel}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        html += '</div>';
        
        contentElement.innerHTML = html;
        countElement.textContent = `${sortedChannels.length} congested channels detected`;
        
    } else {
        contentElement.innerHTML = '<div class="text-center text-muted">No WiFi congestion data available</div>';
        countElement.textContent = 'No congestion analysis available';
    }
}

function showBluetoothDetails(contentElement, countElement) {
    // Access the global currentWifiData that's already loaded
    const rfAnalysis = currentWifiData?.rf_analysis;
    const bluetoothDetails = rfAnalysis?.interference_analysis?.interference_details?.bluetooth_details;
    
    // Check for existing interference count as fallback
    const bluetoothCount = rfAnalysis?.interference_analysis?.interference_types?.bluetooth_interference || 0;
    
    if (!bluetoothDetails || bluetoothDetails.length === 0) {
        // Fallback to basic analysis if no detailed data
        if (bluetoothCount > 0) {
            contentElement.innerHTML = `
                <div class="text-center text-muted">
                    <p>Bluetooth interference detected: ${bluetoothCount} potential sources</p>
                    <p>Detailed pattern analysis not available in this scan.</p>
                    <p>Run a new WiFi environmental scan with updated client for detailed interference patterns.</p>
                </div>
            `;
            countElement.textContent = `${bluetoothCount} Bluetooth interference sources detected`;
        } else {
            contentElement.innerHTML = '<div class="text-center text-muted">No Bluetooth interference detected in this scan</div>';
            countElement.textContent = 'No Bluetooth interference detected';
        }
        return;
    }
    
    let html = '<div class="row">';
    
    // Display detected Bluetooth interference patterns
    html += `
        <div class="col-12 mb-3">
            <h6 class="text-warning">Detected Bluetooth Interference Patterns</h6>
            <div class="list-group">
                ${bluetoothDetails.map(detail => `
                    <div class="list-group-item bg-dark text-white border-secondary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${detail.interference_type}</h6>
                                <p class="mb-1">Frequency Range: ${detail.frequency_range}</p>
                                <p class="mb-1">Affected Networks: ${detail.affected_networks}</p>
                                <small class="text-muted">Impact: ${detail.impact}</small>
                                ${detail.networks && detail.networks.length > 0 ? `
                                    <div class="mt-2">
                                        <small class="text-info">Affected Networks:</small>
                                        ${detail.networks.map(network => `
                                            <div class="ms-2 small">
                                                <span class="text-light">${network.ssid}</span> - 
                                                <span class="text-muted">Ch ${network.channel}, ${network.signal} dBm</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <small class="text-info">${detail.frequency_range}</small>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // Add common Bluetooth interference information
    const bluetoothPatterns = [
        {
            type: 'Bluetooth Classic (BR/EDR)',
            details: 'Frequency hopping across 2.4GHz band (79 channels)',
            frequency: '2.402-2.480 GHz',
            impact: 'Can interfere with WiFi channels 1-11',
            devices: 'Headphones, speakers, keyboards, mice'
        },
        {
            type: 'Bluetooth Low Energy (BLE)',
            details: 'Uses 40 channels in 2.4GHz band',
            frequency: '2.402-2.480 GHz', 
            impact: 'Generally less interference than Classic',
            devices: 'Smartwatches, fitness trackers, IoT devices'
        }
    ];
    
    html += `
        <div class="col-12">
            <h6 class="text-info">Bluetooth Technology Overview</h6>
            <div class="list-group">
                ${bluetoothPatterns.map(pattern => `
                    <div class="list-group-item bg-dark text-white border-secondary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${pattern.type}</h6>
                                <p class="mb-1">${pattern.details}</p>
                                <small class="text-muted">Impact: ${pattern.impact}</small>
                                <br><small class="text-info">Common devices: ${pattern.devices}</small>
                            </div>
                            <small class="text-info">${pattern.frequency}</small>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    html += '</div>';
    
    contentElement.innerHTML = html;
    countElement.textContent = `${bluetoothDetails.length} specific Bluetooth interference patterns detected`;
}

function showMicrowaveDetails(contentElement, countElement) {
    // Access the global currentWifiData that's already loaded
    const rfAnalysis = currentWifiData?.rf_analysis;
    const microwaveDetails = rfAnalysis?.interference_analysis?.interference_details?.microwave_details;
    const microwaveCount = rfAnalysis?.interference_analysis?.interference_types?.microwave_interference || 0;
    
    if (!microwaveDetails || microwaveDetails.length === 0) {
        // Fallback to basic analysis if no detailed data
        if (microwaveCount > 0) {
            contentElement.innerHTML = `
                <div class="text-center text-muted">
                    <p>Microwave interference detected: ${microwaveCount} potential sources</p>
                    <p>Detailed pattern analysis not available in this scan.</p>
                    <p>Run a new WiFi environmental scan with updated client for detailed interference patterns.</p>
                </div>
            `;
            countElement.textContent = `${microwaveCount} microwave interference sources detected`;
        } else {
            contentElement.innerHTML = '<div class="text-center text-muted">No microwave interference detected in this scan</div>';
            countElement.textContent = 'No microwave interference detected';
        }
        return;
    }
    
    let html = '<div class="row">';
    
    // Display detected microwave interference patterns
    html += `
        <div class="col-12 mb-3">
            <h6 class="text-danger">Detected Microwave Interference Patterns</h6>
            <div class="alert alert-warning" style="background-color: #2d1b0e; border-color: #664d03;">
                <div class="text-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Microwave interference detected in 2.45GHz band (WiFi channels 6-11)
                </div>
            </div>
            <div class="list-group">
                ${microwaveDetails.map(detail => `
                    <div class="list-group-item bg-dark text-white border-secondary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${detail.interference_type}</h6>
                                <p class="mb-1">Frequency Range: ${detail.frequency_range}</p>
                                <p class="mb-1">Affected Channels: ${detail.affected_channels ? detail.affected_channels.join(', ') : 'Multiple'}</p>
                                <small class="text-muted">Impact: ${detail.impact}</small>
                                <br><small class="text-muted">Distance Estimate: ${detail.distance_estimate}</small>
                                ${detail.networks && detail.networks.length > 0 ? `
                                    <div class="mt-2">
                                        <small class="text-info">Affected Networks:</small>
                                        ${detail.networks.map(network => `
                                            <div class="ms-2 small">
                                                <span class="text-light">${network.ssid || 'Hidden'}</span> - 
                                                <span class="text-muted">Ch ${network.channel}, ${network.signal} dBm</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <span class="badge bg-warning">${detail.interference_type.includes('Industrial') ? 'Industrial' : 'Consumer'}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // Extract affected channels from microwave details
    const affectedChannels = [];
    if (microwaveDetails && microwaveDetails.length > 0) {
        microwaveDetails.forEach(detail => {
            if (detail.affected_channels) {
                detail.affected_channels.forEach(channel => {
                    if (!affectedChannels.includes(channel)) {
                        affectedChannels.push(channel);
                    }
                });
            }
        });
    }
    
    // Add general microwave interference information
    const microwaveInfo = [
        {
            type: 'Consumer Microwave Ovens',
            frequency: '2.45 GHz (ISM Band)',
            details: 'Operates at same frequency as WiFi channels 6-11',
            impact: 'Can cause complete signal loss when active',
            distance: 'Effective up to 10-15 feet from microwave'
        },
        {
            type: 'Industrial Microwave Equipment',
            frequency: '2.4-2.5 GHz',
            details: 'Higher power than consumer microwaves',
            impact: 'Can affect wider frequency range',
            distance: 'Effective up to 30-50 feet from source'
        }
    ];
    
    html += `
        <div class="col-12">
            <h6 class="text-info">Microwave Interference Overview</h6>
            <div class="list-group">
                ${microwaveInfo.map(info => `
                    <div class="list-group-item bg-dark text-white border-secondary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${info.type}</h6>
                                <p class="mb-1">${info.details}</p>
                                <small class="text-muted">Impact: ${info.impact}</small>
                                <br><small class="text-muted">Range: ${info.distance}</small>
                            </div>
                            <small class="text-info">${info.frequency}</small>
                        </div>
                    </div>
                `).join('')}
            </div>
            ${affectedChannels.length > 0 ? `
                <div class="mt-3">
                    <h6 class="text-warning">Potentially Affected Channels</h6>
                    <div class="d-flex flex-wrap gap-2">
                        ${affectedChannels.map(channel => `
                            <span class="badge bg-warning text-dark">Channel ${channel}</span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    html += '</div>';
    
    contentElement.innerHTML = html;
    countElement.textContent = `${microwaveDetails.length} specific microwave interference patterns detected`;
}

function showOtherRFDetails(contentElement, countElement) {
    // Access the global currentWifiData that's already loaded
    const rfAnalysis = currentWifiData?.rf_analysis;
    const otherRFDetails = rfAnalysis?.interference_analysis?.interference_details?.other_rf_details;
    const otherRFCount = rfAnalysis?.interference_analysis?.interference_types?.other_rf_sources || 0;
    
    if (!otherRFDetails || otherRFDetails.length === 0) {
        // Fallback to basic analysis if no detailed data
        if (otherRFCount > 0) {
            contentElement.innerHTML = `
                <div class="text-center text-muted">
                    <p>Other RF interference detected: ${otherRFCount} potential sources</p>
                    <p>Detailed pattern analysis not available in this scan.</p>
                    <p>Run a new WiFi environmental scan with updated client for detailed interference patterns.</p>
                </div>
            `;
            countElement.textContent = `${otherRFCount} other RF interference sources detected`;
        } else {
            contentElement.innerHTML = '<div class="text-center text-muted">No other RF interference detected in this scan</div>';
            countElement.textContent = 'No other RF interference detected';
        }
        return;
    }
    
    let html = '<div class="row">';
    
    // Display detected RF interference patterns
    html += `
        <div class="col-12 mb-3">
            <h6 class="text-primary">Detected RF Interference Sources</h6>
            <div class="list-group">
                ${otherRFDetails.map(detail => `
                    <div class="list-group-item bg-dark text-white border-secondary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${detail.frequency_range} Band Analysis</h6>
                                <p class="mb-1">Networks Detected: ${detail.network_count}</p>
                                <p class="mb-1">Signal Variance: ${detail.signal_variance}</p>
                                <small class="text-muted">Impact: ${detail.impact}</small>
                                <br><small class="text-muted">Distance Estimate: ${detail.distance_estimate}</small>
                                ${detail.potential_sources && detail.potential_sources.length > 0 ? `
                                    <div class="mt-2">
                                        <small class="text-info">Potential RF Sources:</small>
                                        <div class="ms-2 small">
                                            ${detail.potential_sources.map(source => `
                                                <span class="badge bg-secondary me-1">${source}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <span class="badge bg-info">${detail.frequency_range}</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // Add common RF interference sources reference
    const commonRFSources = [
        {
            type: 'Cordless Phones (DECT)',
            frequency: '2.4 GHz',
            details: 'DECT phones can interfere with WiFi channels 1-6',
            impact: 'Intermittent interference during calls',
            distance: '10-30 feet from base station'
        },
        {
            type: 'Baby Monitors',
            frequency: '2.4 GHz / 5.8 GHz',
            details: 'Video baby monitors often use WiFi frequencies',
            impact: 'Continuous interference when active',
            distance: '20-50 feet from monitor'
        },
        {
            type: 'Wireless Security Cameras',
            frequency: '2.4 GHz / 5 GHz',
            details: 'Constant transmission can saturate channels',
            impact: 'High bandwidth usage, channel congestion',
            distance: '50-100 feet from camera'
        },
        {
            type: 'RC/Drone Controllers',
            frequency: '2.4 GHz / 5.8 GHz',
            details: 'Remote control devices using same frequencies',
            impact: 'Burst interference during operation',
            distance: '100-500 feet from controller'
        },
        {
            type: 'Amateur Radio',
            frequency: '2.3-2.45 GHz',
            details: 'Licensed ham radio operations',
            impact: 'High power can cause wide-area interference',
            distance: '0.5-2 miles from transmitter'
        }
    ];
    
    html += `
        <div class="col-12">
            <h6 class="text-info">Common RF Interference Sources</h6>
            <div class="list-group">
                ${commonRFSources.map(source => `
                    <div class="list-group-item bg-dark text-white border-secondary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${source.type}</h6>
                                <p class="mb-1">${source.details}</p>
                                <small class="text-muted">Impact: ${source.impact}</small>
                                <br><small class="text-muted">Range: ${source.distance}</small>
                            </div>
                            <small class="text-info">${source.frequency}</small>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    html += '</div>';
    
    contentElement.innerHTML = html;
    countElement.textContent = `${otherRFDetails.length} RF interference patterns detected`;
}

function displayVoIPAnalysis() {
    console.log('Checking for VoIP analysis data...');
    
    // Check if this is a VoIP test by looking for VoIP-specific metrics
    const isVoipTest = {{ 'true' if is_voip_only else 'false' }};
    if (!isVoipTest) {
        console.log('Not a VoIP test - skipping VoIP analysis');
        return;
    }
    
    // Check if any test results contain VoIP analysis data
    let voipData = null;
    
    if (testData && testData.metrics && testData.metrics.voip_analysis_data) {
        // Get the latest VoIP analysis data
        const clientIds = Object.keys(testData.metrics.voip_analysis_data);
        for (const clientId of clientIds) {
            const clientData = testData.metrics.voip_analysis_data[clientId];
            if (clientData && clientData.length > 0) {
                // Get the most recent analysis data
                const latestAnalysis = clientData[clientData.length - 1];
                if (latestAnalysis && latestAnalysis.y) {
                    try {
                        voipData = JSON.parse(latestAnalysis.y);
                        break;
                    } catch (e) {
                        console.warn('Failed to parse VoIP analysis data:', e);
                    }
                }
            }
        }
    }
    
    if (!voipData) {
        console.log('No VoIP analysis data found');
        return;
    }
    
    console.log('VoIP analysis data found:', voipData);
    
    // Show the VoIP analysis card
    document.getElementById('voipAnalysisCard').style.display = 'block';
    
    // Update VoIP summary cards
    updateVoIPSummaryCards();
    
    // Display VoIP analysis data
    const mosScore = voipData.analysis_summary?.mos_score || 0;
    const voiceQuality = voipData.analysis_summary?.voice_quality_score || 0;
    const sipRegistration = voipData.sip_registration_time || 0;
    const sipCallSetup = voipData.sip_call_setup_time || 0;
    const rtpJitter = voipData.rtp_jitter || 0;
    const rtpPacketLoss = voipData.rtp_packet_loss || 0;
    
    // Update VoIP metrics display
    document.getElementById('voipMOSScore').textContent = mosScore.toFixed(1);
    document.getElementById('voipVoiceQuality').textContent = Math.round(voiceQuality);
    document.getElementById('voipSIPRegistration').textContent = (sipRegistration * 1000).toFixed(0) + 'ms';
    document.getElementById('voipSIPCallSetup').textContent = (sipCallSetup * 1000).toFixed(0) + 'ms';
    document.getElementById('voipRTPJitter').textContent = rtpJitter.toFixed(1) + 'ms';
    document.getElementById('voipRTPPacketLoss').textContent = rtpPacketLoss.toFixed(1) + '%';
    
    // Update badges based on quality thresholds
    updateVoIPBadges(mosScore, voiceQuality, sipRegistration * 1000, sipCallSetup * 1000, rtpJitter, rtpPacketLoss);
    
    // Populate VoIP metrics table
    populateVoIPMetricsTable(voipData);
}

function updateVoIPSummaryCards() {
    if (!testData || !testData.metrics) return;
    
    // Calculate averages from VoIP metrics
    const mosScores = [];
    const voiceQualityScores = [];
    
    if (testData.metrics.mos_score) {
        Object.values(testData.metrics.mos_score).forEach(clientData => {
            clientData.forEach(point => {
                if (point && point.y !== null && point.y !== undefined) {
                    mosScores.push(point.y);
                }
            });
        });
    }
    
    if (testData.metrics.voice_quality_score) {
        Object.values(testData.metrics.voice_quality_score).forEach(clientData => {
            clientData.forEach(point => {
                if (point && point.y !== null && point.y !== undefined) {
                    voiceQualityScores.push(point.y);
                }
            });
        });
    }
    
    // Update summary cards
    const avgMOS = mosScores.length > 0 ? mosScores.reduce((a, b) => a + b, 0) / mosScores.length : 0;
    const avgVoiceQuality = voiceQualityScores.length > 0 ? voiceQualityScores.reduce((a, b) => a + b, 0) / voiceQualityScores.length : 0;
    
    document.getElementById('avg-mos-score').textContent = avgMOS.toFixed(1);
    document.getElementById('avg-voice-quality').textContent = Math.round(avgVoiceQuality) + '%';
}

function updateVoIPBadges(mosScore, voiceQuality, sipRegistration, sipCallSetup, rtpJitter, rtpPacketLoss) {
    // MOS Score badge
    let mosBadge = 'bg-danger';
    if (mosScore >= 4.0) mosBadge = 'bg-success';
    else if (mosScore >= 3.0) mosBadge = 'bg-primary';
    else if (mosScore >= 2.0) mosBadge = 'bg-warning';
    
    document.getElementById('voipMOSBadge').className = `badge ${mosBadge}`;
    document.getElementById('voipMOSBadge').textContent = mosScore >= 4.0 ? 'Excellent' : mosScore >= 3.0 ? 'Good' : mosScore >= 2.0 ? 'Fair' : 'Poor';
    
    // Voice Quality badge
    let voiceQualityBadge = 'bg-danger';
    if (voiceQuality >= 80) voiceQualityBadge = 'bg-success';
    else if (voiceQuality >= 60) voiceQualityBadge = 'bg-primary';
    else if (voiceQuality >= 40) voiceQualityBadge = 'bg-warning';
    
    document.getElementById('voipVoiceQualityBadge').className = `badge ${voiceQualityBadge}`;
    document.getElementById('voipVoiceQualityBadge').textContent = voiceQuality >= 80 ? 'Excellent' : voiceQuality >= 60 ? 'Good' : voiceQuality >= 40 ? 'Fair' : 'Poor';
    
    // Overall quality badge
    let overallBadge = 'bg-danger';
    let overallText = 'Poor';
    if (mosScore >= 4.0 && voiceQuality >= 80) {
        overallBadge = 'bg-success';
        overallText = 'Excellent';
    } else if (mosScore >= 3.0 && voiceQuality >= 60) {
        overallBadge = 'bg-primary';
        overallText = 'Good';
    } else if (mosScore >= 2.0 && voiceQuality >= 40) {
        overallBadge = 'bg-warning';
        overallText = 'Fair';
    }
    
    document.getElementById('voipQualityBadge').className = `badge ${overallBadge} me-2`;
    document.getElementById('voipQualityBadge').textContent = overallText;
    
    // Update quality description
    const descriptions = {
        'Excellent': 'High-quality VoIP call with minimal impairment',
        'Good': 'Acceptable VoIP call quality with minor issues',
        'Fair': 'VoIP call quality with noticeable impairments',
        'Poor': 'VoIP call quality significantly degraded'
    };
    document.getElementById('voipQualityDescription').textContent = descriptions[overallText];
}

function populateVoIPMetricsTable(voipData) {
    const tableBody = document.getElementById('voipMetricsTable');
    tableBody.innerHTML = '';
    
    const metrics = [
        {
            name: 'MOS Score',
            value: (voipData.analysis_summary?.mos_score || 0).toFixed(1),
            getStatus: (val) => val >= 4.0 ? 'Excellent' : val >= 3.0 ? 'Good' : val >= 2.0 ? 'Fair' : 'Poor',
            getImpact: (val) => val >= 4.0 ? 'No impairment' : val >= 3.0 ? 'Minor impairment' : val >= 2.0 ? 'Noticeable impairment' : 'Significant impairment'
        },
        {
            name: 'Voice Quality Score',
            value: Math.round(voipData.analysis_summary?.voice_quality_score || 0) + '%',
            getStatus: (val) => val >= 80 ? 'Excellent' : val >= 60 ? 'Good' : val >= 40 ? 'Fair' : 'Poor',
            getImpact: (val) => val >= 80 ? 'Clear voice' : val >= 60 ? 'Good clarity' : val >= 40 ? 'Some distortion' : 'Poor clarity'
        },
        {
            name: 'SIP Registration Time',
            value: ((voipData.sip_registration_time || 0) * 1000).toFixed(0) + 'ms',
            getStatus: (val) => val < 1000 ? 'Excellent' : val < 3000 ? 'Good' : val < 5000 ? 'Fair' : 'Poor',
            getImpact: (val) => val < 1000 ? 'Fast registration' : val < 3000 ? 'Normal registration' : val < 5000 ? 'Slow registration' : 'Very slow registration'
        },
        {
            name: 'SIP Call Setup Time',
            value: ((voipData.sip_call_setup_time || 0) * 1000).toFixed(0) + 'ms',
            getStatus: (val) => val < 1000 ? 'Excellent' : val < 3000 ? 'Good' : val < 5000 ? 'Fair' : 'Poor',
            getImpact: (val) => val < 1000 ? 'Fast call setup' : val < 3000 ? 'Normal call setup' : val < 5000 ? 'Slow call setup' : 'Very slow call setup'
        },
        {
            name: 'RTP Jitter',
            value: (voipData.rtp_jitter || 0).toFixed(1) + 'ms',
            getStatus: (val) => val < 20 ? 'Excellent' : val < 40 ? 'Good' : val < 60 ? 'Fair' : 'Poor',
            getImpact: (val) => val < 20 ? 'Smooth audio' : val < 40 ? 'Minor audio variation' : val < 60 ? 'Noticeable audio variation' : 'Choppy audio'
        },
        {
            name: 'RTP Packet Loss',
            value: (voipData.rtp_packet_loss || 0).toFixed(1) + '%',
            getStatus: (val) => val < 0.5 ? 'Excellent' : val < 1.0 ? 'Good' : val < 2.0 ? 'Fair' : 'Poor',
            getImpact: (val) => val < 0.5 ? 'No audio loss' : val < 1.0 ? 'Minor audio loss' : val < 2.0 ? 'Noticeable audio loss' : 'Significant audio loss'
        }
    ];
    
    metrics.forEach(metric => {
        const numericValue = parseFloat(metric.value);
        const status = metric.getStatus(numericValue);
        const impact = metric.getImpact(numericValue);
        
        const statusBadge = status === 'Excellent' ? 'bg-success' : 
                           status === 'Good' ? 'bg-primary' : 
                           status === 'Fair' ? 'bg-warning' : 'bg-danger';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${metric.name}</td>
            <td>${metric.value}</td>
            <td><span class="badge ${statusBadge}">${status}</span></td>
            <td>${impact}</td>
        `;
        tableBody.appendChild(row);
    });
}
</script>
{% endblock %}
