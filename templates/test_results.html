{% extends "base.html" %}

{% block title %}Test Results - StreamSwarm{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-3">
                <i class="fas fa-chart-line me-2"></i>
                Test Results: {{ test.name }}
            </h1>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-{{ 'success' if test.status == 'completed' else 'warning' if test.status == 'running' else 'secondary' }} fs-6">
                    {{ test.status | title }}
                </span>
                <span class="text-muted">Destination: <code>{{ test.destination }}</code></span>
                <span class="text-muted">Duration: {{ test.duration // 60 }}m {{ test.duration % 60 }}s</span>
            </div>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                {% if test.status in ['completed', 'failed'] %}
                    <button class="btn btn-success" onclick="exportPDF({{ test.id }})">
                        <i class="fas fa-file-pdf me-1"></i> Export PDF Report
                    </button>
                {% endif %}
                <a href="{{ url_for('tests') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    Back to Tests
                </a>
            </div>
        </div>
    </div>

    <!-- Test Summary -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Participating Clients</h5>
                    <h2 class="text-info">{{ clients | length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Data Points</h5>
                    <h2 class="text-success" id="data-points">{{ results | length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Avg Latency</h5>
                    <h2 class="text-warning" id="avg-latency">--</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Packet Loss</h5>
                    <h2 class="text-danger" id="avg-packet-loss">--</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0" id="chart-title">
                            <i class="fas fa-chart-line me-2"></i>
                            Network Latency Over Time
                        </h5>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <span id="current-metric-label">Network Latency</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><h6 class="dropdown-header">Network Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ping_latency')">Network Latency</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ping_packet_loss')">Packet Loss</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('jitter')">Network Jitter</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('dns_resolution_time')">DNS Resolution Time</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('tcp_connect_time')">TCP Connect Time</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ssl_handshake_time')">SSL Handshake Time</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('ttfb')">Time to First Byte</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">System Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_load_1min')">CPU Load (1min)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_load_5min')">CPU Load (5min)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_load_15min')">CPU Load (15min)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_freq_current')">CPU Frequency</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_cores')">CPU Cores</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cpu_temperature')">CPU Temperature</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('process_count')">Process Count</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('tcp_connections')">TCP Connections</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Network Interface</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_bytes_sent')">Bytes Sent</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_bytes_recv')">Bytes Received</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_packets_sent')">Packets Sent</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_packets_recv')">Packets Received</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_errors_in')">Network Errors In</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_errors_out')">Network Errors Out</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_drops_in')">Network Drops In</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('network_drops_out')">Network Drops Out</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Storage Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_read_iops')">Disk Read IOPS</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_write_iops')">Disk Write IOPS</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_read_bytes_sec')">Disk Read Throughput</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('disk_write_bytes_sec')">Disk Write Throughput</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Bandwidth Performance</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('bandwidth_upload')">Upload Speed (Mbps)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('bandwidth_download')">Download Speed (Mbps)</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Quality of Service</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('dscp_value')">DSCP Values</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('cos_value')">CoS Values</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('qos_policy_compliant')">QoS Policy Compliance</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Memory Details</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('memory_available')">Memory Available</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('memory_cached')">Memory Cached</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('memory_buffers')">Memory Buffers</a></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('swap_percent')">Swap Usage</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">Advanced Network</h6></li>
                                <li><a class="dropdown-item" href="#" onclick="showMetric('traceroute_hops')">Traceroute Hops</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Pro Tip:</strong> Click on any data point in the chart to see detailed metrics and network path information for troubleshooting.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <div style="position: relative; height: 400px;">
                        <canvas id="networkChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-microchip me-2"></i>
                        CPU Usage
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="cpuChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-memory me-2"></i>
                        Memory Usage
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="memoryChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-hdd me-2"></i>
                        Disk Usage
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="diskChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Details -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-desktop me-2"></i>
                        Client Performance Summary
                    </h5>
                </div>
                <div class="card-body">
                    {% if clients %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Data Points</th>
                                    <th>Avg Latency</th>
                                    <th>Avg Packet Loss</th>
                                    <th>Avg CPU</th>
                                    <th>Avg Memory</th>
                                    <th>Avg Disk</th>
                                </tr>
                            </thead>
                            <tbody id="clientSummaryTable">
                                {% for client in clients %}
                                <tr>
                                    <td><strong>{{ client.hostname }}</strong></td>
                                    <td class="client-data-points" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-latency" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-packet-loss" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-cpu" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-memory" data-client="{{ client.id }}">--</td>
                                    <td class="client-avg-disk" data-client="{{ client.id }}">--</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No client data available for this test.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Process Monitoring -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        Process Monitoring Details
                    </h5>
                </div>
                <div class="card-body">
                    {% for result in test_results %}
                        {% if result.top_processes_cpu %}
                            {% set cpu_processes = result.top_processes_cpu | tojsonfilter %}
                            {% set mem_processes = result.top_processes_memory | tojsonfilter %}
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-microchip me-2"></i>Top Processes by CPU Usage
                                    </h6>
                                    {% for process in cpu_processes[:5] %}
                                        <div class="card mb-2">
                                            <div class="card-body py-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>{{ process.name }}</strong>
                                                        <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-primary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                        <span class="badge bg-secondary">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-success mb-3">
                                        <i class="fas fa-memory me-2"></i>Top Processes by Memory Usage
                                    </h6>
                                    {% for process in mem_processes[:5] %}
                                        <div class="card mb-2">
                                            <div class="card-body py-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>{{ process.name }}</strong>
                                                        <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-success">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                        <span class="badge bg-secondary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% break %}
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No detailed process monitoring data available for this test.
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comprehensive Metrics Analysis -->
    {% if test_results %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Comprehensive Metrics Analysis (65+ Metrics)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h6>Network Performance</h6>
                                    {% set avg_latency = test_results | map(attribute='ping_latency') | select('number') | list %}
                                    <p class="mb-1">Latency: {{ "%.1f"|format(avg_latency | average) if avg_latency else 'N/A' }}ms</p>
                                    {% set avg_bandwidth = test_results | map(attribute='bandwidth_download') | select('number') | list %}
                                    <p class="mb-0">Bandwidth: {{ "%.1f"|format(avg_bandwidth | average) if avg_bandwidth else 'N/A' }} Mbps</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h6>System Resources</h6>
                                    {% set avg_cpu = test_results | map(attribute='cpu_percent') | select('number') | list %}
                                    <p class="mb-1">CPU: {{ "%.1f"|format(avg_cpu | average) if avg_cpu else 'N/A' }}%</p>
                                    {% set avg_memory = test_results | map(attribute='memory_percent') | select('number') | list %}
                                    <p class="mb-0">Memory: {{ "%.1f"|format(avg_memory | average) if avg_memory else 'N/A' }}%</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body text-center">
                                    <h6>Quality of Service</h6>
                                    {% set dscp_vals = test_results | map(attribute='dscp_value') | select('number') | list %}
                                    <p class="mb-1">DSCP: {{ dscp_vals | first if dscp_vals else 'N/A' }}</p>
                                    {% set ecn_capable = test_results | selectattr('ecn_capable', 'equalto', true) | list %}
                                    <p class="mb-0">ECN: {{ 'Yes' if ecn_capable else 'No' }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h6>Infrastructure</h6>
                                    {% set power_vals = test_results | map(attribute='power_consumption_watts') | select('number') | list %}
                                    <p class="mb-1">Power: {{ "%.1f"|format(power_vals | average) if power_vals else 'N/A' }}W</p>
                                    {% set smart_health = test_results | selectattr('smart_drive_health') | list %}
                                    <p class="mb-0">Drives: {{ 'Healthy' if smart_health else 'N/A' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Metrics Tables -->
                    <div class="row">
                        <div class="col-12">
                            <div class="accordion" id="metricsAccordion">
                                <!-- Network Metrics -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#networkMetrics">
                                            <i class="fas fa-network-wired me-2"></i>Network Performance Metrics
                                        </button>
                                    </h2>
                                    <div id="networkMetrics" class="accordion-collapse collapse show" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr><th>Metric</th><th>Average</th><th>Status</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Ping Latency (ms)</td>
                                                            <td id="metrics-avg-latency">--</td>
                                                            <td id="metrics-latency-status">
                                                                <span class="badge bg-secondary">Loading...</span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>DNS Resolution (ms)</td>
                                                            {% set avg_dns = test_results | map(attribute='dns_resolution_time') | select('number') | list %}
                                                            <td>{{ "%.2f"|format(avg_dns | average) if avg_dns else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_dns and (avg_dns | average) < 50 %}
                                                                    <span class="badge bg-success">Excellent</span>
                                                                {% elif avg_dns %}
                                                                    <span class="badge bg-warning">Good</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Bandwidth Download (Mbps)</td>
                                                            {% set avg_down = test_results | map(attribute='bandwidth_download') | select('number') | list %}
                                                            <td>{{ "%.2f"|format(avg_down | average) if avg_down else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_down and (avg_down | average) > 50 %}
                                                                    <span class="badge bg-success">Excellent</span>
                                                                {% elif avg_down and (avg_down | average) > 10 %}
                                                                    <span class="badge bg-warning">Good</span>
                                                                {% elif avg_down %}
                                                                    <span class="badge bg-danger">Poor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>MTU Size</td>
                                                            {% set avg_mtu = test_results | map(attribute='mtu_size') | select('number') | list %}
                                                            <td>{{ avg_mtu | average | round(0) | int if avg_mtu else 'N/A' }} bytes</td>
                                                            <td><span class="badge bg-info">Info</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td>TCP Retransmission Rate (%)</td>
                                                            {% set avg_retrans = test_results | map(attribute='tcp_retransmission_rate') | select('number') | list %}
                                                            <td>{{ "%.3f"|format(avg_retrans | average) if avg_retrans else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_retrans and (avg_retrans | average) < 1 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_retrans %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- System Resources -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#systemMetrics">
                                            <i class="fas fa-server me-2"></i>System Resource Metrics
                                        </button>
                                    </h2>
                                    <div id="systemMetrics" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr><th>Metric</th><th>Average</th><th>Status</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>CPU Usage (%)</td>
                                                            {% set avg_cpu = test_results | map(attribute='cpu_percent') | select('number') | list %}
                                                            <td>{{ "%.1f"|format(avg_cpu | average) if avg_cpu else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_cpu and (avg_cpu | average) < 70 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_cpu and (avg_cpu | average) < 90 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_cpu %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Memory Usage (%)</td>
                                                            {% set avg_memory = test_results | map(attribute='memory_percent') | select('number') | list %}
                                                            <td>{{ "%.1f"|format(avg_memory | average) if avg_memory else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_memory and (avg_memory | average) < 80 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif avg_memory and (avg_memory | average) < 95 %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% elif avg_memory %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>CPU Load (1min)</td>
                                                            {% set avg_load = test_results | map(attribute='cpu_load_1min') | select('number') | list %}
                                                            <td>{{ "%.2f"|format(avg_load | average) if avg_load else 'N/A' }}</td>
                                                            <td>
                                                                {% if avg_load and (avg_load | average) < 1 %}
                                                                    <span class="badge bg-success">Low</span>
                                                                {% elif avg_load and (avg_load | average) < 2 %}
                                                                    <span class="badge bg-warning">Moderate</span>
                                                                {% elif avg_load %}
                                                                    <span class="badge bg-danger">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Process Count</td>
                                                            {% set proc_count = test_results | map(attribute='process_count') | select('number') | list %}
                                                            <td>{{ proc_count | average | round(0) | int if proc_count else 'N/A' }}</td>
                                                            <td><span class="badge bg-info">Info</span></td>
                                                        </tr>
                                                        <tr>
                                                            <td colspan="3">
                                                                <div class="mt-3">
                                                                    <strong>Top Processes by CPU Usage:</strong>
                                                                    {% set latest_cpu_data = test_results | selectattr('top_processes_cpu') | first %}
                                                                    {% if latest_cpu_data and latest_cpu_data.top_processes_cpu %}
                                                                        {% set cpu_processes = latest_cpu_data.top_processes_cpu | from_json %}
                                                                        <div class="row mt-2">
                                                                            {% for process in cpu_processes[:5] %}
                                                                                <div class="col-md-6 mb-2">
                                                                                    <div class="card card-body py-2">
                                                                                        <div class="d-flex justify-content-between align-items-center">
                                                                                            <div>
                                                                                                <strong>{{ process.name }}</strong>
                                                                                                <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                                                            </div>
                                                                                            <div class="text-end">
                                                                                                <span class="badge bg-primary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                                                                <span class="badge bg-secondary">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    {% else %}
                                                                        <div class="text-muted">No process data available</div>
                                                                    {% endif %}
                                                                </div>
                                                                
                                                                <div class="mt-3">
                                                                    <strong>Top Processes by Memory Usage:</strong>
                                                                    {% set latest_mem_data = test_results | selectattr('top_processes_memory') | first %}
                                                                    {% if latest_mem_data and latest_mem_data.top_processes_memory %}
                                                                        {% set mem_processes = latest_mem_data.top_processes_memory | from_json %}
                                                                        <div class="row mt-2">
                                                                            {% for process in mem_processes[:5] %}
                                                                                <div class="col-md-6 mb-2">
                                                                                    <div class="card card-body py-2">
                                                                                        <div class="d-flex justify-content-between align-items-center">
                                                                                            <div>
                                                                                                <strong>{{ process.name }}</strong>
                                                                                                <small class="text-muted d-block">PID: {{ process.pid }}</small>
                                                                                            </div>
                                                                                            <div class="text-end">
                                                                                                <span class="badge bg-secondary">{{ "%.1f"|format(process.memory_percent) }}% RAM</span>
                                                                                                <span class="badge bg-primary">{{ "%.1f"|format(process.cpu_percent) }}% CPU</span>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    {% else %}
                                                                        <div class="text-muted">No process data available</div>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Application & Infrastructure -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#appMetrics">
                                            <i class="fas fa-globe me-2"></i>Application & Infrastructure Metrics
                                        </button>
                                    </h2>
                                    <div id="appMetrics" class="accordion-collapse collapse" data-bs-parent="#metricsAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr><th>Metric</th><th>Value</th><th>Status</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Content Download Time (ms)</td>
                                                            {% set content_time = test_results | map(attribute='content_download_time') | select('number') | list %}
                                                            <td>{{ "%.2f"|format(content_time | average) if content_time else 'N/A' }}</td>
                                                            <td>
                                                                {% if content_time and (content_time | average) < 1000 %}
                                                                    <span class="badge bg-success">Fast</span>
                                                                {% elif content_time %}
                                                                    <span class="badge bg-warning">Slow</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Compression Ratio (%)</td>
                                                            {% set compress_ratio = test_results | map(attribute='compression_ratio') | select('number') | list %}
                                                            <td>{{ "%.1f"|format(compress_ratio | average) if compress_ratio else 'N/A' }}</td>
                                                            <td>
                                                                {% if compress_ratio and (compress_ratio | average) > 30 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif compress_ratio %}
                                                                    <span class="badge bg-warning">Low</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Power Consumption (W)</td>
                                                            {% set power_watts = test_results | map(attribute='power_consumption_watts') | select('number') | list %}
                                                            <td>{{ "%.1f"|format(power_watts | average) if power_watts else 'N/A' }}</td>
                                                            <td>
                                                                {% if power_watts and (power_watts | average) < 150 %}
                                                                    <span class="badge bg-success">Normal</span>
                                                                {% elif power_watts %}
                                                                    <span class="badge bg-warning">High</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Memory Error Rate (/hr)</td>
                                                            {% set mem_errors = test_results | map(attribute='memory_error_rate') | select('number') | list %}
                                                            <td>{{ "%.3f"|format(mem_errors | average) if mem_errors else 'N/A' }}</td>
                                                            <td>
                                                                {% if mem_errors and (mem_errors | average) < 0.1 %}
                                                                    <span class="badge bg-success">Good</span>
                                                                {% elif mem_errors %}
                                                                    <span class="badge bg-warning">Monitor</span>
                                                                {% else %}
                                                                    <span class="badge bg-secondary">N/A</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
let testData = {};
let networkChart, cpuChart, memoryChart, diskChart;
let currentMetric = 'ping_latency';

document.addEventListener('DOMContentLoaded', function() {
    loadTestData();
});

async function loadTestData() {
    try {
        console.log('Loading test data from: /api/test/{{ test.id }}/data');
        const response = await fetch(`/api/test/{{ test.id }}/data`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        testData = await response.json();
        console.log('Test data loaded successfully:', testData);
        
        // Check if we have valid data
        if (!testData || !testData.clients || Object.keys(testData.clients).length === 0) {
            console.log('No client data available');
            document.getElementById('avg-latency').textContent = '--';
            document.getElementById('avg-packet-loss').textContent = '--';
            document.getElementById('data-points').textContent = '0';
            return;
        }
        
        try {
            // Initialize charts and update stats
            initializeCharts();
            updateSummaryStats();
            updateClientSummary();
            console.log('All components initialized successfully');
        } catch (error) {
            console.error('Error during component initialization:', error);
        }
        
    } catch (error) {
        console.error('Error loading test data:', error);
        document.getElementById('avg-latency').textContent = '--';
        document.getElementById('avg-packet-loss').textContent = '--';
        document.getElementById('data-points').textContent = '0';
    }
}

function initializeCharts() {
    console.log('Initializing charts with data:', testData);
    
    if (!testData || !testData.clients || !testData.metrics) {
        console.error('Cannot initialize charts: missing data structure');
        return;
    }
    
    // Network Chart
    const networkCtx = document.getElementById('networkChart').getContext('2d');
    
    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1'];
    const datasets = Object.keys(testData.clients).map((clientId, index) => {
        const color = colors[index % colors.length];
        const metricData = testData.metrics[currentMetric] && testData.metrics[currentMetric][clientId] 
            ? testData.metrics[currentMetric][clientId] 
            : [];
        
        const validPoints = metricData.filter(p => p && p.y !== null && p.y !== undefined && !isNaN(p.y));
        console.log(`Client ${clientId} (${testData.clients[clientId]}) ${currentMetric}: ${validPoints.length}/${metricData.length} valid points`);
        
        const processedData = metricData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: color,
            backgroundColor: color + '20',
            fill: false,
            tension: 0.1
        };
    });

    networkChart = new Chart(networkCtx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                title: {
                    display: true,
                    text: getMetricTitle(currentMetric)
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        afterBody: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const clientId = Object.keys(testData.clients)[context[0].datasetIndex];
                            const clientName = testData.clients[clientId];
                            
                            // Add detailed information for troubleshooting
                            let details = [`Client: ${clientName} (ID: ${clientId})`];
                            
                            // Add traceroute data if available for this data point
                            if (testData.metrics.traceroute_data && testData.metrics.traceroute_data[clientId] && 
                                testData.metrics.traceroute_data[clientId][dataIndex]) {
                                const tracerouteData = testData.metrics.traceroute_data[clientId][dataIndex];
                                if (tracerouteData.y) {
                                    try {
                                        const traceData = JSON.parse(tracerouteData.y);
                                        if (traceData && traceData.hops) {
                                            details.push('Traceroute hops:');
                                            traceData.hops.slice(0, 5).forEach((hop, i) => {
                                                details.push(`  ${i+1}. ${hop.ip || hop.host || 'Unknown'} (${hop.rtt || 'N/A'}ms)`);
                                            });
                                            if (traceData.hops.length > 5) {
                                                details.push(`  ... and ${traceData.hops.length - 5} more hops`);
                                            }
                                        }
                                    } catch (e) {
                                        // Ignore JSON parsing errors
                                    }
                                }
                            }
                            
                            return details;
                        }
                    }
                }
            },
            onClick: function(event, elements) {
                if (elements.length > 0) {
                    const dataIndex = elements[0].index;
                    const datasetIndex = elements[0].datasetIndex;
                    const clientId = Object.keys(testData.clients)[datasetIndex];
                    showDataPointDetails(clientId, dataIndex);
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: {
                            minute: 'HH:mm',
                            hour: 'HH:mm'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: getMetricUnit(currentMetric)
                    },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value, index, values) {
                            if (currentMetric === 'bandwidth_upload' || currentMetric === 'bandwidth_download') {
                                return value.toFixed(1) + ' Mbps';
                            }
                            return value;
                        }
                    }
                }
            }
        }
    });

    // System Resource Charts
    initializeResourceCharts();
}

function initializeResourceCharts() {
    if (!testData || !testData.clients || !testData.metrics) {
        console.log('No data available for resource chart initialization');
        return;
    }
    
    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1'];
    
    // CPU Chart
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    const cpuDatasets = Object.keys(testData.clients).map((clientId, index) => {
        const rawData = (testData.metrics.cpu && testData.metrics.cpu[clientId]) || [];
        const processedData = rawData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            fill: false,
            tension: 0.1
        };
    });

    cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: { datasets: cpuDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: 'CPU %' },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Memory Chart
    const memoryCtx = document.getElementById('memoryChart').getContext('2d');
    const memoryDatasets = Object.keys(testData.clients).map((clientId, index) => {
        const rawData = (testData.metrics.memory && testData.metrics.memory[clientId]) || [];
        const processedData = rawData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            fill: false,
            tension: 0.1
        };
    });

    memoryChart = new Chart(memoryCtx, {
        type: 'line',
        data: { datasets: memoryDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: 'Memory %' },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Disk Chart
    const diskCtx = document.getElementById('diskChart').getContext('2d');
    const diskDatasets = Object.keys(testData.clients).map((clientId, index) => {
        const rawData = (testData.metrics.disk && testData.metrics.disk[clientId]) || [];
        const processedData = rawData.filter(point => point && point.x && point.y !== null).map(point => ({
            x: new Date(point.x),
            y: point.y
        }));
        
        return {
            label: testData.clients[clientId],
            data: processedData,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            fill: false,
            tension: 0.1
        };
    });

    diskChart = new Chart(diskCtx, {
        type: 'line',
        data: { datasets: diskDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: { minute: 'HH:mm' }
                    }
                },
                y: {
                    title: { display: true, text: 'Disk %' },
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function showMetric(metric) {
    currentMetric = metric;
    
    // Update dropdown label and chart title
    document.getElementById('current-metric-label').textContent = getMetricTitle(metric).replace(' Over Time', '');
    document.getElementById('chart-title').innerHTML = '<i class="fas fa-chart-line me-2"></i>' + getMetricTitle(metric);
    
    // Only update chart if it exists and testData is available
    if (networkChart && testData && testData.clients && testData.metrics) {
        const datasets = Object.keys(testData.clients).map((clientId, index) => {
            const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1'];
            const color = colors[index % colors.length];
            
            // Get raw data and filter out null/undefined values
            let rawData = testData.metrics[metric] && testData.metrics[metric][clientId] ? testData.metrics[metric][clientId] : [];
            
            // For bandwidth metrics, filter out null/zero values and ensure proper data structure
            let filteredData = rawData;
            if (metric === 'bandwidth_upload' || metric === 'bandwidth_download') {
                filteredData = rawData.filter(point => {
                    return point && 
                           point.x && 
                           point.y !== null && 
                           point.y !== undefined && 
                           point.y > 0; // Only show actual bandwidth measurements
                }).map(point => ({
                    x: new Date(point.x),
                    y: parseFloat(point.y)
                }));
            } else {
                // Standard filtering for other metrics
                filteredData = rawData.filter(point => {
                    return point && point.x && point.y !== null && point.y !== undefined;
                }).map(point => ({
                    x: new Date(point.x),
                    y: parseFloat(point.y)
                }));
            }
            
            return {
                label: testData.clients[clientId],
                data: filteredData,
                borderColor: color,
                backgroundColor: color + '20',
                fill: false,
                tension: 0.1,
                spanGaps: false, // Don't connect gaps in bandwidth data
                pointRadius: metric === 'bandwidth_upload' || metric === 'bandwidth_download' ? 4 : 3,
                pointHoverRadius: metric === 'bandwidth_upload' || metric === 'bandwidth_download' ? 6 : 4
            };
        });
        
        networkChart.data.datasets = datasets;
    networkChart.options.plugins.title.text = getMetricTitle(metric);
    networkChart.options.scales.y.title.text = getMetricUnit(metric);
        networkChart.update();
    }
}

function getMetricTitle(metric) {
    const titles = {
        'ping_latency': 'Network Latency Over Time',
        'ping_packet_loss': 'Packet Loss Over Time',
        'jitter': 'Network Jitter Over Time',
        'dns_resolution_time': 'DNS Resolution Time Over Time',
        'tcp_connect_time': 'TCP Connection Time Over Time',
        'ssl_handshake_time': 'SSL Handshake Time Over Time',
        'ttfb': 'Time to First Byte Over Time',
        'cpu_load_1min': 'CPU Load Average (1 minute) Over Time',
        'cpu_load_5min': 'CPU Load Average (5 minutes) Over Time',
        'cpu_load_15min': 'CPU Load Average (15 minutes) Over Time',
        'cpu_freq_current': 'CPU Frequency Over Time',
        'network_bytes_sent': 'Network Bytes Sent Over Time',
        'network_bytes_recv': 'Network Bytes Received Over Time',
        'network_errors_in': 'Network Errors (Incoming) Over Time',
        'network_errors_out': 'Network Errors (Outgoing) Over Time',
        'network_packets_sent': 'Network Packets Sent Over Time',
        'network_packets_recv': 'Network Packets Received Over Time',
        'network_drops_in': 'Network Drops (Incoming) Over Time',
        'network_drops_out': 'Network Drops (Outgoing) Over Time',
        'cpu_cores': 'CPU Core Count Over Time',
        'cpu_temperature': 'CPU Temperature Over Time',
        'process_count': 'Process Count Over Time',
        'tcp_connections': 'TCP Connections Over Time',
        'traceroute_hops': 'Network Path Length Over Time (Hops)',
        'memory_available': 'Memory Available Over Time (GB)',
        'memory_cached': 'Memory Cached Over Time (GB)',
        'memory_buffers': 'Memory Buffers Over Time (GB)',
        'swap_used': 'Swap Used Over Time (GB)',
        'swap_percent': 'Swap Usage Over Time (%)',
        'disk_read_iops': 'Disk Read IOPS Over Time',
        'bandwidth_upload': 'Bandwidth Upload Over Time',
        'bandwidth_download': 'Bandwidth Download Over Time',
        'disk_write_iops': 'Disk Write IOPS Over Time',
        'disk_read_bytes_sec': 'Disk Read Throughput Over Time',
        'disk_write_bytes_sec': 'Disk Write Throughput Over Time',
        'dscp_value': 'DSCP Values Over Time',
        'cos_value': 'CoS Values Over Time',
        'qos_policy_compliant': 'QoS Policy Compliance Over Time'
    };
    return titles[metric] || metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function getMetricUnit(metric) {
    const units = {
        'ping_latency': 'Latency (ms)',
        'ping_packet_loss': 'Packet Loss (%)',
        'jitter': 'Jitter (ms)',
        'dns_resolution_time': 'DNS Time (ms)',
        'tcp_connect_time': 'Connect Time (ms)',
        'ssl_handshake_time': 'SSL Time (ms)',
        'ttfb': 'TTFB (ms)',
        'cpu_load_1min': 'Load Average',
        'cpu_load_5min': 'Load Average',
        'cpu_load_15min': 'Load Average',
        'cpu_freq_current': 'Frequency (MHz)',
        'network_bytes_sent': 'Bytes',
        'network_bytes_recv': 'Bytes',
        'network_errors_in': 'Error Count',
        'network_errors_out': 'Error Count',
        'network_packets_sent': 'Packets',
        'network_packets_recv': 'Packets',
        'network_drops_in': 'Drop Count',
        'network_drops_out': 'Drop Count',
        'cpu_cores': 'Core Count',
        'cpu_temperature': 'C',
        'process_count': 'Processes',
        'tcp_connections': 'Connections',
        'memory_available': 'Bytes',
        'memory_cached': 'Bytes',
        'memory_buffers': 'Bytes',
        'swap_percent': 'Percent (%)',
        'traceroute_hops': 'Hops',
        'disk_read_iops': 'Operations/sec',
        'disk_write_iops': 'Operations/sec',
        'disk_read_bytes_sec': 'Bytes/sec',
        'disk_write_bytes_sec': 'Bytes/sec',
        'dscp_value': 'DSCP Code',
        'cos_value': 'CoS Value',
        'qos_policy_compliant': 'Compliance (0/1)',
        'bandwidth_upload': 'Upload Speed (Mbps)',
        'bandwidth_download': 'Download Speed (Mbps)'
    };
    return units[metric] || 'Value';
}

function updateSummaryStats() {
    console.log('Updating summary stats with data:', testData);
    
    if (!testData || !testData.clients || !testData.metrics) {
        console.log('Missing data structure for summary stats');
        document.getElementById('avg-latency').textContent = '--';
        document.getElementById('avg-packet-loss').textContent = '--';
        document.getElementById('data-points').textContent = '0';
        return;
    }
    
    // Calculate average latency and packet loss
    let totalLatency = 0;
    let totalPacketLoss = 0;
    let latencyCount = 0;
    let packetLossCount = 0;
    let totalCpu = 0;
    let cpuCount = 0;
    let totalDataPoints = 0;
    
    Object.keys(testData.clients).forEach(clientId => {
        const latencyData = (testData.metrics.ping_latency && testData.metrics.ping_latency[clientId]) || [];
        const packetLossData = (testData.metrics.ping_packet_loss && testData.metrics.ping_packet_loss[clientId]) || [];
        const cpuData = (testData.metrics.cpu && testData.metrics.cpu[clientId]) || [];
        
        // Count total data points from any metric
        totalDataPoints += Math.max(latencyData.length, cpuData.length, packetLossData.length);
        
        latencyData.forEach(point => {
            if (point && point.y !== null && point.y !== undefined && !isNaN(point.y)) {
                totalLatency += point.y;
                latencyCount++;
            }
        });
        
        packetLossData.forEach(point => {
            if (point && point.y !== null && point.y !== undefined && !isNaN(point.y)) {
                totalPacketLoss += point.y;
                packetLossCount++;
            }
        });
        
        cpuData.forEach(point => {
            if (point && point.y !== null && point.y !== undefined && !isNaN(point.y)) {
                totalCpu += point.y;
                cpuCount++;
            }
        });
    });
    
    // Update displays with actual data or appropriate messages
    const avgLatency = latencyCount > 0 ? (totalLatency / latencyCount).toFixed(1) : '--';
    const avgPacketLoss = packetLossCount > 0 ? (totalPacketLoss / packetLossCount).toFixed(1) : '--';
    const avgCpu = cpuCount > 0 ? (totalCpu / cpuCount).toFixed(1) : '--';
    
    // Update summary cards
    document.getElementById('data-points').textContent = totalDataPoints;
    document.getElementById('avg-latency').textContent = avgLatency + (avgLatency !== '--' ? ' ms' : '');
    document.getElementById('avg-packet-loss').textContent = avgPacketLoss + (avgPacketLoss !== '--' ? '%' : '');
    
    console.log(`Stats calculated: ${latencyCount} latency points, ${cpuCount} CPU points, ${packetLossCount} packet loss points, ${totalDataPoints} total data points`);
}

function updateClientSummary() {
    if (!testData || !testData.clients || !testData.metrics) {
        return;
    }
    
    Object.keys(testData.clients).forEach(clientId => {
        const latencyData = (testData.metrics.ping_latency && testData.metrics.ping_latency[clientId]) || [];
        const packetLossData = (testData.metrics.ping_packet_loss && testData.metrics.ping_packet_loss[clientId]) || [];
        const cpuData = (testData.metrics.cpu && testData.metrics.cpu[clientId]) || [];
        const memoryData = (testData.metrics.memory && testData.metrics.memory[clientId]) || [];
        const diskData = (testData.metrics.disk && testData.metrics.disk[clientId]) || [];
        
        // Calculate averages
        const avgLatency = calculateAverage(latencyData);
        const avgPacketLoss = calculateAverage(packetLossData);
        const avgCpu = calculateAverage(cpuData);
        const avgMemory = calculateAverage(memoryData);
        const avgDisk = calculateAverage(diskData);
        
        // Update table cells
        const dataPointsCell = document.querySelector(`[data-client="${clientId}"].client-data-points`);
        const latencyCell = document.querySelector(`[data-client="${clientId}"].client-avg-latency`);
        const packetLossCell = document.querySelector(`[data-client="${clientId}"].client-avg-packet-loss`);
        const cpuCell = document.querySelector(`[data-client="${clientId}"].client-avg-cpu`);
        const memoryCell = document.querySelector(`[data-client="${clientId}"].client-avg-memory`);
        const diskCell = document.querySelector(`[data-client="${clientId}"].client-avg-disk`);
        
        if (dataPointsCell) dataPointsCell.textContent = latencyData.length;
        if (latencyCell) latencyCell.textContent = avgLatency !== null ? avgLatency.toFixed(1) + ' ms' : '--';
        if (packetLossCell) packetLossCell.textContent = avgPacketLoss !== null ? avgPacketLoss.toFixed(1) + '%' : '--';
        if (cpuCell) cpuCell.textContent = avgCpu !== null ? avgCpu.toFixed(1) + '%' : '--';
        if (memoryCell) memoryCell.textContent = avgMemory !== null ? avgMemory.toFixed(1) + '%' : '--';
        if (diskCell) diskCell.textContent = avgDisk !== null ? avgDisk.toFixed(1) + '%' : '--';
    });
}

function calculateAverage(dataPoints) {
    const validPoints = dataPoints.filter(point => point.y !== null && point.y !== undefined);
    if (validPoints.length === 0) return null;
    
    const sum = validPoints.reduce((acc, point) => acc + point.y, 0);
    return sum / validPoints.length;
}

// Auto-refresh data every 30 seconds for running tests
{% if test.status == 'running' %}
setInterval(loadTestData, 30000);
{% endif %}

function exportPDF(testId) {
    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generating PDF...';
    btn.disabled = true;
    
    // Create a temporary link to download the PDF
    const link = document.createElement('a');
    link.href = `/api/test/${testId}/export/pdf`;
    link.download = '';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Restore button after a delay
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        showToast('PDF report download started', 'success');
    }, 2000);
}

function showDataPointDetails(clientId, dataIndex) {
    const clientName = testData.clients[clientId];
    const timestamp = testData.metrics[currentMetric] && testData.metrics[currentMetric][clientId] && 
                     testData.metrics[currentMetric][clientId][dataIndex] ? 
                     testData.metrics[currentMetric][clientId][dataIndex].x : 'Unknown';
    
    let modalContent = `
        <div class="modal fade" id="dataPointModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-search me-2"></i>
                            Data Point Details - ${clientName}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Client:</strong> ${clientName} (ID: ${clientId})
                            </div>
                            <div class="col-md-4">
                                <strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}
                            </div>
                            <div class="col-md-4" id="currentHopInfo">
                                <strong>Current Network Hop:</strong> <span id="hopNumber">Analyzing...</span>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6>Metrics at this time point:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Metric</th>
                                                <th>Value</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="metricsTable">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row" id="tracerouteSection" style="display: none;">
                            <div class="col-12">
                                <h6>Network Path Analysis:</h6>
                                <div class="alert alert-info mb-3" id="hopAnalysis" style="display: none;">
                                    <i class="fas fa-route me-2"></i>
                                    <span id="hopAnalysisText"></span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Hop</th>
                                                <th>IP/Host</th>
                                                <th>RTT (ms)</th>
                                                <th>Status</th>
                                                <th>Analysis</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tracerouteTable">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="exportDataPoint('${clientId}', ${dataIndex})">
                            <i class="fas fa-download me-1"></i>Export Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('dataPointModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Populate metrics table
    const metricsTable = document.getElementById('metricsTable');
    const metricNames = [
        'ping_latency', 'ping_packet_loss', 'jitter', 'dns_resolution_time', 'tcp_connect_time',
        'ssl_handshake_time', 'ttfb', 'cpu', 'memory', 'disk', 'network_bytes_sent', 'network_bytes_recv'
    ];
    
    metricNames.forEach(metric => {
        if (testData.metrics[metric] && testData.metrics[metric][clientId] && 
            testData.metrics[metric][clientId][dataIndex]) {
            const value = testData.metrics[metric][clientId][dataIndex].y;
            if (value !== null && value !== undefined) {
                const row = document.createElement('tr');
                const status = getMetricStatus(metric, value);
                row.innerHTML = `
                    <td>${getMetricDisplayName(metric)}</td>
                    <td>${formatMetricValue(metric, value)}</td>
                    <td><span class="badge bg-${status.color}">${status.text}</span></td>
                `;
                metricsTable.appendChild(row);
            }
        }
    });
    

    
    // Populate traceroute table and analyze network hops if available
    if (testData.metrics.traceroute_data && testData.metrics.traceroute_data[clientId] && 
        testData.metrics.traceroute_data[clientId][dataIndex]) {
        const tracerouteData = testData.metrics.traceroute_data[clientId][dataIndex];
        if (tracerouteData.y) {
            try {
                // Parse the traceroute data - it's stored as an array of strings
                const rawTraceData = JSON.parse(tracerouteData.y);
                
                // Convert the array of strings to hop objects
                const hops = [];
                if (Array.isArray(rawTraceData)) {
                    rawTraceData.forEach((hopLine, index) => {
                        const hop = parseTracerouteHop(hopLine, index);
                        if (hop) {
                            hops.push(hop);
                        }
                    });
                }
                
                if (hops.length > 0) {
                    document.getElementById('tracerouteSection').style.display = 'block';
                    const tracerouteTable = document.getElementById('tracerouteTable');
                    
                    // Analyze current performance metrics to identify problem hop
                    const currentLatency = testData.metrics.ping_latency && testData.metrics.ping_latency[clientId] && 
                                         testData.metrics.ping_latency[clientId][dataIndex] ? 
                                         testData.metrics.ping_latency[clientId][dataIndex].y : null;
                    
                    const currentJitter = testData.metrics.jitter && testData.metrics.jitter[clientId] && 
                                        testData.metrics.jitter[clientId][dataIndex] ? 
                                        testData.metrics.jitter[clientId][dataIndex].y : null;
                    
                    let problemHop = analyzeProblemHop(hops, currentLatency, currentJitter);
                    
                    // Update current hop info
                    const hopNumberElement = document.getElementById('hopNumber');
                    if (problemHop.hopIndex !== -1) {
                        hopNumberElement.innerHTML = `<span class="badge bg-${problemHop.severity}">${problemHop.hopIndex + 1}</span> ${problemHop.description}`;
                        
                        // Show analysis alert
                        document.getElementById('hopAnalysis').style.display = 'block';
                        document.getElementById('hopAnalysisText').textContent = problemHop.analysis;
                    } else {
                        hopNumberElement.textContent = 'All hops performing normally';
                    }
                    
                    hops.forEach((hop, index) => {
                        const row = document.createElement('tr');
                        const rtt = hop.rtt || 'Timeout';
                        const status = hop.rtt ? (hop.rtt > 100 ? 'warning' : 'success') : 'danger';
                        const statusText = hop.rtt ? (hop.rtt > 100 ? 'Slow' : 'Good') : 'Timeout';
                        
                        // Add special highlighting for problem hop
                        const isProbleHop = index === problemHop.hopIndex;
                        const rowClass = isProbleHop ? 'table-warning' : '';
                        
                        // Analyze this specific hop
                        let hopAnalysis = analyzeIndividualHop(hop, index, hops);
                        
                        row.className = rowClass;
                        row.innerHTML = `
                            <td>${hop.hopNumber}${isProbleHop ? ' <i class="fas fa-exclamation-triangle text-warning"></i>' : ''}</td>
                            <td>${hop.host || hop.ip || 'Unknown'}</td>
                            <td>${rtt}</td>
                            <td><span class="badge bg-${status}">${statusText}</span></td>
                            <td><small class="text-muted">${hopAnalysis}</small></td>
                        `;
                        tracerouteTable.appendChild(row);
                    });
                }
            } catch (e) {
                console.error('Error parsing traceroute data:', e);
            }
        }
    } else {
        // No traceroute data available, but still show basic hop analysis
        document.getElementById('hopNumber').textContent = 'Traceroute data not available';
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('dataPointModal'));
    modal.show();
}

function getMetricDisplayName(metric) {
    const names = {
        'ping_latency': 'Network Latency',
        'ping_packet_loss': 'Packet Loss',
        'jitter': 'Network Jitter',
        'dns_resolution_time': 'DNS Resolution',
        'tcp_connect_time': 'TCP Connect',
        'ssl_handshake_time': 'SSL Handshake',
        'ttfb': 'Time to First Byte',
        'cpu': 'CPU Usage',
        'memory': 'Memory Usage',
        'disk': 'Disk Usage',
        'network_bytes_sent': 'Bytes Sent',
        'network_bytes_recv': 'Bytes Received'
    };
    return names[metric] || metric;
}

function formatMetricValue(metric, value) {
    if (metric.includes('latency') || metric.includes('time') || metric === 'jitter' || metric === 'ttfb') {
        return `${value.toFixed(2)} ms`;
    } else if (metric.includes('packet_loss') || metric === 'cpu' || metric === 'memory' || metric === 'disk') {
        return `${value.toFixed(1)}%`;
    } else if (metric.includes('bytes')) {
        return formatBytes(value);
    }
    return value.toString();
}

function getMetricStatus(metric, value) {
    if (metric === 'ping_latency' || metric === 'jitter') {
        if (value < 50) return { color: 'success', text: 'Excellent' };
        if (value < 150) return { color: 'warning', text: 'Good' };
        return { color: 'danger', text: 'Poor' };
    } else if (metric === 'ping_packet_loss') {
        if (value === 0) return { color: 'success', text: 'Excellent' };
        if (value < 1) return { color: 'warning', text: 'Acceptable' };
        return { color: 'danger', text: 'Poor' };
    } else if (metric === 'cpu' || metric === 'memory' || metric === 'disk') {
        if (value < 70) return { color: 'success', text: 'Normal' };
        if (value < 90) return { color: 'warning', text: 'High' };
        return { color: 'danger', text: 'Critical' };
    } else if (metric.includes('time') || metric === 'ttfb') {
        if (value < 100) return { color: 'success', text: 'Fast' };
        if (value < 500) return { color: 'warning', text: 'Moderate' };
        return { color: 'danger', text: 'Slow' };
    }
    return { color: 'secondary', text: 'Info' };
}

function parseTracerouteHop(hopLine, index) {
    // Parse traceroute hop line like: "1  _gateway (172.16.10.253)  3.744 ms  3.836 ms  3.804 ms"
    if (!hopLine || hopLine.trim() === '' || hopLine.includes('* * *')) {
        return { hopNumber: index + 1, ip: null, host: null, rtt: null };
    }
    
    try {
        // Extract IP address - look for patterns like (192.168.1.1)
        const ipMatch = hopLine.match(/\(([^)]+)\)/);
        const ip = ipMatch ? ipMatch[1] : null;
        
        // Extract hostname - text before the IP address
        let host = null;
        if (ipMatch) {
            const beforeIp = hopLine.split('(')[0].trim();
            const parts = beforeIp.split(/\s+/);
            if (parts.length > 1) {
                host = parts[parts.length - 1];
            }
        }
        
        // Extract RTT - look for the first "X.XXX ms" pattern
        const rttMatch = hopLine.match(/(\d+\.?\d*)\s*ms/);
        const rtt = rttMatch ? parseFloat(rttMatch[1]) : null;
        
        return {
            hopNumber: index + 1,
            ip: ip,
            host: host || ip || 'Unknown',
            rtt: rtt
        };
    } catch (e) {
        return { hopNumber: index + 1, ip: null, host: 'Parse Error', rtt: null };
    }
}

function analyzeProblemHop(hops, currentLatency, currentJitter) {
    let result = { hopIndex: -1, severity: 'success', description: 'All hops normal', analysis: '' };
    
    if (!hops || hops.length === 0) return result;
    
    // Look for significant RTT increases between consecutive hops
    let maxRttIncrease = 0;
    let problemHopIndex = -1;
    let previousRtt = 0;
    
    hops.forEach((hop, index) => {
        if (hop.rtt && hop.rtt > 0) {
            if (index > 0 && previousRtt > 0) {
                const increase = hop.rtt - previousRtt;
                if (increase > maxRttIncrease && increase > 50) { // Significant increase threshold
                    maxRttIncrease = increase;
                    problemHopIndex = index;
                }
            }
            previousRtt = hop.rtt;
        }
    });
    
    // Check for timeouts or very high latency
    hops.forEach((hop, index) => {
        if (!hop.rtt || hop.rtt > 500) {
            if (problemHopIndex === -1 || maxRttIncrease < 200) {
                problemHopIndex = index;
                maxRttIncrease = hop.rtt || 1000;
            }
        }
    });
    
    if (problemHopIndex !== -1) {
        const problemHop = hops[problemHopIndex];
        result.hopIndex = problemHopIndex;
        
        if (!problemHop.rtt) {
            result.severity = 'danger';
            result.description = `${problemHop.ip || problemHop.host || 'Unknown'} (Timeout)`;
            result.analysis = `Hop ${problemHopIndex + 1} is experiencing timeouts, which may indicate packet loss or filtering.`;
        } else if (problemHop.rtt > 500) {
            result.severity = 'danger';
            result.description = `${problemHop.ip || problemHop.host || 'Unknown'} (${problemHop.rtt}ms)`;
            result.analysis = `Hop ${problemHopIndex + 1} has very high latency (${problemHop.rtt}ms), indicating a bottleneck.`;
        } else if (maxRttIncrease > 100) {
            result.severity = 'warning';
            result.description = `${problemHop.ip || problemHop.host || 'Unknown'} (+${maxRttIncrease.toFixed(1)}ms)`;
            result.analysis = `Hop ${problemHopIndex + 1} shows a significant latency increase of ${maxRttIncrease.toFixed(1)}ms from the previous hop.`;
        }
    }
    
    return result;
}

function analyzeIndividualHop(hop, index, allHops) {
    if (!hop.rtt) return 'Timeout or filtered';
    
    if (hop.rtt > 500) return 'Very high latency';
    if (hop.rtt > 200) return 'High latency';
    
    // Check if this hop has a significant increase from previous
    if (index > 0 && allHops[index - 1] && allHops[index - 1].rtt) {
        const increase = hop.rtt - allHops[index - 1].rtt;
        if (increase > 100) return `+${increase.toFixed(1)}ms increase`;
        if (increase > 50) return `+${increase.toFixed(1)}ms rise`;
    }
    
    // Classify by RTT range
    if (hop.rtt < 10) return 'Excellent';
    if (hop.rtt < 50) return 'Good';
    if (hop.rtt < 100) return 'Acceptable';
    return 'Slow';
}

function exportDataPoint(clientId, dataIndex) {
    // Create detailed export data
    const clientName = testData.clients[clientId];
    const timestamp = testData.metrics[currentMetric][clientId][dataIndex].x;
    
    let exportData = {
        client: { id: clientId, name: clientName },
        timestamp: timestamp,
        metrics: {},
        networkPath: null
    };
    
    // Collect all available metrics for this data point
    Object.keys(testData.metrics).forEach(metric => {
        if (testData.metrics[metric][clientId] && testData.metrics[metric][clientId][dataIndex]) {
            exportData.metrics[metric] = testData.metrics[metric][clientId][dataIndex].y;
        }
    });
    
    // Include traceroute data if available
    if (testData.metrics.traceroute_data && testData.metrics.traceroute_data[clientId] && 
        testData.metrics.traceroute_data[clientId][dataIndex]) {
        try {
            const rawTraceData = JSON.parse(testData.metrics.traceroute_data[clientId][dataIndex].y);
            const hops = [];
            if (Array.isArray(rawTraceData)) {
                rawTraceData.forEach((hopLine, index) => {
                    const hop = parseTracerouteHop(hopLine, index);
                    if (hop) {
                        hops.push(hop);
                    }
                });
            }
            exportData.networkPath = { hops: hops, raw: rawTraceData };
        } catch (e) {
            exportData.networkPath = { error: 'Failed to parse traceroute data' };
        }
    }
    
    // Download as JSON file
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `datapoint_${clientName}_${timestamp.replace(/[:.]/g, '-')}.json`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
